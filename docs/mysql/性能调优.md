
# 数据类型优化

## 如何选择数据类型

### 最小的数据类型

在 MySQL 中支持的数据类型非常多，我们在选择存储的数据类型时，通常选择最小的数据类型为最优，因为这样他们占用更少的磁盘、内存和CPU缓存

例如：只需要存储 `0-200`我们可以选择使用 `tinyint unsigned`更好

### 最简单的数据类型

简单的数据类型的操作通常比复杂的数据类型使用更少的CPU周期；

例如：整型比字符串操作代价更低。因为字符集和校对规则（排序规则）让字符串比较比整形更复杂。

优先使用 MySQL 内建的数据类型，而非字符串。比如 `date``time``datatime`

如果是 IP 则应该转换为 `整型`后存储

### 避免使用 NULL

在 MySQL 中，对于 NULL 值会加大索引、索引统计和之比较的复杂度，更能难以进行优化。

并且使用 NULL 的列需要更多的存储空间，在 MySQL 中也需要进行特殊处理。

如果 NULL 列被索引时，每个索引记录需要一个额外的字节，

在MyISAM里甚至还可能导致固定大小的索引（例如只有一个整数列的索引）变成可变大小的索引。

通常我们可以使用 `NOT NULL` 或者 设置默认值 `DEFAULT`来解决此问题

注意：通常把 NULL 值改为 NOT NULL 带来的性能优化并没有太多，所以在新建表时注意即可，已有的没必要去做修改，除非非常确定这个列会导致慢SQL，或者此列使用了索引。

> 有些情况下，是需要此列为 NULL 时，是可以不做限制。没必要过度优化


## 选择具体的数据类型

### 整数类型

在 MySQL 中，整数类型有：

- `TINYINT`8位
- `SMALLINT`16位
- `MEDIUMINT`24位
- `INT`32位
- `BIGINT`64位

> 他们可以存储的值的范围从 `-1(N-1)`到 `2(N-1)`
>
> `N`表示存储空间的位数


存储整数类型有可选的`UNSIGEND`属性，表示不允许有负值，这样可以让正数的上线提高一倍。

> 例如：`TINYINT UNSIGNED`可以存储的范围是 `0-255`；而`TINYINT`可以存储的值是 `-128 ~ 127`


有符号和无符号类型使用的存储空间是相同的，并且有相同的性能，因此可以根据实际情况选择合适的类型。

> 举个例子：商品的价格字段，就不适合负数（也不适合整数，只是例子）


整数计算一班使用 64位的 `BIGINT`整数，即使在 32位 的环境也是如此，一些聚合函数除外，它们会使用`DECIMAL`或`DOUBLE`进行计算

MySQL 可以为整数类型指定宽度，例如 `INT(11)`，但是他不会限制值的合法范围，只是规定了 MySQL 的一些交互工具用来显示字符的个数
实际存储中`INT(1)`和 `INT(20)`是一样的

### 实数类型

实数是带`有小数部分的数字

- `FLOAT`和 `DOUBLE`类型支持标准的浮点运算进行近似运算
- `DECIMAL`类型用于存储精确的小数。(也可以用来存储比`BIGINT`更大的整数)

> 浮点和DECIMAL 都支持指定精度。
>
> 但是`DECIMAL`可以指定小数点前后允许的最大位数。
>
> 这个会影响列的空间消耗。在 MySQL5.0以上的版本中，将数字打包保存到一个二进制字符串中（每4个字节存储9个数字）。
>
> `FLOAT`占用4个字节
>
> `DOUBLE`占用8个字节，相对于`FLOAT`，拥有更大的精度和范围


由于 CPU 并不支持对 `DECIMAL`的直接计算，所以在MySQL5.0以上版本中自身实现了对`DECIMAL`的高精度计算，相对于原生浮点数来说，CPU支持直接计算，所以效率会高很多
而对于 `DECIMAL`而言，需要MySQL自身计算，需要额外的空间和计算开销，所以应该尽量只在需要对小数进行精确计算时使用`DECIMAL`。

> 存储金额时，建议将金额转换为整型，将`DECIMAL`替换为`BIGINT`，只需要将存储的货币单位根据小数的位数乘以相应的倍数即可
>
> 这样可以同时解决高精度计算问题以及`DECIMAL`计算代价高的问题


### 字符串类型

#### VARCHAR

`VARCHAR`类型用于存储可变长字符串，是最常见的一种字符串数据类型。因为它仅使用必要的空间（例如，越短的字符串使用的空间就越少），所以它比定常类型更节省空间

在 MySQL 中，也可以使用 `ROW_FORMAT=FIXED`来指定定常存储，但是这样会更浪费空间（`InnoDB`存储引擎不支持）

`VARCHAR`需要使用1-2个额外字节记录字符串的长度

如果`VARCHAR`存储的值<=255个字节，则使用一个字节表示，否则使用两个字节。

什么时候使用`VARCHAR`最合适？

- 字符串列的最大长度比平均长度大很多
- 列的更新很少，所以碎片不是问题
- 使用了像`UTF-8`这样复杂的字符集，每个字符都是用不同的字节数进行存储

#### CHAR

`CHAR`类型是定长的，当值不足所定长度时会自动填补，当存储`CHAR`值时，MySQL会自动将末尾的空格给删除；
`CHAR`更适合用于存储长度固定，或者长度相近的数据。对于经常变更的数据，也会比 `VARCHAR`更好，因为定常的`CHAR`类型不容易产生碎片。

对于非常短的列，`CHAR`比`VARCHAR`更有存储空间上的优势

> 例如：存储Y或N的值，在`CHAR`中定为`CHAR(1)`；在`VARCHAR`中定义为`VARCHAR(1)`；
>
> 但是我们上面刚刚已经提到了，在`VARCHAR`中，会额外的增加1-2个字节记录字符串长度，所以在此例子中，`VARCHAR`始终会比 `CHAR`多一个字节
