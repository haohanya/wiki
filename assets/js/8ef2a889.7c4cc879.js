"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[1944],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>k});var a=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var p=a.createContext({}),c=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},d="mdxType",s={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=c(t),h=l,k=d["".concat(p,".").concat(h)]||d[h]||s[h]||r;return t?a.createElement(k,o(o({ref:n},u),{},{components:t})):a.createElement(k,o({ref:n},u))}));function k(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,o=new Array(r);o[0]=h;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i[d]="string"==typeof e?e:l,o[1]=i;for(var c=2;c<r;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},1938:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>o,default:()=>s,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var a=t(7462),l=(t(7294),t(3905));const r={},o="Netty",i={unversionedId:"\u540e\u7aef/Netty",id:"\u540e\u7aef/Netty",title:"Netty",description:"Netty \u6838\u5fc3\u7ec4\u4ef6",source:"@site/docs/\u540e\u7aef/Netty.md",sourceDirName:"\u540e\u7aef",slug:"/\u540e\u7aef/Netty",permalink:"/docs/\u540e\u7aef/Netty",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"MacOS \u73af\u5883\u914d\u7f6e",permalink:"/docs/\u540e\u7aef/MacOsM1"},next:{title:"Nginx",permalink:"/docs/\u540e\u7aef/Nginx"}},p={},c=[{value:"Netty \u6838\u5fc3\u7ec4\u4ef6",id:"netty-\u6838\u5fc3\u7ec4\u4ef6",level:2},{value:"Channel",id:"channel",level:3},{value:"Callback",id:"callback",level:3},{value:"Future",id:"future",level:3},{value:"ChannelFuture",id:"channelfuture",level:4},{value:"Event &amp; ChannelHandler",id:"event--channelhandler",level:3},{value:"Netty \u5165\u7ad9\u76f8\u5173\u4e8b\u4ef6",id:"netty-\u5165\u7ad9\u76f8\u5173\u4e8b\u4ef6",level:4},{value:"Netty \u51fa\u7ad9\u76f8\u5173\u4e8b\u4ef6",id:"netty-\u51fa\u7ad9\u76f8\u5173\u4e8b\u4ef6",level:4},{value:"Netty \u5feb\u901f\u5f00\u59cb",id:"netty-\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u5f15\u5165\u4f9d\u8d56",id:"\u5f15\u5165\u4f9d\u8d56",level:3},{value:"pom.xml",id:"pomxml",level:4},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef",level:3},{value:"NettyServer",id:"nettyserver",level:4},{value:"NettyServerHandler",id:"nettyserverhandler",level:4},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef",level:3},{value:"NettyClient",id:"nettyclient",level:4},{value:"NettyClientHandler",id:"nettyclienthandler",level:4},{value:"\u4efb\u52a1\u8c03\u5ea6",id:"\u4efb\u52a1\u8c03\u5ea6",level:2},{value:"TaskQueue \u4efb\u52a1\u961f\u5217",id:"taskqueue-\u4efb\u52a1\u961f\u5217",level:3},{value:"scheduledTaskQueue \u5b9a\u65f6\u4efb\u52a1\u961f\u5217",id:"scheduledtaskqueue-\u5b9a\u65f6\u4efb\u52a1\u961f\u5217",level:3},{value:"FutureListener \u76d1\u542c\u5668",id:"futurelistener-\u76d1\u542c\u5668",level:2},{value:"BootStrap\u3001ServerBootStrap",id:"bootstrapserverbootstrap",level:2},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5",level:3},{value:"Future\u3001ChannelFuture",id:"futurechannelfuture",level:2},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5-1",level:3},{value:"Channel",id:"channel-1",level:2},{value:"\u5e38\u7528\u7684 Channel \u7c7b\u578b",id:"\u5e38\u7528\u7684-channel-\u7c7b\u578b",level:3},{value:"Selector",id:"selector",level:2},{value:"ChannelHandler",id:"channelhandler",level:2},{value:"ChannelHandler \u5b9e\u73b0\u7c7b",id:"channelhandler-\u5b9e\u73b0\u7c7b",level:3},{value:"ChannelInboundHandlerAdapter \u5e38\u7528\u65b9\u6cd5",id:"channelinboundhandleradapter-\u5e38\u7528\u65b9\u6cd5",level:3},{value:"@ChannelHandler.Sharable",id:"channelhandlersharable",level:3},{value:"Pipeline &amp; ChannelPipeline",id:"pipeline--channelpipeline",level:2},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5-2",level:3},{value:"ChannelHandlerContext",id:"channelhandlercontext",level:2},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5-3",level:3},{value:"ChannelOption",id:"channeloption",level:2},{value:"ChannelOption.SO_BACKLOG",id:"channeloptionso_backlog",level:3},{value:"ChannelOption.SO_KEEPALIVE",id:"channeloptionso_keepalive",level:3},{value:"EventLoopGroup &amp; NioEventLoopGroup",id:"eventloopgroup--nioeventloopgroup",level:2},{value:"Unpooled",id:"unpooled",level:2},{value:"\u5e38\u7528\u65b9\u6cd5",id:"\u5e38\u7528\u65b9\u6cd5-4",level:3},{value:"\u5fc3\u8df3\u673a\u5236",id:"\u5fc3\u8df3\u673a\u5236",level:2},{value:"WebSocket",id:"websocket",level:2},{value:"Encoder &amp; Decoder",id:"encoder--decoder",level:2},{value:"Netty \u7684\u7f16\u89e3\u7801\u5668",id:"netty-\u7684\u7f16\u89e3\u7801\u5668",level:3},{value:"Google Protobuf",id:"google-protobuf",level:3},{value:"\u7c98\u5305 &amp; \u534a\u5305",id:"\u7c98\u5305--\u534a\u5305",level:2},{value:"\u7c98\u5305",id:"\u7c98\u5305",level:3},{value:"\u73b0\u8c61",id:"\u73b0\u8c61",level:4},{value:"\u539f\u56e0",id:"\u539f\u56e0",level:4},{value:"\u534a\u5305",id:"\u534a\u5305",level:3},{value:"\u73b0\u8c61",id:"\u73b0\u8c61-1",level:4},{value:"\u539f\u56e0",id:"\u539f\u56e0-1",level:4},{value:"\u7c98\u5305\u534a\u5305\u6f14\u793a",id:"\u7c98\u5305\u534a\u5305\u6f14\u793a",level:3},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef-1",level:4},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef-1",level:4},{value:"\u7ed3\u679c\u6253\u5370",id:"\u7ed3\u679c\u6253\u5370",level:4},{value:"\u7ed3\u8bba",id:"\u7ed3\u8bba",level:4},{value:"\u89e3\u51b3\u65b9\u6848",id:"\u89e3\u51b3\u65b9\u6848",level:3},{value:"\u77ed\u8fde\u63a5",id:"\u77ed\u8fde\u63a5",level:4},{value:"\u5b9a\u957f\u89e3\u7801\u5668 FixedLengthFrameDecoder",id:"\u5b9a\u957f\u89e3\u7801\u5668-fixedlengthframedecoder",level:4},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef-2",level:5},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef-2",level:5},{value:"\u884c\u89e3\u7801\u5668 LineBasedFrameDecoder",id:"\u884c\u89e3\u7801\u5668-linebasedframedecoder",level:4},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef-3",level:5},{value:"\u5ba2\u6237\u7aef",id:"\u5ba2\u6237\u7aef-3",level:5},{value:"LET \u89e3\u7801\u5668 LengthFieldBasedFrameDecoder",id:"let-\u89e3\u7801\u5668-lengthfieldbasedframedecoder",level:4},{value:"\u6d4b\u8bd5",id:"\u6d4b\u8bd5",level:5},{value:"\u534f\u8bae\u8bbe\u8ba1\u4e0e\u89e3\u6790",id:"\u534f\u8bae\u8bbe\u8ba1\u4e0e\u89e3\u6790",level:2},{value:"\u81ea\u5b9a\u4e49\u534f\u8bae\u8981\u7d20",id:"\u81ea\u5b9a\u4e49\u534f\u8bae\u8981\u7d20",level:3},{value:"\u81ea\u5b9a\u4e49\u534f\u8bae\u7f16\u89e3\u7801\u5b9e\u73b0",id:"\u81ea\u5b9a\u4e49\u534f\u8bae\u7f16\u89e3\u7801\u5b9e\u73b0",level:3},{value:"MessageCodec",id:"messagecodec",level:4},{value:"Message",id:"message",level:4},{value:"LoginRequestMessage",id:"loginrequestmessage",level:4},{value:"main",id:"main",level:4}],u={toc:c},d="wrapper";function s(e){let{components:n,...t}=e;return(0,l.kt)(d,(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"netty"},"Netty"),(0,l.kt)("h2",{id:"netty-\u6838\u5fc3\u7ec4\u4ef6"},"Netty \u6838\u5fc3\u7ec4\u4ef6"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Channel"),(0,l.kt)("li",{parentName:"ul"},"Callback"),(0,l.kt)("li",{parentName:"ul"},"Future"),(0,l.kt)("li",{parentName:"ul"},"Event & ChannelHandler")),(0,l.kt)("h3",{id:"channel"},"Channel"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Channel \u662f Java NIO \u7684\u4e00\u4e2a\u57fa\u7840\u6784\u9020"),(0,l.kt)("p",{parentName:"blockquote"},"Channel \u662f",(0,l.kt)("inlineCode",{parentName:"p"},"\u5165\u7ad9"),"\u6216",(0,l.kt)("inlineCode",{parentName:"p"},"\u51fa\u7ad9"),"\u6570\u636e\u7684\u8f7d\u4f53\u3002\u56e0\u6b64\u5b83\u53ef\u4ee5\u88ab\u6253\u5f00\u3001\u5173\u95ed\u6216\u8005\u8fde\u63a5\u3001\u65ad\u5f00\u8fde\u63a5")),(0,l.kt)("h3",{id:"callback"},"Callback"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Netty \u5185\u90e8\u4f7f\u7528\u56de\u8c03\u6765\u5904\u7406\u4e8b\u4ef6\uff1b\u5f53\u4e00\u4e2a\u56de\u8c03\u88ab\u89e6\u53d1\u65f6\uff0c\u76f8\u5173\u7684\u4e8b\u4ef6\u53ef\u7528\u88ab\u4e00\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"ChannelHandler")," \u63a5\u53e3\u7684\u5b9e\u73b0\u6765\u5904\u7406")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'public class Callback extends ChannelInboundHandlerAdapter {\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("\u5efa\u7acb\u65b0\u8fde\u63a5");\n    }\n}\n')),(0,l.kt)("h3",{id:"future"},"Future"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Future \u63d0\u4f9b\u4e86\u67d0\u79cd\u64cd\u4f5c\u5b8c\u6210\u65f6\u901a\u77e5\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u5f0f")),(0,l.kt)("h4",{id:"channelfuture"},"ChannelFuture"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"ChannelFuture \u7528\u4e8e\u6267\u884c\u5f02\u6b65\u64cd\u4f5c\u7684\u65f6\u5019\u4f7f\u7528"),(0,l.kt)("p",{parentName:"blockquote"},"\u5b83\u63d0\u4f9b\u4e86\u989d\u5916\u7684\u65b9\u6cd5\uff0c\u80fd\u591f\u5e2e\u52a9\u6211\u4eec\u6ce8\u518c\u4e00\u4e2a\u6216\u8005\u591a\u4e2a ",(0,l.kt)("inlineCode",{parentName:"p"},"ChannelFutureListener")," \u5b9e\u4f8b"),(0,l.kt)("p",{parentName:"blockquote"},"\u76d1\u542c\u5668\u7684\u56de\u8c03\u65b9\u6cd5",(0,l.kt)("inlineCode",{parentName:"p"},"operationComplete()"),"\u5c06\u4f1a\u5728\u5bf9\u5e94\u7684\u64cd\u4f5c\u5b8c\u6210\u65f6\u8c03\u7528"),(0,l.kt)("p",{parentName:"blockquote"},"\u7136\u540e\u76d1\u542c\u5668\u53ef\u4ee5\u5224\u65ad\u8be5\u64cd\u4f5c\u662f\u5426\u6210\u529f"),(0,l.kt)("p",{parentName:"blockquote"},"\u5982\u679c\u5931\u8d25\u53ef\u4ee5\u68c0\u7d22\u4ea7\u751f\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Throwable")),(0,l.kt)("p",{parentName:"blockquote"},"\u6bcf\u4e00\u4e2aNetty\u51fa\u6218\u7684 I/O \u64cd\u4f5c\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2aChannelFuture")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'Bootstrap bootstrap = new Bootstrap();\n// \u8fde\u63a5\u8fdc\u7a0b\u8282\u70b9\nChannelFuture future = bootstrap.connect("127.0.0.1", 8880).sync();\nfuture.addListener(new ChannelFutureListener() { // \u6ce8\u518c\u4e00\u4e2a ChannelFutureListener\uff0c\u5728\u5b8c\u6210\u64cd\u4f5c\u65f6\u83b7\u5f97\u901a\u77e5 \n    @Override\n    public void operationComplete(ChannelFuture future) throws Exception {\n        if (future.isSuccess()) {\n            // \u5982\u679c\u64cd\u4f5c\u6210\u529f\u5219\u505a\u4e00\u4e9b\u64cd\u4f5c\n            System.out.println("\u64cd\u4f5c\u6210\u529f");\n        } else {\n            // \u5931\u8d25\uff0c\u6253\u5370\u5806\u6808\u4fe1\u606f\uff0c\u6216\u8005\u5176\u4ed6\u64cd\u4f5c\n            Throwable cause = future.cause();\n            cause.printStackTrace();\n        }\n    }\n});\n')),(0,l.kt)("h3",{id:"event--channelhandler"},"Event & ChannelHandler"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Netty \u4f7f\u7528\u4e0d\u540c\u7684\u4e8b\u4ef6\u6765\u901a\u77e5\u6211\u4eec\u72b6\u6001\u7684\u6539\u53d8\u6216\u8005\u662f\u64cd\u4f5c\u7684\u6539\u53d8\uff0c\u8fd9\u6837\u53ef\u4ee5\u8ba9\u6211\u4eec\u57fa\u4e8e\u5df2\u7ecf\u53d1\u751f\u7684\u4e8b\u4ef6\u6765\u89e6\u53d1\u9002\u5f53\u7684\u64cd\u4f5c"),(0,l.kt)("p",{parentName:"blockquote"},"\u6bcf\u4e00\u4e2a\u4e8b\u4ef6\u90fd\u53ef\u4ee5\u88ab\u5206\u53d1\u5230 ChannelHandler \u7c7b\u4e2d\u7684\u67d0\u4e2a\u7528\u6237\u5b9e\u73b0\u7684\u65b9\u6cd5"),(0,l.kt)("p",{parentName:"blockquote"},"\u4f8b\u5982\uff1a\u8bb0\u5f55\u65e5\u5fd7\u3001\u6570\u636e\u8f6c\u6362\u3001\u6d41\u63a7\u5236\u3001\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91")),(0,l.kt)("h4",{id:"netty-\u5165\u7ad9\u76f8\u5173\u4e8b\u4ef6"},"Netty \u5165\u7ad9\u76f8\u5173\u4e8b\u4ef6"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8fde\u63a5\u5df2\u88ab\u8bb0\u8fc7\u6216\u8005\u8fde\u63a5\u5931\u6d3b"),(0,l.kt)("li",{parentName:"ul"},"\u6570\u636e\u8bfb\u53d6"),(0,l.kt)("li",{parentName:"ul"},"\u7528\u6237\u4e8b\u4ef6"),(0,l.kt)("li",{parentName:"ul"},"\u9519\u8bef\u4e8b\u4ef6")),(0,l.kt)("h4",{id:"netty-\u51fa\u7ad9\u76f8\u5173\u4e8b\u4ef6"},"Netty \u51fa\u7ad9\u76f8\u5173\u4e8b\u4ef6"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6253\u5f00\u6216\u8005\u5173\u95ed\u5230\u8fdc\u7a0b\u8282\u70b9\u7684\u8fde\u63a5"),(0,l.kt)("li",{parentName:"ul"},"\u5c06\u6570\u636e\u5199\u9053\u6216\u8005\u51b2\u5237\u5230\u5957\u63a5\u5b57")),(0,l.kt)("h2",{id:"netty-\u5feb\u901f\u5f00\u59cb"},"Netty \u5feb\u901f\u5f00\u59cb"),(0,l.kt)("h3",{id:"\u5f15\u5165\u4f9d\u8d56"},"\u5f15\u5165\u4f9d\u8d56"),(0,l.kt)("h4",{id:"pomxml"},"pom.xml"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-xml"},"    <dependencies>\n        \x3c!-- Netty --\x3e\n        <dependency>\n            <groupId>io.netty</groupId>\n            <artifactId>netty-all</artifactId>\n            <version>4.1.48.Final</version>\n        </dependency>\n        \x3c!-- \u4ee5\u4e0b\u4e3a\u65e5\u5fd7\u4f9d\u8d56\uff0c\u53ef\u7701\u7565 --\x3e\n        <dependency>\n            <groupId>ch.qos.logback</groupId>\n            <artifactId>logback-classic</artifactId>\n            <version>1.2.3</version>\n            <scope>compile</scope>\n        </dependency>\n        <dependency>\n            <groupId>org.apache.logging.log4j</groupId>\n            <artifactId>log4j-to-slf4j</artifactId>\n            <version>2.13.3</version>\n            <scope>compile</scope>\n        </dependency>\n        <dependency>\n            <groupId>org.slf4j</groupId>\n            <artifactId>jul-to-slf4j</artifactId>\n            <version>1.7.30</version>\n            <scope>compile</scope>\n        </dependency>\n    </dependencies>\n")),(0,l.kt)("h3",{id:"\u670d\u52a1\u7aef"},"\u670d\u52a1\u7aef"),(0,l.kt)("h4",{id:"nettyserver"},"NettyServer"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import io.netty.bootstrap.ServerBootstrap;\nimport io.netty.channel.ChannelFuture;\nimport io.netty.channel.ChannelInitializer;\nimport io.netty.channel.ChannelOption;\nimport io.netty.channel.EventLoopGroup;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.SocketChannel;\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class NettyServer {\n\n    private final static Logger logger = LoggerFactory.getLogger(NettyServer.class);\n\n    public static void main(String[] args) throws InterruptedException {\n        /**\n         * bossGroup\uff1a\u53ea\u8d1f\u8d23\u5904\u7406\u8fde\u63a5\u8bf7\u6c42\n         */\n        EventLoopGroup bossGroup = new NioEventLoopGroup();\n        EventLoopGroup workGroup = new NioEventLoopGroup();\n        try {\n\n            // \u521b\u5efa\u670d\u52a1\u5668\u7aef\u7684\u542f\u52a8\u5bf9\u8c61\uff0c\u914d\u7f6e\u53c2\u6570\n            ServerBootstrap bootstrap = new ServerBootstrap();\n            bootstrap\n                    // \u8bbe\u7f6e\u4e24\u4e2a\u7ebf\u7a0b\u7ec4\n                    .group(bossGroup, workGroup)\n                    // \u8bbe\u7f6e\u670d\u52a1\u7aef\u7684\u901a\u9053\u5b9e\u73b0\n                    .channel(NioServerSocketChannel.class)\n                    // \u8bbe\u7f6e\u7ebf\u7a0b\u961f\u5217\u5f97\u5230\u8fde\u63a5\u4e2a\u6570\n                    .option(ChannelOption.SO_BACKLOG, 128)\n                    // \u8bbe\u7f6e\u4fdd\u6301\u6d3b\u52a8\u8fde\u63a5\u72b6\u6001\n                    .childOption(ChannelOption.SO_KEEPALIVE, true)\n                    // \u8bbe\u7f6e workGroup \u7684 EventLoop \u5bf9\u5e94\u7684\u901a\u9053\u8bbe\u7f6e\u5904\u7406\u5668\n                    .childHandler(new ChannelInitializer<SocketChannel>() { // \u521b\u5efa\u4e00\u4e2a\u901a\u9053\u521d\u59cb\u5316\u5bf9\u8c61\n                        // \u7ed9 pipeline \u8bbe\u7f6e\u5904\u7406\u5668\n                        @Override\n                        protected void initChannel(SocketChannel ch) throws Exception {\n                            ch.pipeline().addLast(new NettyServerHandler());\n                        }\n                    });\n\n            logger.info("\u670d\u52a1\u7aef\u51c6\u5907\u5b8c\u6210");\n\n            // \u7ed1\u5b9a\u7aef\u53e3\uff0c\u8bbe\u7f6e\u4e3a\u540c\u6b65\uff0c\u5e76\u4e14\u542f\u52a8\u670d\u52a1\u5668\n            ChannelFuture cf = bootstrap.bind(6666).sync();\n            // \u76d1\u542c\u5173\u95ed\u901a\u9053\n            cf.channel().closeFuture().sync();\n        } finally {\n            // \u4f18\u96c5\u7684\u5173\u95ed\n            bossGroup.shutdownGracefully();\n            workGroup.shutdownGracefully();\n        }\n    }\n}\n')),(0,l.kt)("h4",{id:"nettyserverhandler"},"NettyServerHandler"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"import io.netty.buffer.ByteBuf;\nimport io.netty.buffer.Unpooled;\nimport io.netty.channel.ChannelFutureListener;\nimport io.netty.channel.ChannelHandlerContext;\nimport io.netty.channel.ChannelInboundHandlerAdapter;\nimport io.netty.util.CharsetUtil;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n@ChannelHandler.Sharable\npublic class NettyServerHandler extends ChannelInboundHandlerAdapter {\n\n    private final static Logger logger = LoggerFactory.getLogger(NettyServerHandler.class);\n\n    /**\n     * \u5bf9\u4e8e\u6bcf\u4e2a\u4f20\u5165\u7684\u6d88\u606f\u90fd\u4f1a\u8c03\u7528\n     * @param ctx   \u4e0a\u4e0b\u6587\u5bf9\u8c61\uff0c\u5305\u542b pipeline(\u7ba1\u9053)\u3001channel(\u901a\u9053)\u3001\u5730\u5740\n     * @param msg   \u5ba2\u6237\u7aef\u4f20\u9012\u6765\u7684\u6d88\u606f\n     * @throws Exception\n     */\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        ByteBuf buf = (ByteBuf) msg;\n        // \u5c06\u63a5\u6536\u5230\u7684\u6d88\u606f\u5199\u7ed9\u5ba2\u6237\u7aef\uff0c\u800c\u4e0d\u51b2\u5237\u51fa\u7ad9\u6d88\u606f\n        ctx.write(buf);\n    }\n\n    /**\n     * \u901a\u77e5 ChannelInboundHandler \u6700\u540e\u4e00\u6b21\u5bf9 channelRead() \u7684\u8c03\u7528\u662f\u5f53\u524d\u6279\u91cf\u8bfb\u53d6\u4e2d\u7684\u6700\u540e\u4e00\u6761\u6d88\u606f\n     * @param ctx\n     * @throws Exception\n     */\n    @Override\n    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {\n        // \u5c06\u6682\u5b58\u4e8e ChannelOutboundBuffer \u4e2d\u7684\u6d88\u606f\u51b2\u5237\u5230\u8fdc\u7a0b\u8282\u70b9\uff0c\n        // \u5e76\u5728\u4e0b\u4e00\u6b21\u8c03\u7528flush()\u6216\u8005writeAndFlush()\u65b9\u6cd5\u65f6\u5c06\u4f1a\u5c1d\u8bd5\u5199\u51fa\u5230\u5957\u63a5\u5b57\n        ctx.writeAndFlush(Unpooled.EMPTY_BUFFER)\n                // \u76d1\u542c\u6d88\u606f\u51b2\u5237\u5b8c\u6bd5\u540e\u5173\u95ed\u8be5 Channel\n                .addListener(ChannelFutureListener.CLOSE);\n    }\n\n    /**\n     * \u7684\u8bfb\u53d6\u64cd\u4f5c\u671f\u95f4\uff0c\u6709\u5f02\u5e38\u629b\u51fa\u65f6\u8c03\u7528\n     * @param ctx\n     * @param cause\n     * @throws Exception\n     */\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n        // \u6253\u5370\u5806\u6808\u5f02\u5e38\n        cause.printStackTrace();\n        // \u5173\u95ed Channel\n        ctx.close();\n    }\n}\n")),(0,l.kt)("h3",{id:"\u5ba2\u6237\u7aef"},"\u5ba2\u6237\u7aef"),(0,l.kt)("h4",{id:"nettyclient"},"NettyClient"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import io.netty.bootstrap.Bootstrap;\nimport io.netty.channel.ChannelFuture;\nimport io.netty.channel.ChannelInitializer;\nimport io.netty.channel.EventLoopGroup;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.SocketChannel;\nimport io.netty.channel.socket.nio.NioSocketChannel;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class NettyClient {\n\n    private final static Logger logger = LoggerFactory.getLogger(NettyClient.class);\n\n    public static void main(String[] args) throws InterruptedException {\n        // \u5ba2\u6237\u7aef \u9700\u8981\u4e00\u4e2a\u5faa\u73af\u7ec4\n        EventLoopGroup eventExecutors = new NioEventLoopGroup();\n\n        try {\n            // \u5ba2\u6237\u7aef\u542f\u52a8\u5bf9\u8c61\n            // \u670d\u52a1\u7aef\u4f7f\u7528 ServerBootstrap \u800c\u5ba2\u6237\u7aef\u662f\u4f7f\u7528 Bootstrap\n            Bootstrap bootstrap = new Bootstrap();\n            bootstrap\n                    // \u8bbe\u7f6e\u7ebf\u7a0b\u7ec4\n                    .group(eventExecutors)\n                    // \u8bbe\u7f6e\u5ba2\u6237\u7aef\u901a\u9053\u7684\u5b9e\u73b0\n                    .channel(NioSocketChannel.class)\n                    .handler(new ChannelInitializer<SocketChannel>() {\n                        @Override\n                        protected void initChannel(SocketChannel ch) throws Exception {\n                            ch.pipeline().addLast(new NettyClientHandler());\n                        }\n                    });\n\n            logger.info("\u5ba2\u6237\u7aef\u51c6\u5907\u5b8c\u6210");\n\n            // \u542f\u52a8\u5ba2\u6237\u7aef\u5e76\u8fde\u63a5\u670d\u52a1\u7aef\n            ChannelFuture future = bootstrap.connect("127.0.0.1", 6666).sync();\n            // \u76d1\u542c\u5173\u95ed\u901a\u9053\n            future.channel().closeFuture().sync();\n        } finally {\n            eventExecutors.shutdownGracefully();\n        }\n    }\n}\n')),(0,l.kt)("h4",{id:"nettyclienthandler"},"NettyClientHandler"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import io.netty.buffer.ByteBuf;\nimport io.netty.buffer.Unpooled;\nimport io.netty.channel.ChannelHandlerContext;\nimport io.netty.channel.ChannelInboundHandlerAdapter;\nimport io.netty.util.CharsetUtil;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class NettyClientHandler extends ChannelInboundHandlerAdapter {\n\n    private final static Logger logger = LoggerFactory.getLogger(NettyClientHandler.class);\n\n    /**\n     * \u5f53\u901a\u9053\u5c31\u7eea\u65f6\u89e6\u53d1\n     * @param ctx\n     * @throws Exception\n     */\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        logger.info("client : {}", ctx);\n        ctx.writeAndFlush(Unpooled.copiedBuffer("Hello Client", CharsetUtil.UTF_8));\n    }\n\n    /**\n     * \u8bfb\u53d6\u670d\u52a1\u7aef\u53d1\u9001\u7684\u6d88\u606f\n     * @param ctx\n     * @param msg\n     * @throws Exception\n     */\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        ByteBuf buf = (ByteBuf) msg;\n        logger.info("\u670d\u52a1\u7aef\u56de\u590d\u7684\u6d88\u606f : {}", buf.toString(CharsetUtil.UTF_8));\n        logger.info("\u670d\u52a1\u5668\u7684\u5730\u5740 : {}", ctx.channel().remoteAddress());\n    }\n\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n        cause.printStackTrace();\n        ctx.close();\n    }\n}\n')),(0,l.kt)("h2",{id:"\u4efb\u52a1\u8c03\u5ea6"},"\u4efb\u52a1\u8c03\u5ea6"),(0,l.kt)("h3",{id:"taskqueue-\u4efb\u52a1\u961f\u5217"},"TaskQueue \u4efb\u52a1\u961f\u5217"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        logger.info("server context : {}", ctx);\n\n        // \u5b9a\u4e49 taskQueue \u5b9e\u73b0\u5f02\u6b65\u4efb\u52a1\u3002\u89e3\u51b3 : \u4e1a\u52a1\u65f6\u95f4\u8fc7\u957f\u5bfc\u81f4\u957f\u65f6\u95f4\u963b\u585e\n        ctx.channel().eventLoop().execute(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    Thread.sleep(10 * 1000);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                ctx.writeAndFlush(Unpooled.copiedBuffer("Hello Netty2~", CharsetUtil.UTF_8));\n            }\n        });\n\n        ByteBuf buf = (ByteBuf) msg;\n        logger.info("\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6d88\u606f\u662f : {}", buf.toString(CharsetUtil.UTF_8));\n        logger.info("\u5ba2\u6237\u7aef\u7684\u5730\u5740\u662f : {}", ctx.channel().remoteAddress());\n    }\n')),(0,l.kt)("h3",{id:"scheduledtaskqueue-\u5b9a\u65f6\u4efb\u52a1\u961f\u5217"},"scheduledTaskQueue \u5b9a\u65f6\u4efb\u52a1\u961f\u5217"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        logger.info("server context : {}", ctx);\n\n        // \u53c2\u6570\u4e00\uff1a\u4e1a\u52a1\u5b9e\u73b0\u3001\u53c2\u6570\u4e8c\uff1a\u5ef6\u8fdf\u65f6\u95f4\u3001\u53c2\u6570\u4e09\uff1a\u65f6\u95f4\u5355\u4f4d\n        ctx.channel().eventLoop().schedule(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    Thread.sleep(10 * 1000);\n                } catch (InterruptedException e) {\n                    e.printStackTrace();\n                }\n                ctx.writeAndFlush(Unpooled.copiedBuffer("Hello Netty2~", CharsetUtil.UTF_8));\n            }\n        }, 5, TimeUnit.SECONDS);\n\n        ByteBuf buf = (ByteBuf) msg;\n        logger.info("\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6d88\u606f\u662f : {}", buf.toString(CharsetUtil.UTF_8));\n        logger.info("\u5ba2\u6237\u7aef\u7684\u5730\u5740\u662f : {}", ctx.channel().remoteAddress());\n   }\n')),(0,l.kt)("h2",{id:"futurelistener-\u76d1\u542c\u5668"},"FutureListener \u76d1\u542c\u5668"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Future \u5bf9\u8c61\u521a\u521a\u521b\u5efa\u65f6\uff0c\u5904\u4e8e\u975e\u5b8c\u6210\u72b6\u6001\uff0c\u8c03\u7528\u8005\u53ef\u4ee5\u901a\u8fc7\u8fd4\u56de\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"ChannelFuture")," \u6765\u83b7\u53d6\u64cd\u4f5c\u6267\u884c\u7684\u72b6\u6001\uff0c\u6ce8\u518c\u76d1\u542c\u51fd\u6570\u6765\u6267\u884c\u5b8c\u6210\u540e\u7684\u64cd\u4f5c")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'// \u7ed1\u5b9a\u7aef\u53e3\uff0c\u8bbe\u7f6e\u4e3a\u540c\u6b65\uff0c\u5e76\u4e14\u542f\u52a8\u670d\u52a1\u5668\nChannelFuture cf = bootstrap.bind(6666).sync();\n// \u6dfb\u52a0\u76d1\u542c\u5668\ncf.addListener(new ChannelFutureListener() {\n    @Override\n    public void operationComplete(ChannelFuture future) throws Exception {\n        if (cf.isSuccess()) {\n            logger.info("\u76d1\u542c\u7aef\u53e3 6666 \u6210\u529f");\n        } else {\n            logger.error("\u76d1\u542c\u7aef\u53e3 6666 \u5931\u8d25");\n        }\n    }\n});\n')),(0,l.kt)("h2",{id:"bootstrapserverbootstrap"},"BootStrap\u3001ServerBootStrap"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"BootStrap: \u53ea\u8981\u7528\u4e8e\u914d\u7f6e\u6574\u4e2a Netty \u7a0b\u5e8f\u3001\u4e32\u8054\u5404\u4e2a\u7ec4\u4ef6\nNetty \u4e2d\u7684 BootStrap \u7c7b\u662f\u5ba2\u6237\u7aef\u7a0b\u5e8f\u7684\u542f\u52a8\u5f15\u5bfc\u7c7b\u3001ServerBootStrap \u662f\u670d\u52a1\u7aef\u542f\u52a8\u5f15\u5bfc\u7c7b")),(0,l.kt)("h3",{id:"\u5e38\u7528\u65b9\u6cd5"},"\u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u5728\u670d\u52a1\u7aef\u8bbe\u7f6e\u4e24\u4e2aEventLoop\npublic ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup) {}\n// \u5728\u5ba2\u6237\u7aef\u8bbe\u7f6e\u4e00\u4e2aEventLoop\npublic B group(EventLoopGroup group) {}\n// \u8bbe\u7f6e\u4e00\u4e2a\u670d\u52a1\u5668\u7aef\u7684\u901a\u9053\u5b9e\u73b0\npublic B channel(Class<? extends C> channelClass) {}\n// \u7528\u6765\u7ed9 ServerChannel \u6dfb\u52a0\u914d\u7f6e\npublic <T> B option(ChannelOption<T> option, T value) {}\n// \u7528\u6765\u7ed9\u63a5\u6536\u5230\u7684\u901a\u9053\u6dfb\u52a0\u914d\u7f6e\npublic <T> ServerBootstrap childOption(ChannelOption<T> childOption, T value) {}\n// \u8bbe\u7f6e\u670d\u52a1\u7aef\u7684\u7aef\u53e3\npublic ChannelFuture bind(int inetPort) {}\n// \u63d0\u4f9b\u7ed9\u5ba2\u6237\u7aef\u8fde\u63a5\u670d\u52a1\u7aef\npublic ChannelFuture connect(String inetHost, int inetPort) {}\n")),(0,l.kt)("h2",{id:"futurechannelfuture"},"Future\u3001ChannelFuture"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Netty \u4e2d\u6240\u6709\u7684 IO \u64cd\u4f5c\u90fd\u662f\u5f02\u6b65\u7684\u3001\u4e0d\u80fd\u7acb\u523b\u5f97\u77e5\u6d88\u606f\u88ab\u6b63\u786e\u5904\u7406"),(0,l.kt)("p",{parentName:"blockquote"},"\u4f46\u662f\u53ef\u4ee5\u7b49\u5f85\u6267\u884c\u5b8c\u6210\u6216\u8005\u6ce8\u518c\u76d1\u542c\u5668\uff0c\u5177\u4f53\u901a\u8fc7 Future\u3001ChanelFutures \u6765\u6ce8\u518c\u76d1\u542c\u5668"),(0,l.kt)("p",{parentName:"blockquote"},"\u5f53\u64cd\u4f5c\u6210\u529f\u6216\u8005\u5931\u8d25\u7684\u65f6\u5019\u4f1a\u53bb\u6267\u884c\u6ce8\u518c\u7684\u76d1\u542c\u5668")),(0,l.kt)("h3",{id:"\u5e38\u7528\u65b9\u6cd5-1"},"\u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u8fd4\u56de\u5f53\u524d\u6b63\u5728\u6267\u884cIO\u7684\u64cd\u4f5c\u7684\u901a\u9053\nChannel channel();\n// \u7b49\u5f85\u5f02\u6b65\u6267\u884c\u5b8c\u6bd5\nChannelFuture sync() throws InterruptedException;\n")),(0,l.kt)("h2",{id:"channel-1"},"Channel"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Netty \u7f51\u7edc\u901a\u4fe1\u7684\u7ec4\u4ef6\uff0c\u80fd\u591f\u7528\u4e8e\u6267\u884c\u7f51\u7edc I/O \u64cd\u4f5c"),(0,l.kt)("li",{parentName:"ol"},"\u901a\u8fc7 Channel \u53ef\u83b7\u5f97\u5f53\u524d\u7f51\u7edc\u8fde\u63a5\u901a\u9053\u7684\u72b6\u6001\u3001\u914d\u7f6e\u53c2\u6570\uff08\u4f8b\u5982\u63a5\u6536\u7f13\u51b2\u533a\u5927\u5c0f\uff09"),(0,l.kt)("li",{parentName:"ol"},"Channel \u63d0\u4f9b\u5f02\u6b65\u7684\u7f51\u7edc I/O \u64cd\u4f5c\uff08\u5982\u5efa\u7acb\u8fde\u63a5\u3001\u8bfb\u5199\u3001\u7ed1\u5b9a\u7aef\u53e3\uff09"),(0,l.kt)("li",{parentName:"ol"},"\u8c03\u7528\u7acb\u5373\u8fd4\u56de\u4e00\u4e2a ChannelFuture \u5b9e\u4f8b\uff0c\u901a\u8fc7\u6ce8\u518c\u76d1\u542c\u5668\u5230 ChannelFuture \u4e0a\uff0c\u53ef\u4ee5\u5728 I/O \u64cd\u4f5c\u6210\u529f\u3001\u5931\u8d25\u6216\u53d6\u6d88\u65f6\u56de\u8c03\u901a\u77e5\u8c03\u7528\u65b9"),(0,l.kt)("li",{parentName:"ol"},"\u652f\u6301\u5173\u8054 I/O \u64cd\u4f5c\u4e0e\u5bf9\u5e94\u7684\u5904\u7406\u7a0b\u5e8f"),(0,l.kt)("li",{parentName:"ol"},"\u4e0d\u540c\u534f\u8bae\u3001\u4e0d\u540c\u7684\u963b\u585e\u7c7b\u578b\u7684\u8fde\u63a5\u90fd\u6709\u4e0d\u540c\u7684 Channel \u7c7b\u578b\u4e0e\u4e4b\u5bf9\u5e94")),(0,l.kt)("h3",{id:"\u5e38\u7528\u7684-channel-\u7c7b\u578b"},"\u5e38\u7528\u7684 Channel \u7c7b\u578b"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"NioSOcketChannel")," : \u5f02\u6b65\u7684",(0,l.kt)("inlineCode",{parentName:"li"},"\u5ba2\u6237\u7aef")," ",(0,l.kt)("inlineCode",{parentName:"li"},"TCP Socket")," \u8fde\u63a5"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"NioServerSocketChannel")," : \u5f02\u6b65\u7684",(0,l.kt)("inlineCode",{parentName:"li"},"\u670d\u52a1\u5668\u7aef")," ",(0,l.kt)("inlineCode",{parentName:"li"},"TOC Socket")," \u8fde\u63a5"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"NioDatagramChannel")," : \u5f02\u6b65\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"UDP")," \u8fde\u63a5"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"NioSctpChannel")," : \u5f02\u6b65\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"\u5ba2\u6237\u7aef")," ",(0,l.kt)("inlineCode",{parentName:"li"},"Sctp")," \u8fde\u63a5"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"NioSctpServerChannel")," : \u5f02\u6b65\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"Sctp")," ",(0,l.kt)("inlineCode",{parentName:"li"},"\u670d\u52a1\u5668\u7aef")," \u8fde\u63a5")),(0,l.kt)("h2",{id:"selector"},"Selector"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Netty \u57fa\u4e8e Selector \u5bf9\u8c61\u5b9e\u73b0 I/O \u591a\u8def\u590d\u7528\uff0c\u901a\u8fc7 Selector \u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u76d1\u542c\u591a\u4e2a\u8fde\u63a5\u7684 Channel \u4e8b\u4ef6"),(0,l.kt)("p",{parentName:"blockquote"},"\u5f53\u5411\u4e00\u4e2a Selector \u4e2d\u6ce8\u518c Channel \u540e Selector \u5185\u90e8\u7684\u673a\u5236\u5c31\u53ef\u4ee5\u81ea\u52a8\u4e0d\u65ad\u7684\u67e5\u8be2\u8fd9\u4e9b\u6ce8\u518c\u7684 Channel \u662f\u5426\u4ee5\u6709\u5c31\u7eea\u7684I/O\u4e8b\u4ef6"),(0,l.kt)("p",{parentName:"blockquote"},"\u4f8b\u5982\u53ef\u8bfb\u3001\u53ef\u5199\u3001\u7f51\u7edc\u8fde\u63a5\u5b8c\u6210\u7b49"),(0,l.kt)("p",{parentName:"blockquote"},"\u8fd9\u6837\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u4f7f\u7528\u4e00\u4e2a\u4e0b\u79f0\u9ad8\u6548\u7684\u7ba1\u7406\u591a\u4e2a Channel")),(0,l.kt)("h2",{id:"channelhandler"},"ChannelHandler"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"ChannelHandler \u662f\u4e00\u4e2a\u501f\u53e3\uff0c\u7528\u6765\u5904\u7406 I/O \u4e8b\u4ef6\u6216\u62e6\u622a I/O \u64cd\u4f5c"),(0,l.kt)("p",{parentName:"blockquote"},"\u5e76\u5c06\u5176\u8f6c\u53d1\u5230\u5176\u4ed6 ChannelPipeline(\u4e1a\u52a1\u5904\u7406\u94fe)\u4e2d\u7684\u4e0b\u4e00\u4e2a\u5904\u7406\u7a0b\u5e8f")),(0,l.kt)("h3",{id:"channelhandler-\u5b9e\u73b0\u7c7b"},"ChannelHandler \u5b9e\u73b0\u7c7b"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ChannelInboundHandler")," : \u7528\u4e8e\u5904\u7406\u5165\u7ad9 I/O \u4e8b\u4ef6"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ChannelOutboundHandler")," : \u7528\u4e8e\u5904\u7406\u51fa\u6808 I/O \u64cd\u4f5c"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ChannelInboundHandlerAdapter")," : \u7528\u4e8e\u5904\u7406\u5165\u7ad9 I/O \u4e8b\u4ef6"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ChannelOutboundHandlerAdapter")," : \u7528\u4e8e\u5904\u7406\u51fa\u6808 I/O \u64cd\u4f5c"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ChannelDuplexHandler")," : \u7528\u4e8e\u5904\u7406\u5165\u7ad9\u548c\u51fa\u6218\u4e8b\u4ef6")),(0,l.kt)("h3",{id:"channelinboundhandleradapter-\u5e38\u7528\u65b9\u6cd5"},"ChannelInboundHandlerAdapter \u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u901a\u9053\u88ab\u6ce8\u518c\u4e8b\u4ef6\npublic void channelRegistered(ChannelHandlerContext ctx) throws Exception {}\n// \u901a\u9053\u88ab\u6ce8\u9500\u4e8b\u4ef6\npublic void channelUnregistered(ChannelHandlerContext ctx) throws Exception {}\n\n// \u901a\u9053\u5904\u7406\u5c31\u7eea\u4e8b\u4ef6\npublic void channelActive(ChannelHandlerContext ctx) throws Exception{}\n// \u901a\u9053\u8bfb\u53d6\u6570\u636e\u4e8b\u4ef6\npublic void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {}\n// \u6570\u636e\u8bfb\u53d6\u5b8c\u6bd5\u4e8b\u4ef6\npublic void channelReadComplete(ChannelHandlerContext ctx) throws Exception {}\n// \u901a\u9053\u53d1\u751f\u5f02\u5e38\u4e8b\u4ef6\npublic void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {}\n\n// \u5f53\u524d Handler \u88ab pipeline \u6ce8\u518c\u65f6\u89e6\u53d1\npublic void handlerAdded(ChannelHandlerContext ctx) throws Exception {}\n// \u5f53\u524d Handler \u88ab pipeline \u79fb\u9664\u65f6\u89e6\u53d1\npublic void handlerRemoved(ChannelHandlerContext ctx) throws Exception {}\n")),(0,l.kt)("h3",{id:"channelhandlersharable"},"@ChannelHandler.Sharable"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u8868\u793a\u4e00\u4e2a ChannelHandler \u53ef\u4ee5\u88ab\u591a\u4e2a Channel \u5b89\u5168\u7684\u5171\u4eab"),(0,l.kt)("p",{parentName:"blockquote"},"Netty \u4f1a\u5728\u6bcf\u4e2a Channel \u4e2d\u90fd\u6dfb\u52a0\u5904\u7406\u5668\uff0c\u5982\u679c\u6bcf\u4e2a\u901a\u9053\u90fd\u521b\u5efa\u4e00\u6b21\u5bf9\u8c61\uff0c\u5bf9\u5185\u5b58\u7684\u6d88\u8017\u65e0\u7591\u662f\u975e\u5e38\u5927\u7684"),(0,l.kt)("p",{parentName:"blockquote"},"\u6240\u4ee5\u4e00\u822c\u5728\u7ebf\u7a0b\u5b89\u5168\u7684\u5904\u7406\u5668\u4e2d\uff0c\u90fd\u4f1a\u6807\u6ce8\u6b64\u6ce8\u89e3\uff0c\u8868\u793a\u53ef\u4ee5\u53ea\u521b\u5efa\u4e00\u6b21\u5bf9\u8c61"),(0,l.kt)("p",{parentName:"blockquote"},"\u4e00\u822c\u5728\u6ca1\u6709\u5171\u4eab\u53d8\u91cf\u7684\u5904\u7406\u5668\u90fd\u53ef\u4ee5\u52a0\u5165\u6b64\u6ce8\u89e3")),(0,l.kt)("h2",{id:"pipeline--channelpipeline"},"Pipeline & ChannelPipeline"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"ChannelPipeline \u662f\u4e00\u4e2a Handler \u7684\u96c6\u5408\uff0c\u8d1f\u8d23\u5904\u7406\u548c\u62e6\u622a inbound \u6216\u8005 outbound \u7684\u4e8b\u4ef6\u548c\u64cd\u4f5c"),(0,l.kt)("p",{parentName:"blockquote"},"\u76f8\u5f53\u4e8e\u4e00\u4e2a\u8d2f\u7a7fNetty\u7684\u94fe"),(0,l.kt)("p",{parentName:"blockquote"},"\u7b80\u5355\u8bf4\uff1aChannelPipeline \u662f\u4e00\u4e2a\u7528\u6765\u4fdd\u5b58 ChannelHandler \u7684\u96c6\u5408\uff0c\u7528\u6765\u5904\u7406\u6216\u62e6\u622a Channel \u7684\u5165\u7ad9\u4e8b\u4ef6\u548c\u51fa\u6218\u64cd\u4f5c"),(0,l.kt)("p",{parentName:"blockquote"},"ChannelPipeline \u5b9e\u73b0\u4e86\u4e00\u79cd\u9ad8\u7ea7\u5f62\u5f0f\u7684\u62e6\u622a\u8fc7\u6ee4\u5668\u6a21\u5f0f\uff0c\u8ba9\u7528\u6237\u53ef\u4ee5\u5b8c\u5168\u63a7\u5236\u4e8b\u4ef6\u7684\u5904\u7406\u65b9\u5f0f\uff0c\u4ee5\u53ca Channel \u4e2d\u5404\u4e2a\u7684 ChannelHandler \u7684\u76f8\u4e92\u4ea4\u4e92"),(0,l.kt)("p",{parentName:"blockquote"},"\u5728 Netty \u4e2d\uff0c\u6bcf\u4e2a Channel \u90fd\u4ec5\u6709\u4e00\u4e2a ChannelPipeline\uff0c")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u4e00\u4e2a Channel \u5305\u542b\u4e86\u4e00\u4e2a ChannelPipeline\uff0c \u800c ChannelPipeline \u4e2d\u53c8\u7ef4\u62a4\u4e86\u4e00\u4e2a\u7531 ChannelHandlerContext \u7ec4\u6210\u7684\u53cc\u5411\u94fe\u8868"),(0,l.kt)("p",{parentName:"blockquote"},"\u5e76\u4e14\u6bcf\u4e2a ChannelHandlerContext \u4e2d\u53c8\u5173\u8054\u7740\u4e00\u4e2a ChannelHandler"),(0,l.kt)("p",{parentName:"blockquote"},"\u5165\u7ad9\u4e8b\u4ef6\u548c\u51fa\u6218\u4e8b\u4ef6\u5728\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\u4e2d\uff0c\u5165\u7ad9\u4e8b\u4ef6\u4f1a\u4ece\u94fe\u8868 head \u5f80\u540e\u4f20\u9012\u5230\u6700\u540e\u4e00\u4e2a\u5165\u7ad9\u7684 handler"),(0,l.kt)("p",{parentName:"blockquote"},"\u51fa\u6218\u4e8b\u4ef6\u4f1a\u4ece\u94fe\u8868 tail \u5f80\u524d\u4f20\u9012\u5230\u6700\u524d\u4e00\u4e2a\u51fa\u7ad9\u7684 handler\uff0c \u4e24\u79cd\u7c7b\u578b\u7684 handler \u4e92\u4e0d\u5e72\u6270")),(0,l.kt)("h3",{id:"\u5e38\u7528\u65b9\u6cd5-2"},"\u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u628a handler \u6dfb\u52a0\u5230\u94fe\u8868\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\nChannelPipeline addLast(ChannelHandler... handlers);\n// \u628a handler \u6dfb\u52a0\u5230\u94fe\u8868\u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\nChannelPipeline addFirst(ChannelHandler... handlers);\n")),(0,l.kt)("h2",{id:"channelhandlercontext"},"ChannelHandlerContext"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u4fdd\u5b58 Channel \u76f8\u5173\u7684\u6240\u6709\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u540c\u65f6\u5173\u8054\u4e00\u4e2a ChannelHandler \u5bf9\u8c61"),(0,l.kt)("p",{parentName:"blockquote"},"ChannelHandlerContext \u4e2d\u5305\u542b\u4e00\u4e2a\u5177\u4f53\u7684\u4e8b\u4ef6\u5904\u7406\u5668 ChannelHandler"),(0,l.kt)("p",{parentName:"blockquote"},"\u540c\u65f6 ChannelHandlerContext \u4e2d\u4e5f\u7ed1\u5b9a\u4e86\u5bf9\u5e94\u7684pipeline \u548c Channel \u7684\u4fe1\u606f\uff0c\u65b9\u4fbf\u5bf9 ChannelHandler \u8fdb\u884c\u8c03\u7528")),(0,l.kt)("h3",{id:"\u5e38\u7528\u65b9\u6cd5-3"},"\u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u5173\u95ed\u901a\u9053\nChannelFuture close();\n// \u5237\u65b0\nChannelHandlerContext flush();\n// \u5c06\u6570\u636e\u5199\u5230 ChannelPipeline \u4e2d\uff0c\u5f53\u524d CHannelHandler \u7684\u4e0b\u4e00\u4e2a ChannelHandler \u5f00\u59cb\u5904\u7406\uff08\u51fa\u7ad9\uff09\nChannelFuture writeAndFlush(Object msg);\n")),(0,l.kt)("h2",{id:"channeloption"},"ChannelOption"),(0,l.kt)("h3",{id:"channeloptionso_backlog"},"ChannelOption.SO_BACKLOG"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5bf9\u5e94 TCP/IP \u534f\u8bae Listen \u51fd\u6570\u4e2d\u7684 backlog \u53c2\u6570\uff0c\u7528\u6765\u521d\u59cb\u5316\u670d\u52a1\u5668\u53ef\u8fde\u63a5\u961f\u5217\u5927\u5c0f"),(0,l.kt)("p",{parentName:"blockquote"},"\u670d\u52a1\u7aef\u5904\u7406\u5ba2\u6237\u7aef\u94fe\u63a5\u8bf7\u6c42\u662f\u987a\u5e8f\u5904\u7406\u7684\uff0c\u6240\u4ee5\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u5904\u7406\u4e00\u4e2a\u5ba2\u6237\u7aef\u8fde\u63a5\uff0c\u591a\u4e2a\u5ba2\u6237\u7aef\u8bf7\u6c42\u65f6\uff0c\u670d\u52a1\u7aef\u4e0d\u80fd\u5904\u7406\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u8bf7\u6c42\u653e\u5728\u961f\u5217\u4e2d\u7b49\u5f85\u5904\u7406")),(0,l.kt)("h3",{id:"channeloptionso_keepalive"},"ChannelOption.SO_KEEPALIVE"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u662f\u5426\u4fdd\u6301\u8fde\u63a5\u6d3b\u52a8\u72b6\u6001")),(0,l.kt)("h2",{id:"eventloopgroup--nioeventloopgroup"},"EventLoopGroup & NioEventLoopGroup"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"EventLoopGroup \u662f\u4e00\u7ec4 EventLoop \u7684\u62bd\u8c61\uff0cNetty \u4e3a\u4e86\u8ddf\u4ed6\u597d\u7684\u5229\u7528\u591a\u6838 CPU \u8d44\u6e90\uff0c\u4e00\u534a\u4f1a\u6709\u591a\u4e2a EventLoop \u540c\u65f6\u5de5\u4f5c\uff0c\u6bcf\u4e2a EventLoop \u7ef4\u62a4\u7740\u4e00\u4e2a Selector \u5b9e\u4f8b"),(0,l.kt)("p",{parentName:"blockquote"},"EventLoopGroup \u63d0\u4f9b next \u63a5\u53e3\uff0c\u53ef\u4ee5\u91cd\u91cc\u9762\u6309\u7167\u4e00\u5b9a\u89c4\u5219\u83b7\u53d6\u5176\u4e2d\u4e00\u4e2a EventLoop \u6765\u5904\u7406\u4efb\u52a1"),(0,l.kt)("p",{parentName:"blockquote"},"\u5728 Netty \u670d\u52a1\u5668\u7aef\u7f16\u7a0b\u4e2d\uff0c\u6211\u4eec\u4e00\u534a\u90fd\u9700\u8981\u63d0\u4f9b\u4e24\u4e2a EventLoopGroup\uff0c\u4f8b\u5982\uff1aBossEventLoopGroup \u548c WorkerEventLoopGroup"),(0,l.kt)("p",{parentName:"blockquote"},"\u901a\u5e38\u4e00\u4e2a\u670d\u52a1\u7aef\u53e3\u5373\u4e00\u4e2a ServerSocketChannel \u5bf9\u5e94\u4e00\u4e2a Selector \u548c\u4e00\u4e2a EventLoop \u7ebf\u7a0b\u3002"),(0,l.kt)("p",{parentName:"blockquote"},"BossEventLoop \u8d1f\u8d23\u63a5\u6536\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u5e76\u5c06 SocketChannel \u4ea4\u7ed9 WorkerEventLoopGroup \u6765\u8fdb\u884c IO \u5904\u7406"),(0,l.kt)("blockquote",{parentName:"blockquote"},(0,l.kt)("p",{parentName:"blockquote"},"BossEventLoopGroup \u901a\u5e38\u662f\u4e00\u4e2a\u5355\u7ebf\u7a0b\u7684 EventLoop\uff0cEventLoop\u7ef4\u62a4\u8005\u4e00\u4e2a\u6ce8\u518c\u4e86 ServerSocketChannel \u7684 Selector \u5b9e\u4f8b\uff0cBossEventLoop \u4e0d\u65ad\u8f6e\u8be2 Selector \u5c06\u8fde\u63a5\u4e8b\u4ef6\u5206\u79bb\u51fa\u6765"),(0,l.kt)("p",{parentName:"blockquote"},"\u901a\u5e38\u662f OP_ACCEPT \u4e8b\u4ef6\uff0c\u7136\u540e\u5c06\u63a5\u6536\u5230\u7684 SocketChannel \u4ea4\u7ed9 WorkerEventLoopGroup"),(0,l.kt)("p",{parentName:"blockquote"},"WorkerEventLoopGroup \u4f1a\u7531 next \u9009\u62e9\u5176\u4e2d\u4e00\u4e2a EventLoopGroup \u6765\u5c06\u8fd9\u4e2a SocketChannel \u6ce8\u518c\u5230\u5176\u7ef4\u62a4 Selector \u5e76\u5bf9\u5176\u540e\u7eed\u7684 IO \u4e8b\u4ef6\u8fdb\u884c\u5904\u7406"))),(0,l.kt)("h2",{id:"unpooled"},"Unpooled"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Unpooled \u7c7b\u662f Netty \u7528\u6765\u64cd\u4f5c \u7f13\u51b2\u533a\u7684\u5de5\u5177\u7c7b")),(0,l.kt)("h3",{id:"\u5e38\u7528\u65b9\u6cd5-4"},"\u5e38\u7528\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"public static ByteBuf copiedBuffer(CharSequence string, Charset charset)\n")),(0,l.kt)("h2",{id:"\u5fc3\u8df3\u673a\u5236"},"\u5fc3\u8df3\u673a\u5236"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'package io.mvvm.netty.heart;\n\nimport io.netty.bootstrap.ServerBootstrap;\nimport io.netty.channel.*;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.SocketChannel;\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\nimport io.netty.handler.logging.LogLevel;\nimport io.netty.handler.logging.LoggingHandler;\nimport io.netty.handler.timeout.IdleStateHandler;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.util.concurrent.TimeUnit;\n\n/**\n * @program: Netty\n * @description: \u5fc3\u8df3\u673a\u5236-\u670d\u52a1\u7aef\n * @author: \u6f58\n * @create: 2021-04-29 00:04\n **/\npublic class HeartServer {\n\n    private final static Logger logger = LoggerFactory.getLogger(HeartServer.class);\n\n    public static void main(String[] args) throws InterruptedException {\n\n        EventLoopGroup bossGroup = new NioEventLoopGroup();\n        EventLoopGroup workGroup = new NioEventLoopGroup();\n        try {\n            ServerBootstrap bootstrap = new ServerBootstrap();\n            bootstrap\n                    .group(bossGroup, workGroup)\n                    .channel(NioServerSocketChannel.class)\n                    .option(ChannelOption.SO_BACKLOG, 128)\n                    .childOption(ChannelOption.SO_KEEPALIVE, true)\n                    // handler \u5bf9\u5e94\u7684\u662f bossGroup\n                    // childHandler \u5bf9\u5e94\u7684\u662f workGroup\n                    // \u65e5\u5fd7\u5904\u7406\u5668\uff0c\u63d0\u4f9b\u7ed9BossGroup\u6253\u5370\u65e5\u5fd7\n                    .handler(new LoggingHandler(LogLevel.INFO))\n                    .childHandler(new ChannelInitializer<SocketChannel>() {\n                        @Override\n                        protected void initChannel(SocketChannel ch) throws Exception {\n                            // \u52a0\u5165\u7a7a\u95f2\u72b6\u6001\u5904\u7406\u5668\n                            // \u53c2\u6570\u4e00\uff1a\u591a\u5c11\u65f6\u95f4\u6ca1\u6709\u8bfb\u53d6\u6d88\u606f\uff0c\u5c31\u4f1a\u53d1\u9001\u4e00\u4e2a\u5fc3\u8df3\uff0c\u68c0\u6d4b\u662f\u5426\u662f\u8fde\u63a5\u72b6\u6001\n                            // \u53c2\u6570\u4e8c\uff1a          \u5199\n                            // \u53c2\u6570\u4e09\uff1a          \u8bfb\u5199\n                            // \u53c2\u6570\u56db\uff1a\u65f6\u95f4\u5355\u4f4d\n                            // \u5f53 IdleStateHandler \u89e6\u53d1\u540e\uff0c\u4f1a\u4f20\u9012\u7ed9\u901a\u9053\u7684\u4e0b\u4e00\u4e2a handler \u5904\u7406\n                            // \u901a\u8fc7\u8c03\u7528\u4e0b\u4e00\u4e2a handler \u7684 userEventTriggered \u65b9\u6cd5\n                            ch.pipeline().addLast(new IdleStateHandler(3, 5, 7, TimeUnit.SECONDS));\n                            // \u52a0\u5165\u4e00\u4e2a\u5bf9\u7a7a\u95f2\u68c0\u6d4b\u5904\u7406\u7684handler\n                            ch.pipeline().addLast(new HeartHandler());\n                        }\n                    });\n\n            logger.info("\u670d\u52a1\u7aef\u51c6\u5907\u5b8c\u6210");\n\n            ChannelFuture cf = bootstrap.bind(6668).sync();\n\n            cf.addListener(new ChannelFutureListener() {\n                @Override\n                public void operationComplete(ChannelFuture future) throws Exception {\n                    if (cf.isSuccess()) {\n                        logger.info("\u76d1\u542c\u7aef\u53e3 6666 \u6210\u529f");\n                    } else {\n                        logger.error("\u76d1\u542c\u7aef\u53e3 6666 \u5931\u8d25");\n                    }\n                }\n            });\n\n            cf.channel().closeFuture().sync();\n        } finally {\n            bossGroup.shutdownGracefully();\n            workGroup.shutdownGracefully();\n        }\n\n    }\n\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'package io.mvvm.netty.heart;\n\nimport io.netty.channel.ChannelHandlerContext;\nimport io.netty.channel.ChannelInboundHandlerAdapter;\nimport io.netty.handler.timeout.IdleStateEvent;\n\n/**\n * @program: Netty\n * @description: \u7a7a\u95f2\u72b6\u6001\u5904\u7406\u5668\n * @author: \u6f58\n * @create: 2021-04-29 00:18\n **/\npublic class HeartHandler extends ChannelInboundHandlerAdapter {\n    /**\n     * \n     * @param ctx\n     * @param evt   \u4e8b\u4ef6\n     * @throws Exception\n     */\n    @Override\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n        if (evt instanceof IdleStateEvent) {\n            IdleStateEvent ise = (IdleStateEvent) evt;\n            switch (ise.state()) {\n                case READER_IDLE:\n                    System.out.println("\u8bfb\u7a7a\u95f2");\n                    break;\n                case WRITER_IDLE:\n                    System.out.println("\u5199\u7a7a\u95f2");\n                    break;\n                case ALL_IDLE:\n                    System.out.println("\u8bfb\u5199\u7a7a\u95f2");\n                    break;\n            }\n        }\n    }\n}\n')),(0,l.kt)("h2",{id:"websocket"},"WebSocket"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'package io.mvvm.netty.ws;\n\nimport io.netty.bootstrap.ServerBootstrap;\nimport io.netty.channel.*;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.SocketChannel;\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\nimport io.netty.handler.codec.http.HttpObjectAggregator;\nimport io.netty.handler.codec.http.HttpServerCodec;\nimport io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;\nimport io.netty.handler.stream.ChunkedWriteHandler;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n * @program: Netty\n * @description: WebSocketServer\n * @author: \u6f58\n * @create: 2021-04-29 09:24\n **/\npublic class WebSocketServer {\n\n    private final static Logger logger = LoggerFactory.getLogger(WebSocketServer.class);\n\n    public static void main(String[] args) throws InterruptedException {\n\n        EventLoopGroup bossGroup = new NioEventLoopGroup();\n        EventLoopGroup workGroup = new NioEventLoopGroup();\n        try {\n\n            ServerBootstrap bootstrap = new ServerBootstrap();\n            bootstrap\n                    .group(bossGroup, workGroup)\n                    .channel(NioServerSocketChannel.class)\n                    .option(ChannelOption.SO_BACKLOG, 128)\n                    .childOption(ChannelOption.SO_KEEPALIVE, true)\n                    .childHandler(new ChannelInitializer<SocketChannel>() { // \u521b\u5efa\u4e00\u4e2a\u901a\u9053\u521d\u59cb\u5316\u5bf9\u8c61\n                        @Override\n                        protected void initChannel(SocketChannel ch) throws Exception {\n                            // Http\u534f\u8bae\u7f16\u89e3\u7801\u5668\n                            ch.pipeline().addLast(new HttpServerCodec());\n                            // \u4ee5\u5757\u65b9\u5f0f\u5199,\u5bf9\u5927\u6570\u636e\u6d41\u7684\u652f\u6301\uff0c\u4f8b\u5982\u6587\u4ef6\u4f20\u8f93\n                            ch.pipeline().addLast(new ChunkedWriteHandler());\n                            // \u5c06\u591a\u4e2a\u6570\u636e\u6bb5\u805a\u5408\u8d77\u6765\uff0c\u5982\u679c\u53d1\u9001\u5927\u6587\u672c\u6570\u636e\u907f\u514d\u8bf7\u6c42\u591a\u6b21\n                            ch.pipeline().addLast(new HttpObjectAggregator(8192));\n                            // \u5904\u7406WebSocket\u63e1\u624b\u4ee5\u53ca\u5904\u7406\u63a7\u5236\u5e27\n                            ch.pipeline().addLast(new WebSocketServerProtocolHandler("/ws"));\n\n                            // \u81ea\u5b9a\u4e49Handler\n                            ch.pipeline().addLast(new WebSocketMessageHandler());\n                        }\n                    });\n\n            ChannelFuture cf = bootstrap.bind(5566).sync();\n            cf.channel().closeFuture().sync();\n        } finally {\n            bossGroup.shutdownGracefully();\n            workGroup.shutdownGracefully();\n        }\n\n    }\n\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'package io.mvvm.netty.ws;\n\nimport io.netty.channel.ChannelHandler;\nimport io.netty.channel.ChannelHandlerContext;\nimport io.netty.channel.SimpleChannelInboundHandler;\nimport io.netty.handler.codec.http.websocketx.TextWebSocketFrame;\n\n/**\n * @program: Netty\n * @description: \u6d88\u606f\u5904\u7406\u5668, <TextWebSocketFrame> \u8868\u793a\u4e00\u4e2a\u6587\u672c\u5e27\n * @author: \u6f58\n * @create: 2021-04-29 09:41\n **/\n@ChannelHandler.Sharable\npublic class WebSocketMessageHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {\n\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("\u5ba2\u6237\u7aef\u5df2\u8fde\u63a5");\n    }\n\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception {\n        // \u6536\u5230\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6d88\u606f\n        System.out.println(msg.text());\n\n        // \u5411\u5ba2\u6237\u7aef\u56de\u590d\u6d88\u606f\n        ctx.channel().writeAndFlush(new TextWebSocketFrame("Hello WebSocket : " + msg.text()));\n        \n        // \u52a8\u6001\u5220\u9664\u5f53\u524d\u5904\u7406\u5668\n        ctx.pipeline().remove(this);\n\n    }\n\n    @Override\n    public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("\u5ba2\u6237\u7aef\u65ad\u5f00\u8fde\u63a5");\n    }\n\n    @Override\n    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("\u5904\u7406\u5668\u5df2\u6dfb\u52a0");\n    }\n\n    @Override\n    public void handlerRemoved(ChannelHandlerContext ctx) throws Exception {\n        System.out.println("\u5904\u7406\u5668\u88ab\u79fb\u9664");\n    }\n\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n        System.out.println("\u53d1\u751f\u5f02\u5e38" + cause.getMessage());\n        ctx.close();\n    }\n}\n\n')),(0,l.kt)("h2",{id:"encoder--decoder"},"Encoder & Decoder"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u7f51\u7edc\u5e94\u7528\u7a0b\u5e8f\u5728\u6570\u636e\u4f20\u8f93\u65f6\u91c7\u7528\u4e8c\u8fdb\u5236\u5b57\u8282\u7801\u6570\u636e\uff0c\u6240\u4ee5\u5728\u53d1\u9001\u6570\u636e\u65f6\u9700\u8981\u7f16\u7801\uff0c\u63a5\u6536\u6570\u636e\u65f6\u9700\u8981\u89e3\u7801"),(0,l.kt)("p",{parentName:"blockquote"},"codec (\u7f16\u89e3\u7801\u5668)\u5206\u522b\u8868\u793a\uff1aDecoder(\u89e3\u7801\u5668)\u3001Encoder(\u7f16\u7801\u5668)")),(0,l.kt)("h3",{id:"netty-\u7684\u7f16\u89e3\u7801\u5668"},"Netty \u7684\u7f16\u89e3\u7801\u5668"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"StringEncoder & StringDecoder > String \u7c7b\u578b\u6570\u636e\u7684\u7f16\u89e3\u7801\u5668"),(0,l.kt)("li",{parentName:"ul"},"ObjectEncoder & ObjectDecoder > Java \u5bf9\u8c61\u7684\u7f16\u89e3\u7801\u5668")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Netty \u63d0\u4f9b\u7684 Object \u7f16\u89e3\u7801\u5668\u91c7\u7528\u7684\u662fJava\u7684\u5e8f\u5217\u5316\u65b9\u5f0f\uff0c\u56e0\u6b64\u5c31\u5b58\u5728\u6548\u7387\u4f4e\u3001\u65e0\u6cd5\u8de8\u8bed\u8a00\u3001\u4f53\u79ef\u5927\u7b49\u95ee\u9898")),(0,l.kt)("h3",{id:"google-protobuf"},"Google Protobuf"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Protobuf \u662f\u4e00\u79cd\u8f7b\u4fbf\u9ad8\u6548\u7684\u7ed3\u6784\u5316\u6570\u636e\u5b58\u50a8\u683c\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e8e\u7ed3\u6784\u5316\u6570\u636e\u4e32\u884c\u5316(\u5e8f\u5217\u5316)")),(0,l.kt)("h2",{id:"\u7c98\u5305--\u534a\u5305"},"\u7c98\u5305 & \u534a\u5305"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"TCP \u662f\u9762\u5411\u6d41\u7684\uff0c\u63d0\u4f9b\u9ad8\u53ef\u9760\u6027\u670d\u52a1\u3002\u6536\u53d1\u4e24\u7aef\u90fd\u8981\u6709\u6210\u5bf9\u7684 Socket"),(0,l.kt)("p",{parentName:"blockquote"},"\u56e0\u6b64\u53d1\u9001\u7aef\u4e3a\u4e86\u5c06\u591a\u4e2a\u53d1\u7ed9\u63a5\u6536\u7aef\u7684\u5305\uff0c\u66f4\u6709\u6548\u7684\u53d1\u9001\u7ed9\u5bf9\u65b9\uff0c\u4f7f\u7528\u4e86 Nagle \u7b97\u6cd5\u4f18\u5316"),(0,l.kt)("p",{parentName:"blockquote"},"\u5c06\u591a\u6b21\u95f4\u9694\u8f83\u5c0f\u4e14\u6570\u91cf\u5c0f\u7684\u6570\u636e\uff0c\u5408\u5e76\u4e3a\u4e00\u4e2a\u5927\u7684\u6570\u636e\u5757\uff0c\u7136\u540e\u8fdb\u884c\u5c01\u5305\uff0c"),(0,l.kt)("p",{parentName:"blockquote"},"\u8fd9\u6837\u867d\u7136\u63d0\u9ad8\u4e86\u6548\u7387\uff0c\u4f46\u662f\u63a5\u6536\u7aef\u5c31\u96be\u4ee5\u5206\u8fa8\u51fa\u5b8c\u6574\u7684\u6570\u636e\u5305\u4e86\uff0c\u56e0\u4e3a\u9762\u5411\u6d41\u7684\u901a\u4fe1\u662f\u65e0\u6d88\u606f\u4fdd\u62a4\u8fb9\u754c\u7684")),(0,l.kt)("h3",{id:"\u7c98\u5305"},"\u7c98\u5305"),(0,l.kt)("h4",{id:"\u73b0\u8c61"},"\u73b0\u8c61"),(0,l.kt)("p",null,"\u53d1\u9001 ",(0,l.kt)("inlineCode",{parentName:"p"},"abc")," ",(0,l.kt)("inlineCode",{parentName:"p"},"def"),"\uff0c\u63a5\u6536\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"abcdef")),(0,l.kt)("h4",{id:"\u539f\u56e0"},"\u539f\u56e0"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5e94\u7528\u5c42\uff1a\u63a5\u6536\u65b9 ByteBuf \u8bbe\u7f6e\u592a\u5927\uff08Netty\u9ed8\u8ba41024\uff09"),(0,l.kt)("li",{parentName:"ul"},"\u6ed1\u52a8\u7a97\u53e3\uff1a\u5047\u8bbe\u53d1\u9001\u65b9256bytes\u8868\u793a\u4e00\u4e2a\u5b8c\u6574\u7684\u62a5\u6587\uff0c\u4f46\u7531\u4e8e\u63a5\u6536\u65b9\u5904\u7406\u4e0d\u53ca\u65f6\u4e14\u7a97\u53e3\u5927\u5c0f\u8db3\u591f\u5927\uff0c\u8fd9256bytes\u5b57\u8282\u5c31\u4f1a\u7f13\u51b2\u5728\u63a5\u6536\u65b9\u7684\u6ed1\u52a8\u7a97\u53e3\u4e2d\uff0c\u5f53\u6ed1\u52a8\u7a97\u53e3\u4e2d\u7f13\u51b2\u4e86\u591a\u4e2a\u62a5\u6587\u5c31\u4f1a\u51fa\u73b0\u7c98\u5305"),(0,l.kt)("li",{parentName:"ul"},"Nagle \u7b97\u6cd5")),(0,l.kt)("h3",{id:"\u534a\u5305"},"\u534a\u5305"),(0,l.kt)("h4",{id:"\u73b0\u8c61-1"},"\u73b0\u8c61"),(0,l.kt)("p",null,"\u53d1\u9001 ",(0,l.kt)("inlineCode",{parentName:"p"},"abcdef")," \u63a5\u6536 ",(0,l.kt)("inlineCode",{parentName:"p"},"abc")," ",(0,l.kt)("inlineCode",{parentName:"p"},"de")," ",(0,l.kt)("inlineCode",{parentName:"p"},"f")),(0,l.kt)("h4",{id:"\u539f\u56e0-1"},"\u539f\u56e0"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5e94\u7528\u5c42\uff1a\u63a5\u6536\u65b9 ByteBuf \u5c0f\u4e8e\u5b9e\u9645\u53d1\u9001\u6570\u636e\u7684\u6570\u91cf"),(0,l.kt)("li",{parentName:"ul"},"\u6ed1\u52a8\u7a97\u53e3\uff1a\u52a0\u6d89\u63a5\u6536\u65b9\u7684\u7a97\u53e3\u53ea\u5269128bytes\uff0c\u53d1\u9001\u65b9\u7684\u62a5\u6587\u5927\u5c0f\u662f256bytes\uff0c\u8fd9\u65f6\u653e\u4e0d\u4e0b\u4e86\uff0c\u53ea\u80fd\u5148\u53d1\u9001\u524d128bytes\uff0c\u7b49\u5f85ack\u540e\u624d\u80fd\u53d1\u9001\u5269\u4f59\u90e8\u5206\uff0c\u8fd9\u5c31\u9020\u6210\u534a\u5305"),(0,l.kt)("li",{parentName:"ul"},"MSS\u9650\u5236\uff1a\u5f53\u53d1\u9001\u7684\u6570\u636e\u8349\u679c MSS \u9650\u5236\u540e\uff0c\u4f1a\u5c06\u6570\u636e\u5207\u5206\u53d1\u9001\uff0c\u5c31\u4f1a\u7167\u6210\u534a\u5305")),(0,l.kt)("h3",{id:"\u7c98\u5305\u534a\u5305\u6f14\u793a"},"\u7c98\u5305\u534a\u5305\u6f14\u793a"),(0,l.kt)("h4",{id:"\u670d\u52a1\u7aef-1"},"\u670d\u52a1\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        ByteBuf buf = (ByteBuf) msg;\n        logger.info("\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6d88\u606f\u662f : {}", buf.toString(CharsetUtil.UTF_8));\n    }\n')),(0,l.kt)("h4",{id:"\u5ba2\u6237\u7aef-1"},"\u5ba2\u6237\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        for (int i = 0; i < 10; i++) {\n            ByteBuf buf = Unpooled.copiedBuffer("Hello Client" + i, CharsetUtil.UTF_8);\n            ctx.writeAndFlush(buf);\n        }\n    }\n')),(0,l.kt)("h4",{id:"\u7ed3\u679c\u6253\u5370"},"\u7ed3\u679c\u6253\u5370"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-log"},"[nioEventLoopGroup-3-1] INFO io.mvvm.netty.decoder.NettyServerHandler - \u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6d88\u606f\u662f : Hello Client0Hello Client1Hello Client2Hello Client3Hello Client4Hello Client5Hello Client6Hello Client7Hello Client8Hello Client9\n")),(0,l.kt)("h4",{id:"\u7ed3\u8bba"},"\u7ed3\u8bba"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u4ee3\u7801\u89e3\u91ca"),(0,l.kt)("p",{parentName:"blockquote"},"\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u5faa\u73af\u5411\u670d\u52a1\u7aef\u53d1\u900110\u6761\u6d88\u606f"),(0,l.kt)("p",{parentName:"blockquote"},"\u671f\u671b\u7ed3\u679c"),(0,l.kt)("p",{parentName:"blockquote"},"\u670d\u52a1\u7aef\u6536\u523010\u6761\u6d88\u606f"),(0,l.kt)("p",{parentName:"blockquote"},"\u5b9e\u9645\u7ed3\u679c"),(0,l.kt)("p",{parentName:"blockquote"},"\u670d\u52a1\u7aef\u5c0610\u6761\u6d88\u606f\u653e\u5728\u4e00\u8d77\u6210\u4e3a\u4e86\u4e00\u6761\u6d88\u606f\uff0c\u8fd9\u5c31\u662f\u7c98\u5305\u73b0\u8c61")),(0,l.kt)("h3",{id:"\u89e3\u51b3\u65b9\u6848"},"\u89e3\u51b3\u65b9\u6848"),(0,l.kt)("h4",{id:"\u77ed\u8fde\u63a5"},"\u77ed\u8fde\u63a5"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5efa\u7acb\u8fde\u63a5\u540e\u53ea\u53d1\u9001\u4e00\u6b21\u6d88\u606f\uff0c\u53d1\u9001\u6d88\u606f\u5b8c\u6bd5\u540e\u65ad\u5f00\u8fde\u63a5"),(0,l.kt)("p",{parentName:"blockquote"},"\u7f3a\u70b9\uff1a\u4e0d\u5982\u7528http")),(0,l.kt)("h4",{id:"\u5b9a\u957f\u89e3\u7801\u5668-fixedlengthframedecoder"},"\u5b9a\u957f\u89e3\u7801\u5668 FixedLengthFrameDecoder"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5b9a\u5e38\u89e3\u7801\u5668\u5373\u56fa\u5b9a\u6bcf\u6761\u6d88\u606f\u7684\u56fa\u5b9a\u957f\u5ea6\uff0c\u5982\u679c\u6d88\u606f\u957f\u5ea6\u5c0f\u4e8e\u5b9a\u957f\u7684\u957f\u5ea6\uff0c\u5219\u8fdb\u884c\u8865\u4f4d\u5230\u5b9a\u957f\u957f\u5ea6"),(0,l.kt)("p",{parentName:"blockquote"},"\u4f18\u70b9\uff1a\u89e3\u51b3\u4e86\u77ed\u8fde\u63a5\u7684\u95ee\u9898"),(0,l.kt)("p",{parentName:"blockquote"},"\u7f3a\u70b9\uff0c\u589e\u52a0\u6d88\u606f\u4f53\u79ef\uff0c\u9010\u4e00\u5339\u914d\u5b57\u7b26\u6548\u7387\u4f4e")),(0,l.kt)("h5",{id:"\u670d\u52a1\u7aef-2"},"\u670d\u52a1\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u5b9a\u957f\u89e3\u7801\u5668,\u53c2\u6570\u4e3a\uff1a\u5e27\u7684\u957f\u5ea6\nch.pipeline().addLast(new FixedLengthFrameDecoder(10));\n")),(0,l.kt)("h5",{id:"\u5ba2\u6237\u7aef-2"},"\u5ba2\u6237\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        ByteBuf buffer = ctx.alloc().buffer();\n        char c = '0';\n        Random r = new Random();\n        for (int i = 0; i < 10; i++) {\n            byte[] bytes = getBytes(c, r.nextInt(9) + 1);\n            buffer.writeBytes(bytes);\n            c++;\n        }\n        ctx.writeAndFlush(buffer);\n    }\n\n    private static byte[] getBytes(char c, int i) {\n        StringBuilder sb = new StringBuilder();\n        for (int i1 = 0; i1 < i; i1++) {\n            sb.append(c);\n        }\n        int length = sb.length();\n        for (int i1 = 0; i1 < 10 - length; i1++) {\n            sb.append(\"-\");\n        }\n        System.out.println(sb.toString());\n        return sb.toString().getBytes(StandardCharsets.UTF_8);\n    }\n")),(0,l.kt)("h4",{id:"\u884c\u89e3\u7801\u5668-linebasedframedecoder"},"\u884c\u89e3\u7801\u5668 LineBasedFrameDecoder"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"public LineBasedFrameDecoder(final int maxLength)"),(0,l.kt)("p",{parentName:"blockquote"},"\u53c2\u6570maxLength\u8868\u793a\u8bbe\u7f6e\u4e00\u4e2a\u6700\u5927\u6d88\u606f\u957f\u5ea6\uff0c\u5982\u679c\u6d88\u606f\u8d85\u8fc7\u8fd9\u4e2a\u957f\u5ea6\u8fd8\u672a\u627e\u5230\u5206\u9694\u7b26\uff0c\u5219\u4f1a\u629b\u51fa",(0,l.kt)("inlineCode",{parentName:"p"},"TooLongFrameException"),"\u5f02\u5e38"),(0,l.kt)("p",{parentName:"blockquote"},"public DelimiterBasedFrameDecoder(int maxFrameLength, ByteBuf... delimiters)"),(0,l.kt)("p",{parentName:"blockquote"},"\u548c\u4e0a\u9762\u90a3\u4e2a\u7684\u533a\u522b\u5c31\u662f\uff0cLineBasedFrameDecoder\u91c7\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"\\\\r\\\\n")," \u5b9e\u73b0\u5206\u5272"),(0,l.kt)("p",{parentName:"blockquote"},"DelimiterBasedFrameDecoder\u91c7\u7528\u81ea\u5b9a\u4e49\u5206\u9694\u7b26"),(0,l.kt)("p",{parentName:"blockquote"},"\u6bcf\u6761\u6d88\u606f\u91c7\u7528\u7279\u5b9a\u7684\u5206\u9694\u7b26\u8fdb\u884c\u5206\u5272\uff0c\u4f8b\u5982 ",(0,l.kt)("inlineCode",{parentName:"p"},"\\\\n")),(0,l.kt)("p",{parentName:"blockquote"},"\u4f18\u70b9: \u89e3\u51b3\u4e86\u5b9a\u957f\u89e3\u7801\u5668\u7684\u8865\u4f4d\u95ee\u9898"),(0,l.kt)("p",{parentName:"blockquote"},"\u7f3a\u70b9\uff1a\u9010\u4e00\u5339\u914d\u5b57\u7b26\uff0c\u6548\u7387\u4f4e")),(0,l.kt)("h5",{id:"\u670d\u52a1\u7aef-3"},"\u670d\u52a1\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"// \u884c\u89e3\u7801\u5668\nch.pipeline().addLast(new LineBasedFrameDecoder(1024));\n")),(0,l.kt)("h5",{id:"\u5ba2\u6237\u7aef-3"},"\u5ba2\u6237\u7aef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        ByteBuf buffer = ctx.alloc().buffer();\n        char c = '0';\n        Random r = new Random();\n        for (int i = 0; i < 10; i++) {\n            byte[] bytes = getBytes(c, r.nextInt(256) + 1);\n            buffer.writeBytes(bytes);\n            c++;\n        }\n        ctx.writeAndFlush(buffer);\n    }\n    private static byte[] getBytes(char c, int i) {\n        StringBuilder sb = new StringBuilder();\n        for (int i1 = 0; i1 < i; i1++) {\n            sb.append(c);\n        }\n        sb.append(\"\\n\");\n        System.out.println(sb.toString());\n        return sb.toString().getBytes(StandardCharsets.UTF_8);\n    }\n")),(0,l.kt)("h4",{id:"let-\u89e3\u7801\u5668-lengthfieldbasedframedecoder"},"LET \u89e3\u7801\u5668 LengthFieldBasedFrameDecoder"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u57fa\u4e8e\u957f\u5ea6\u5b57\u6bb5\u5e27\u7684\u89e3\u7801\u5668\n *\n * maxFrameLength: \u5e27\u7684\u6700\u5927\u957f\u5ea6\uff0c\u5982\u679c\u8d85\u51fa\u6b64\u957f\u5ea6\u4f1a\u629b\u51faTooLongFrameException\u5f02\u5e38\n * lengthFieldOffset: \u957f\u5ea6\u5b57\u6bb5\u504f\u79fb\u91cf\uff0c(\u5373\u504f\u79fb\u591a\u5c11\u53ef\u4ee5\u8bfb\u5230\u957f\u5ea6)\n * lengthFieldLength: \u957f\u5ea6\u5b57\u6bb5\u957f\u5ea6\uff0c(\u957f\u5ea6\u6709\u591a\u5c11\u4e2a\u5b57\u8282)\n * lengthAdjustment: \u957f\u5ea6\u5b57\u6bb5\u4e3a\u57fa\u51c6\uff0c\u8fd8\u6709\u591a\u5c11\u5b57\u8282\u5185\u5bb9\n * initialBytesToStrip: \u4ece\u5934\u53bb\u9664\u51e0\u4e2a\u5b57\u8282\uff0c(\u4f8b\u5982\uff0c\u957f\u5ea6\u662f4\u4e2a\u5b57\u8282\uff0c\u53bb\u9664\u957f\u5ea6\uff0c\u5219\u503c\u4e3a4)\n */\npublic LengthFieldBasedFrameDecoder(\n            int maxFrameLength,\n            int lengthFieldOffset, int lengthFieldLength,\n            int lengthAdjustment, int initialBytesToStrip){}\n")),(0,l.kt)("h5",{id:"\u6d4b\u8bd5"},"\u6d4b\u8bd5"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"EmbeddedChannel\u7528\u6765\u6d4b\u8bd5\u5904\u7406\u5668")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'\n    public static void main(String[] args) {\n        EmbeddedChannel channel = new EmbeddedChannel(\n                new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4),\n                new LoggingHandler(LogLevel.INFO)\n        );\n\n        ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();\n        send(buf, "Hello");\n        send(buf, "Hi");\n        send(buf, "Test");\n\n        channel.writeInbound(buf);\n    }\n\n    private static void send(ByteBuf buf, String msg) {\n        byte[] bytes = msg.getBytes(StandardCharsets.UTF_8);\n        int length = bytes.length;\n        buf.writeInt(length); // \u5199\u5165\u6d88\u606f\u957f\u5ea6\n        buf.writeBytes(bytes); // \u5199\u5165\u6d88\u606f\u5185\u5bb9\n    }\n')),(0,l.kt)("h2",{id:"\u534f\u8bae\u8bbe\u8ba1\u4e0e\u89e3\u6790"},"\u534f\u8bae\u8bbe\u8ba1\u4e0e\u89e3\u6790"),(0,l.kt)("h3",{id:"\u81ea\u5b9a\u4e49\u534f\u8bae\u8981\u7d20"},"\u81ea\u5b9a\u4e49\u534f\u8bae\u8981\u7d20"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u9b54\u672f\uff1a\u7528\u6765\u5728\u7b2c\u4e00\u4e8b\u4ef6\u5224\u65ad\u662f\u5426\u662f\u65e0\u6548\u6570\u636e\u5305"),(0,l.kt)("li",{parentName:"ul"},"\u7248\u672c\u53f7\uff1a\u53ef\u4ee5\u652f\u6301\u534f\u8bae\u7684\u5347\u7ea7"),(0,l.kt)("li",{parentName:"ul"},"\u5e8f\u5217\u5316\u7b97\u6cd5\uff1a\u6d88\u606f\u6b63\u6587\u91c7\u7528\u54ea\u79cd\u5e8f\u5217\u5316\u65b9\u5f0f\uff0c\u4f8b\u5982\uff1ajson\u3001protobuf\u3001hessian\u3001jdk"),(0,l.kt)("li",{parentName:"ul"},"\u6307\u4ee4\u7c7b\u578b\uff1a\u662f\u767b\u9646\u3001\u6ce8\u518c\u3001\u5355\u804a\u3001\u7fa4\u804a...\u548c\u4e1a\u52a1\u76f8\u5173"),(0,l.kt)("li",{parentName:"ul"},"\u8bf7\u6c42\u5e8f\u53f7\uff1a\u4e3a\u4e86\u53cc\u5de5\u901a\u4fe1\uff0c\u63d0\u4f9b\u5f02\u6b65\u80fd\u529b"),(0,l.kt)("li",{parentName:"ul"},"\u6b63\u6587\u957f\u5ea6"),(0,l.kt)("li",{parentName:"ul"},"\u6d88\u606f\u6b63\u6587")),(0,l.kt)("h3",{id:"\u81ea\u5b9a\u4e49\u534f\u8bae\u7f16\u89e3\u7801\u5b9e\u73b0"},"\u81ea\u5b9a\u4e49\u534f\u8bae\u7f16\u89e3\u7801\u5b9e\u73b0"),(0,l.kt)("h4",{id:"messagecodec"},"MessageCodec"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"import io.mvvm.netty.codec.entity.Message;\nimport io.netty.buffer.ByteBuf;\nimport io.netty.channel.ChannelHandlerContext;\nimport io.netty.handler.codec.ByteToMessageCodec;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.ByteArrayOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.util.List;\n\npublic class MessageCodec extends ByteToMessageCodec<Message> {\n\n    @Override\n    public void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception {\n        // 1. \u9b54\u6570\uff0c4\u5b57\u8282\n        out.writeBytes(new byte[]{1, 2, 3, 4});\n        // 2. \u7248\u672c\uff0c1\u5b57\u8282\n        out.writeByte(1);\n        // 3. \u5e8f\u5217\u5316\u7b97\u6cd5(0:jdk, 1:json)\uff0c1\u5b57\u8282\n        out.writeByte(0);\n        // 4. \u6307\u4ee4\u7c7b\u578b\uff0c1\u5b57\u8282\n        out.writeByte(msg.getMessageType());\n        // 5. \u8bf7\u6c42\u5e8f\u53f7\uff0c4\u4e2a\u5b57\u8282\n        out.writeByte(msg.getSequenceId());\n        // \u65e0\u610f\u4e49\uff0c\u5bf9\u9f50\u586b\u5145\uff0c\u4fdd\u63012\u7684\u500d\u6570\n        out.writeByte(0xff);\n        // 6. \u83b7\u53d6\u5185\u5bb9\u7684\u5b57\u8282\u6570\u7ec4\n        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n        ObjectOutputStream oos = new ObjectOutputStream(bos);\n        oos.writeObject(msg);\n        byte[] bytes = bos.toByteArray();\n        // 7. \u957f\u5ea6\uff0c4\u5b57\u8282\n        out.writeInt(bytes.length);\n        // 8. \u5199\u5165\u5185\u5bb9\n        out.writeBytes(bytes);\n    }\n\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\n        // 1. \u9b54\u672f\uff0c4\u5b57\u8282\n        int magicNum = in.readInt();\n        // 2. \u7248\u672c\uff0c1\u5b57\u8282\n        byte version = in.readByte();\n        // 3. \u5e8f\u5217\u5316\u7b97\u6cd5(0:jdk, 1:json)\uff0c1\u5b57\u8282\n        byte serializerAlgorithm = in.readByte();\n        // 4. \u6307\u4ee4\u7c7b\u578b\uff0c1\u5b57\u8282\n        byte messageType = in.readByte();\n        // 5. \u8bf7\u6c42\u5e8f\u53f7\uff0c4\u4e2a\u5b57\u8282\n        int sequenceId = in.readInt();\n        // \u65e0\u610f\u4e49\uff0c\u5bf9\u9f50\u586b\u5145\uff0c\u4fdd\u63012\u7684\u500d\u6570\n        in.readByte();\n        // 6. \u957f\u5ea6\uff0c4\u5b57\u8282\n        int length = in.readInt();\n        // 7. \u8bfb\u53d6\u5185\u5bb9\n        byte[] bytes = new byte[length];\n        // \u7f13\u51b2\u533a\uff0c\u5f00\u59cb\uff0c\u7ed3\u675f\n        in.readBytes(bytes, 0, length);\n        ObjectInputStream stream = new ObjectInputStream(new ByteArrayInputStream(bytes));\n        Message message = (Message) stream.readObject();\n\n        \n        out.add(message);\n    }\n}\n")),(0,l.kt)("h4",{id:"message"},"Message"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"import java.io.Serializable;\n\npublic abstract class Message implements Serializable {\n\n    private int messageType;\n    private int sequenceId;\n\n    public abstract int getMessageType();\n\n    public static final int LoginRequestMessage = 0;\n\n    public int getSequenceId() {\n        setSequenceId(1);\n        return sequenceId;\n    }\n\n    public void setSequenceId(int sequenceId) {\n        this.sequenceId = sequenceId;\n    }\n\n}\n")),(0,l.kt)("h4",{id:"loginrequestmessage"},"LoginRequestMessage"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"public class LoginRequestMessage extends Message{\n\n    private String username;\n    private String password;\n    private String nickname;\n\n    public LoginRequestMessage() {\n    }\n\n    public LoginRequestMessage(String username, String password, String nickname) {\n        this.username = username;\n        this.password = password;\n        this.nickname = nickname;\n    }\n\n    @Override\n    public int getMessageType() {\n        return LoginRequestMessage;\n    }\n\n    public String getUsername() {\n        return username;\n    }\n\n    public void setUsername(String username) {\n        this.username = username;\n    }\n\n    public String getPassword() {\n        return password;\n    }\n\n    public void setPassword(String password) {\n        this.password = password;\n    }\n\n    public String getNickname() {\n        return nickname;\n    }\n\n    public void setNickname(String nickname) {\n        this.nickname = nickname;\n    }\n}\n")),(0,l.kt)("h4",{id:"main"},"main"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    public static void main(String[] args) throws Exception {\n        EmbeddedChannel channel = new EmbeddedChannel(\n                // \u6700\u5927\u957f\u5ea6\uff0c\u504f\u79fb\u91cf\uff0c\u5b58\u50a8\u5185\u5bb9\u957f\u5ea6\u7684\u957f\u5ea6\uff0c\u8865\u507f\u51e0\u4e2a\u5b57\u8282\u5230\u957f\u5ea6\u4f4d\u7f6e\uff0c\u53bb\u9664\u591a\u5c11\u5b57\u8282\u5185\u5bb9\n                new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0),\n                new LoggingHandler(LogLevel.INFO),\n                new MessageCodec()\n        );\n\n        // encoder\n        Message message = new LoginRequestMessage("root", "123456", "zhangsan");\n        channel.writeOutbound(message);\n\n        // decoder\n        Message message1 = new LoginRequestMessage("root", "123456", "zhangsan");\n        ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();\n        new MessageCodec().encode(null, message1, buf);\n\n        // \u5165\u7ad9\n        channel.writeInbound(buf);\n    }\n')))}s.isMDXComponent=!0}}]);