"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[4966],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>k});var a=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,r=e.originalType,p=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=s(t),u=l,k=c["".concat(p,".").concat(u)]||c[u]||m[u]||r;return t?a.createElement(k,i(i({ref:n},d),{},{components:t})):a.createElement(k,i({ref:n},d))}));function k(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var r=t.length,i=new Array(r);i[0]=u;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o[c]="string"==typeof e?e:l,i[1]=o;for(var s=2;s<r;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2306:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>o,toc:()=>s});var a=t(7462),l=(t(7294),t(3905));const r={},i="Nginx",o={unversionedId:"\u540e\u7aef/Nginx",id:"\u540e\u7aef/Nginx",title:"Nginx",description:"\u5b89\u88c5\u4e0e\u542f\u52a8",source:"@site/docs/\u540e\u7aef/Nginx.md",sourceDirName:"\u540e\u7aef",slug:"/\u540e\u7aef/Nginx",permalink:"/docs/\u540e\u7aef/Nginx",draft:!1,editUrl:"https://github.com/pannanxu/wiki/docs/\u540e\u7aef/Nginx.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Netty",permalink:"/docs/\u540e\u7aef/Netty"},next:{title:"Shell",permalink:"/docs/\u540e\u7aef/Shell"}},p={},s=[{value:"\u5b89\u88c5\u4e0e\u542f\u52a8",id:"\u5b89\u88c5\u4e0e\u542f\u52a8",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:3},{value:"Debian",id:"debian",level:4},{value:"\u5e38\u7528\u547d\u4ee4",id:"\u5e38\u7528\u547d\u4ee4",level:3},{value:"\u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e\u6587\u4ef6",level:3},{value:"nginx server conf",id:"nginx-server-conf",level:3},{value:"\u9759\u6001\u7f51\u9875\u8f6c\u53d1",id:"\u9759\u6001\u7f51\u9875\u8f6c\u53d1",level:2},{value:"listen",id:"listen",level:4},{value:"server_name",id:"server_name",level:4},{value:"location",id:"location",level:4},{value:"\u4fee\u9970\u7b26",id:"\u4fee\u9970\u7b26",level:5},{value:"index",id:"index",level:5},{value:"HTTP \u53cd\u5411\u4ee3\u7406",id:"http-\u53cd\u5411\u4ee3\u7406",level:2},{value:"location",id:"location-1",level:4},{value:"proxy_pass",id:"proxy_pass",level:4},{value:"\u8bbe\u7f6e\u4ee3\u7406\u8bf7\u6c42 Header",id:"\u8bbe\u7f6e\u4ee3\u7406\u8bf7\u6c42-header",level:3},{value:"HTTPS \u914d\u7f6e",id:"https-\u914d\u7f6e",level:2},{value:"\u751f\u6210\u8bc1\u4e66",id:"\u751f\u6210\u8bc1\u4e66",level:3},{value:"\u914d\u7f6e SSL",id:"\u914d\u7f6e-ssl",level:3},{value:"\u91cd\u5b9a\u5411",id:"\u91cd\u5b9a\u5411",level:2},{value:"break",id:"break",level:3},{value:"last",id:"last",level:3},{value:"\u7f13\u5b58",id:"\u7f13\u5b58",level:2},{value:"\u8d1f\u8f7d\u5747\u8861",id:"\u8d1f\u8f7d\u5747\u8861",level:2},{value:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565",id:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565",level:3},{value:"\u8f6e\u5faa\u673a\u5236\uff08round-robin\uff09",id:"\u8f6e\u5faa\u673a\u5236round-robin",level:4},{value:"\u6700\u5c0f\u8fde\u63a5\uff08least-connected \uff09",id:"\u6700\u5c0f\u8fde\u63a5least-connected-",level:4},{value:"ip-hash",id:"ip-hash",level:4},{value:"hash",id:"hash",level:4},{value:"\u968f\u673a(random\uff09",id:"\u968f\u673arandom",level:4},{value:"\u6743\u91cd\uff08weight\uff09",id:"\u6743\u91cdweight",level:4},{value:"\u5065\u5eb7\u68c0\u67e5",id:"\u5065\u5eb7\u68c0\u67e5",level:4},{value:"TCP \u53cd\u5411\u4ee3\u7406",id:"tcp-\u53cd\u5411\u4ee3\u7406",level:2},{value:"TCP \u8d1f\u8f7d\u5747\u8861",id:"tcp-\u8d1f\u8f7d\u5747\u8861",level:3}],d={toc:s},c="wrapper";function m(e){let{components:n,...t}=e;return(0,l.kt)(c,(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"nginx"},"Nginx"),(0,l.kt)("h2",{id:"\u5b89\u88c5\u4e0e\u542f\u52a8"},"\u5b89\u88c5\u4e0e\u542f\u52a8"),(0,l.kt)("h3",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"yum -y install gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel\nwget http://nginx.org/download/nginx-1.16.1.tar.gz\ntar -zxvf nginx-1.16.1.tar.gz\nln -s nginx-1.16.1 nginx\ncd nginx\n./configure --prefix=/usr/local/nginx --with-http_realip_module --with-http_ssl_module\nmake && make install\n")),(0,l.kt)("h4",{id:"debian"},"Debian"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo wget https://nginx.org/keys/nginx_signing.key\nsudo apt-key add nginx_signing.key\n\nsudo vim /etc/apt/sources.list\n> deb http://nginx.org/packages/mainline/debian/ bullseye nginx\n> deb-src http://nginx.org/packages/mainline/debian/ bullseye nginx\n\nsudo apt update\nsudo apt install nginx\n\nsudo nginx -v\n\ncat /etc/nginx/nginx.conf\n")),(0,l.kt)("h3",{id:"\u5e38\u7528\u547d\u4ee4"},"\u5e38\u7528\u547d\u4ee4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"cd /usr/local/nginx/sbin\n## \u542f\u52a8\n./nginx -c /usr/local/nginx/conf/nginx.conf\n## \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u5e76\u542f\u52a8\n./nginx -s reload\n## \u91cd\u542fnginx\n./nginx -s reopen\n## \u5f3a\u5236\u505c\u6b62\n./nginx -s stop\n## \u4f18\u96c5\u505c\u6b62\n./nginx -s quit\n## \u6d4b\u8bd5\u3001\u68c0\u6d4b\u914d\u7f6e\n./nginx -t\n")),(0,l.kt)("h3",{id:"\u914d\u7f6e\u6587\u4ef6"},"\u914d\u7f6e\u6587\u4ef6"),(0,l.kt)("p",null,"nginx \u4f1a\u81ea\u52a8\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/nginx/conf.d/")," \u8def\u5f84\u4e0b\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},".conf")," \u914d\u7f6e\u6587\u4ef6\u5bfc\u5165"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"include /etc/nginx/conf.d/*.conf;\n")),(0,l.kt)("h3",{id:"nginx-server-conf"},"nginx server conf"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},'server {\n    listen                  443 ssl http2;\n    listen                  [::]:443 ssl ipv6only=on http2;\n    server_name             www.example.com;\n    root                    /var/www/example.com/public;\n\n    ## SSL\n    ssl_certificate         /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key     /etc/letsencrypt/live/example.com/privkey.pem;\n    ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;\n\n    ## security\n    ## include                 security.conf;\n    ## security headers\n    add_header X-XSS-Protection          "1; mode=block" always;\n    add_header X-Content-Type-Options    "nosniff" always;\n    add_header Referrer-Policy           "no-referrer-when-downgrade" always;\n    add_header Content-Security-Policy   "default-src \'self\' http: https: ws: wss: data: blob: \'unsafe-inline\'; frame-ancestors \'self\';" always;\n    add_header Permissions-Policy        "interest-cohort=()" always;\n    ## HSTS\n    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" preload;\n\n    ## . files\n    location ~ /\\.(?!well-known) {\n        deny all;\n    }\n\n    ## logging\n    access_log              /var/log/nginx/example.com.access.log;\n    error_log               /var/log/nginx/example.com.error.log warn;\n\n    ## reverse proxy\n    location / {\n        proxy_pass http://127.0.0.1:3000;\n        ## include    proxy.conf;\n        proxy_http_version                 1.1;\n        proxy_cache_bypass                 $http_upgrade;\n\n        ## Proxy headers\n        proxy_set_header Upgrade           $http_upgrade;\n        proxy_set_header Connection        $connection_upgrade;\n        proxy_set_header Host              $host;\n        proxy_set_header X-Real-IP         $remote_addr;\n        proxy_set_header Forwarded         $proxy_add_forwarded;\n        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host  $host;\n        proxy_set_header X-Forwarded-Port  $server_port;\n\n        ## Proxy timeouts\n        proxy_connect_timeout              60s;\n        proxy_send_timeout                 60s;\n        proxy_read_timeout                 60s;\n    }\n\n    ## additional config\n    ## include general.conf;\n    ## favicon.ico\n    location = /favicon.ico {\n        log_not_found off;\n        access_log    off;\n    }\n\n    ## robots.txt\n    location = /robots.txt {\n        log_not_found off;\n        access_log    off;\n    }\n\n    ## assets, media\n    location ~* \\.(?:css(\\.map)?|js(\\.map)?|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$ {\n        expires    7d;\n        access_log off;\n    }\n\n    ## svg, fonts\n    location ~* \\.(?:svgz?|ttf|ttc|otf|eot|woff2?)$ {\n        add_header Access-Control-Allow-Origin "*";\n        expires    7d;\n        access_log off;\n    }\n\n    ## gzip\n    gzip            on;\n    gzip_vary       on;\n    gzip_proxied    any;\n    gzip_comp_level 6;\n    gzip_types      text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;\n}\n\n## \u5b50\u57df\u540d\u91cd\u5b9a\u5411\u5230www\u57df\nserver {\n    listen                  443 ssl http2;\n    listen                  [::]:443 ssl http2;\n    server_name             .example.com;\n\n    ## SSL\n    ssl_certificate         /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key     /etc/letsencrypt/live/example.com/privkey.pem;\n    ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;\n    return                  301 https://www.example.com$request_uri;\n}\n\n## 80 \u91cd\u5b9a\u5411\u5230 443\nserver {\n    listen      80;\n    listen      [::]:80;\n    server_name .example.com;\n    ## include     letsencrypt.conf;\n    ## ACME-challenge\n    location ^~ /.well-known/acme-challenge/ {\n        root /var/www/_letsencrypt;\n    }\n\n    location / {\n        return 301 https://www.example.com$request_uri;\n    }\n}\n')),(0,l.kt)("h2",{id:"\u9759\u6001\u7f51\u9875\u8f6c\u53d1"},"\u9759\u6001\u7f51\u9875\u8f6c\u53d1"),(0,l.kt)("p",null,"\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com"),"  \u5c06\u4f1a\u8f6c\u53d1\u5230\u670d\u52a1\u5668\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"/www/baidu")," \u8def\u5f84\u4e0b\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"index.html")," \u6587\u4ef6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n\n    listen 80;\n    listen [::]:80;\n    server_name www.baidu.com;\n\n    location / {\n        root /www/baidu;\n        index index.html;\n    }\n  \n}\n")),(0,l.kt)("h4",{id:"listen"},"listen"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"listen 80;")," \u76d1\u542cipv4\u768480\u7aef\u53e3"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"listen [::]:80;")," \u76d1\u542cipv6\u768480\u7aef\u53e3")),(0,l.kt)("h4",{id:"server_name"},"server_name"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"server_name www.baidu.com;")," "),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"server_name")," \u53ef\u4ee5\u914d\u7f6e\u6210\u57df\u540d\u6216\u4e3b\u673a\u540d"),(0,l.kt)("p",null,"\u57df\u540d\uff1a\u914d\u7f6e\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},"www.baidu.com")," \u57df\u540d\u53ef\u4ee5\u8bbf\u95ee\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"/www/baidu/")," \u4e0b\u9762\u7684\u6587\u4ef6"),(0,l.kt)("p",null,"\u4e3b\u673a\u540d\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"$hostname")," \u5982\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"baidu-web")," \u5219\u53ef\u4ee5\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},"http://baidu-web")," \u8bbf\u95ee \u5230  ",(0,l.kt)("inlineCode",{parentName:"p"},"/www/baidu/")," \u4e0b\u9762\u7684\u6587\u4ef6"),(0,l.kt)("h4",{id:"location"},"location"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"location /")," \u8bf7\u6c42\u6307\u5411\u76ee\u5f55\u3002"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"/")," \u662f\u6839\u76ee\u5f55\uff0c\u5982\u679c\u914d\u7f6e\u6210 ",(0,l.kt)("inlineCode",{parentName:"p"},"/css")," \u5219\u4f1a\u6839\u636e root \u8f6c\u53d1\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"/www/baidu/css")," "),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"location /css {\n    root /www/baidu;\n    index index.html;\n}\n")),(0,l.kt)("h5",{id:"\u4fee\u9970\u7b26"},"\u4fee\u9970\u7b26"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"location")," \u53ef\u4ee5\u4f7f\u7528\u4fee\u9970\u7b26\u6216\u6b63\u5219\u8868\u8fbe\u5f0f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"location = /html/about.html {\n  root  /www/pages;\n}\n  \nlocation ^~ /fonts/ {\n  root  /www/fonts;\n}\n\nlocation ~ \\.(css|js|png|jpg|gif|ico) {\n  root /www/static;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"=")," \u4e25\u683c\u5339\u914d"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"^~")," \u666e\u901a\u5b57\u7b26\u5339\u914d\u3002\u4f7f\u7528\u524d\u7f00\u5339\u914d"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"~")," \u533a\u5206\u5927\u5c0f\u5199"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"~*")," \u4e0d\u533a\u5206\u5927\u5c0f\u5199")),(0,l.kt)("p",null,"\u4f18\u5148\u7ea7\u4ece\u9ad8\u5230\u4f4e\u4f9d\u6b21\u4e3a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u7cbe\u786e\u5339\u914d\uff08",(0,l.kt)("inlineCode",{parentName:"li"},"="),"\uff09"),(0,l.kt)("li",{parentName:"ol"},"\u524d\u7f00\u5339\u914d\uff08",(0,l.kt)("inlineCode",{parentName:"li"},"^~"),"\uff09"),(0,l.kt)("li",{parentName:"ol"},"\u6b63\u5219\u5339\u914d\uff08",(0,l.kt)("inlineCode",{parentName:"li"},"~"),"\u548c",(0,l.kt)("inlineCode",{parentName:"li"},"\uff5e*"),"\uff09"),(0,l.kt)("li",{parentName:"ol"},"\u4e0d\u5199")),(0,l.kt)("h5",{id:"index"},"index"),(0,l.kt)("p",null,"\u914d\u7f6e\u9ed8\u8ba4\u7684\u6587\u4ef6"),(0,l.kt)("p",null,"\u5982\u8fc7\u8bbf\u95ee\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com")," \u7b49\u540c\u4e8e\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com/index.html")," "),(0,l.kt)("h2",{id:"http-\u53cd\u5411\u4ee3\u7406"},"HTTP \u53cd\u5411\u4ee3\u7406"),(0,l.kt)("p",null,"\u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u670d\u52a1\u542f\u52a8\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"8080")," \u7aef\u53e3\uff0c\u6211\u4eec\u73b0\u5728\u9700\u8981\u5c06\u6b64\u670d\u52a1\u4ee3\u7406\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com/api")," \u8bbf\u95ee"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n  \n  listen 80;\n  listen [::]:80;\n  \n  server_name www.baidu.com;\n\n  location /api {\n    proxy_pass http://127.0.0.1:8080/;\n  }\n\n}\n")),(0,l.kt)("h4",{id:"location-1"},"location"),(0,l.kt)("p",null,"\u5982\u679c ",(0,l.kt)("inlineCode",{parentName:"p"},"proxy_pass")," \u53ea\u914d\u7f6e\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"/")," \u65f6\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com/api/users/1")," \u5219\u4f1a\u8f6c\u53d1\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:8080/api/users/1")),(0,l.kt)("p",null,"\u5982\u679c ",(0,l.kt)("inlineCode",{parentName:"p"},"proxy_pass")," \u53ea\u914d\u7f6e\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"/prod-api")," \u65f6\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"p"},"http://www.baidu.com/api/users/1")," \u5219\u4f1a\u8f6c\u53d1\u5230",(0,l.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:8080/prod-api/users/1")),(0,l.kt)("h4",{id:"proxy_pass"},"proxy_pass"),(0,l.kt)("p",null,"\u9700\u8981\u53cd\u5411\u4ee3\u7406\u7684\u5730\u5740"),(0,l.kt)("h3",{id:"\u8bbe\u7f6e\u4ee3\u7406\u8bf7\u6c42-header"},"\u8bbe\u7f6e\u4ee3\u7406\u8bf7\u6c42 Header"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"location /api {\n    #nginx\u7684\u4e3b\u673a\u5730\u5740\n    proxy_set_header Host $http_host;\n    #\u7528\u6237\u7aef\u771f\u5b9e\u7684IP\uff0c\u5373\u5ba2\u6237\u7aefIP\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n    proxy_pass http://127.0.0.1:8080/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"$host"),"\uff1anginx \u4e3b\u673aIP"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"$http_host"),"\uff1anginx \u4e3b\u673a IP \u548c\u7aef\u53e3"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"$proxy_host"),"\uff1alocalhost:8088\uff0cproxy_pass \u91cc\u914d\u7f6e\u7684\u4e3b\u673a\u540d\u548c\u7aef\u53e3"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"$remote_addr"),":\u7528\u6237\u7684\u771f\u5b9eIP\uff0c\u5373\u5ba2\u6237\u7aefIP")),(0,l.kt)("h2",{id:"https-\u914d\u7f6e"},"HTTPS \u914d\u7f6e"),(0,l.kt)("h3",{id:"\u751f\u6210\u8bc1\u4e66"},"\u751f\u6210\u8bc1\u4e66"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"OpenSSL")," \u751f\u6210\u81ea\u7b7e\u8bc1\u4e66"),(0,l.kt)("li",{parentName:"ol"},"\u4f7f\u7528 \u4e91\u5e73\u53f0 \u8d2d\u4e70\u7684\u8bc1\u4e66")),(0,l.kt)("h3",{id:"\u914d\u7f6e-ssl"},"\u914d\u7f6e SSL"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n    listen              443 ssl;\n    listen              [::]:443 ssl;\n    server_name         www.baidu.com;\n\n    ssl_certificate     /etc/ssl/www.baidu.com.pem;\n    ssl_certificate_key /etc/ssl/www.baidu.com.key;\n    ## ssl_password_file /etc/ssl/www.baidu.com.pass;\n    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols       TLSv1.1 TLSv1.2 TLSv1.3\n    ssl_prefer_server_ciphers on;\n    location / {\n        proxy_pass http://localhost:8088;\n    }\n}\n")),(0,l.kt)("h2",{id:"\u91cd\u5b9a\u5411"},"\u91cd\u5b9a\u5411"),(0,l.kt)("p",null,"\u76d1\u542c 80\u7aef\u53e3\u7684 \u8bf7\u6c42\uff0c\u91cd\u5b9a\u5411\u5230 https \u7684"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n  listen 80;\n  listen [::]:80;\n\n  server_name www.baidu.com;\n  rewrite ^(.*)$ https://$host$1; ## \u5c06\u6240\u6709HTTP\u8bf7\u6c42\u901a\u8fc7rewrite\u6307\u4ee4\u91cd\u5b9a\u5411\u5230HTTPS\u3002\n  location / {\n    index index.html;\n  }\n\n}\n")),(0,l.kt)("h3",{id:"break"},"break"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n  listen 80;\n  listen [::]:80;\n\n  server_name www.baidu.com;\n  location / {\n    rewrite ^/api/(.*)$ /prod-api/$1 break;\n    rewrite ^/prod-api/(.*)$ /dev-api;\n    root /www/baidu;\n    index index.html;\n  }\n\n  location /dev-api {\n    proxy_pass http://localhost:8088;\n  }\n\n}\n")),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"li"},"www.baidu.com/api/users/1")," \u5339\u914d\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"rewrite ^/api/(.*)$ /prod-api/$1 break;")," \u9047\u5230 break\u540e\u4e0d\u6267\u884c\u540e\u7eed rewrite \u64cd\u4f5c"),(0,l.kt)("li",{parentName:"ol"},"\u4f7f\u7528  ",(0,l.kt)("inlineCode",{parentName:"li"},"/prod-api/users/1")," \u53bb ",(0,l.kt)("inlineCode",{parentName:"li"},"root")," \u8def\u5f84\u4e0b\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"/www/baidu/prod-api/users/1/index.html")," \u5bfb\u627e\u6587\u4ef6")),(0,l.kt)("h3",{id:"last"},"last"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"server {\n  listen 80;\n  listen [::]:80;\n\n  server_name www.baidu.com;\n  location / {\n    rewrite ^/api/(.*)$ /prod-api/$1 last;\n    rewrite ^/prod-api/(.*)$ /dev-api;\n    root /www/baidu;\n    index index.html;\n  }\n  \n  location /dev-api {\n    proxy_pass http://localhost:8088;\n  }\n\n}\n")),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u8bbf\u95ee ",(0,l.kt)("inlineCode",{parentName:"li"},"www.baidu.com/api/users/1")," \u4f1a\u5339\u914d\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"rewrite ^/api/(.*)$ /prod-api/$1 last;"),"\u9047\u5230 last \u5c06\u4e0d\u4f1a\u6267\u884c\u540e\u7eed\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"rewrite")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"/prod-api/users/1")," \u5339\u914d\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"location /")," \u4e0b\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"rewrite ^/prod-api/(.*)$ /dev-api;")," \u91cd\u5b9a\u5411\u540e\u91cd\u65b0\u5339\u914d location"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"/dev-api/users/1"),"  \u5339\u914d\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"location /dev-api")," \u7136\u540e\u8f6c\u53d1\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"http://localhost:8088/dev-api/users/1"))),(0,l.kt)("h2",{id:"\u7f13\u5b58"},"\u7f13\u5b58"),(0,l.kt)("h2",{id:"\u8d1f\u8f7d\u5747\u8861"},"\u8d1f\u8f7d\u5747\u8861"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    ## \u9ed8\u8ba4\u91c7\u7528\u8f6e\u5faa\u673a\u5236\n    server 127.0.0.1:8080;\n    server 127.0.0.1:8081;\n}\n\nserver {\n  listen 80;\n  listen [::]:80;\n  \n  server_name www.baidu.com;\n\n  location /api {\n    proxy_pass http://baidu-cluster;\n  }\n\n}\n")),(0,l.kt)("h3",{id:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565"},"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565"),(0,l.kt)("h4",{id:"\u8f6e\u5faa\u673a\u5236round-robin"},"\u8f6e\u5faa\u673a\u5236\uff08round-robin\uff09"),(0,l.kt)("p",null,"\u9ed8\u8ba4\u7b56\u7565\uff0c\u8f6e\u8bad\u5206\u53d1"),(0,l.kt)("h4",{id:"\u6700\u5c0f\u8fde\u63a5least-connected-"},(0,l.kt)("a",{parentName:"h4",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#least_conn"},"\u6700\u5c0f\u8fde\u63a5"),"\uff08least-connected \uff09"),(0,l.kt)("p",null,"\u5c06\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5206\u53d1\u7ed9\u6d3b\u52a8\u8fde\u63a5\u6570\u6700\u5c0f\u7684\u670d\u52a1\u5668"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    least_conn;\n    server 127.0.0.1:8080;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("h4",{id:"ip-hash"},(0,l.kt)("a",{parentName:"h4",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash"},"ip-hash")),(0,l.kt)("p",null,"\u6839\u636e\u5ba2\u6237\u7aef\u7684 IP \u4f5c\u4e3a hash key\uff0c\u6765\u81ea\u540c\u4e00\u4e2a ip \u7684\u8bf7\u6c42\u4f1a\u88ab\u8f6c\u53d1\u5230\u76f8\u540c\u7684\u670d\u52a1\u5668"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    ip_hash;\n    server 127.0.0.1:8080;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("h4",{id:"hash"},(0,l.kt)("a",{parentName:"h4",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash"},"hash")),(0,l.kt)("p",null,"\u901a\u7528 hash\u3002\u5141\u8bb8\u7528\u6237\u81ea\u5b9a\u4e49 hash key\uff0c\u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u3001\u53d8\u91cf\u6216\u7ec4\u5408"),(0,l.kt)("p",null,"\u4f8b\u5982\uff1akey\u53ef\u4ee5\u662f\u914d\u5bf9\u7684\u6e90 IP \u5730\u5740\u548c\u7aef\u53e3\uff0c\u4e5f\u53ef\u4ee5\u662f URI\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    hash $request_uri consistent;\n    server 127.0.0.1:8080;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"consistent"),"\u53c2\u6570\u542f\u7528 ",(0,l.kt)("a",{parentName:"p",href:"http://www.last.fm/user/RJ/journal/2007/04/10/rz_libketama_-_a_consistent_hashing_algo_for_memcache_clients"},"ketama"),"\u4e00\u81f4\u54c8\u5e0c\u7b97\u6cd5\uff0c\u5982\u679c\u5728\u4e0a\u6e38\u7ec4\u4e2d\u6dfb\u52a0\u6216\u5220\u9664\u670d\u52a1\u5668\uff0c\u53ea\u4f1a\u91cd\u65b0\u6620\u5c04\u90e8\u5206\u952e\uff0c\u4ece\u800c\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u7f13\u5b58\u5931\u6548\u3002"),(0,l.kt)("h4",{id:"\u968f\u673arandom"},(0,l.kt)("a",{parentName:"h4",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#random"},"\u968f\u673a"),"(random\uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    random two least_conn;\n    server 127.0.0.1:8080;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("h4",{id:"\u6743\u91cdweight"},"\u6743\u91cd\uff08weight\uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    server 127.0.0.1:8080 weight=3;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u6bcf\u56db\u4e2a\u8bf7\u6c42\uff0c\u4f1a\u6709\u4e09\u4e2a\u8bf7\u6c42\u5206\u53d1\u52308080\u7aef\u53e3\uff0c\u4e00\u4e2a\u8bf7\u6c42\u5206\u53d1\u52308081\u7aef\u53e3")),(0,l.kt)("h4",{id:"\u5065\u5eb7\u68c0\u67e5"},"\u5065\u5eb7\u68c0\u67e5"),(0,l.kt)("p",null,"\u5728\u53cd\u5411\u4ee3\u7406\u4e2d\uff0c\u5982\u679c\u540e\u7aef\u670d\u52a1\u5668\u5728\u67d0\u4e2a\u5468\u671f\u5185\u54cd\u5e94\u5931\u8d25\u6b21\u6570\u8d85\u8fc7\u89c4\u5b9a\u503c\uff0cnginx\u4f1a\u5c06\u6b64\u670d\u52a1\u5668\u6807\u8bb0\u4e3a\u5931\u8d25\uff0c\u5e76\u5728\u4e4b\u540e\u7684\u4e00\u4e2a\u5468\u671f\u4e0d\u518d\u5c06\u8bf7\u6c42\u53d1\u9001\u7ed9\u8fd9\u53f0\u670d\u52a1\u5668\u3002"),(0,l.kt)("p",null,"\u901a\u8fc7",(0,l.kt)("a",{parentName:"p",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#fail_timeout"},"fail_timeout"),"\u6765\u8bbe\u7f6e\u68c0\u67e5\u5468\u671f\uff0c\u9ed8\u8ba4\u4e3a10\u79d2\u3002"),(0,l.kt)("p",null,"\u901a\u8fc7",(0,l.kt)("a",{parentName:"p",href:"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#max_fails"},"max_fails"),"\u6765\u8bbe\u7f6e\u68c0\u67e5\u5931\u8d25\u6b21\u6570\uff0c\u9ed8\u8ba4\u4e3a1\u6b21\u3002"),(0,l.kt)("p",null,"\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5982\u679cNGINX\u65e0\u6cd5\u5411\u670d\u52a1\u5668\u53d1\u9001\u8bf7\u6c42\u6216\u572830\u79d2\u5185\u8bf7\u6c42\u5931\u8d25\u6b21\u6570\u8d85\u8fc73\u6b21\uff0c\u5219\u4f1a\u5c06\u670d\u52a1\u5668\u6807\u8bb0\u4e3a\u4e0d\u53ef\u752830\u79d2\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"upstream baidu-cluster {\n    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;\n    server 127.0.0.1:8081;\n}\n")),(0,l.kt)("h2",{id:"tcp-\u53cd\u5411\u4ee3\u7406"},"TCP \u53cd\u5411\u4ee3\u7406"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"## HTTP\u4ee3\u7406\nhttp {\n  server {\n    listen 8002;\n    proxy_pass http://localhost:8080/;\n  }\n}\n\n## TCP\u4ee3\u7406\nstream {\n  server {\n    listen 13306;\n    proxy_pass localhost:3306;\n  }\n}\n")),(0,l.kt)("h3",{id:"tcp-\u8d1f\u8f7d\u5747\u8861"},"TCP \u8d1f\u8f7d\u5747\u8861"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-conf"},"stream {\n  upstream mqtt-cluster {\n    server 127.0.0.1:5432;\n    server 127.0.0.1:5433;\n    keepalive 8;\n  }\n  server {\n    listen 15432;\n    proxy_pass mqtt-cluster;\n  }\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"keepalive")," \u8fde\u63a5\u6c60\u91cc\u7a7a\u95f2\u8fde\u63a5\u7684\u6570\u91cf\u3002",(0,l.kt)("inlineCode",{parentName:"li"},"keepalive_timeout")," \u9ed8\u8ba460s\u3002\u5982\u679c\u8fde\u63a5\u6c60\u91cc\u7684\u8fde\u63a5\u7a7a\u95f2\u65f6\u95f4\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u5219\u8fde\u63a5\u5173\u95ed")))}m.isMDXComponent=!0}}]);