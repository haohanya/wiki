<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-后端/中间件/RocketMQ">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">RocketMQ | My Doc</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/后端/中间件/RocketMQ"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RocketMQ | My Doc"><meta data-rh="true" name="description" content="RocketMQ 快速入门"><meta data-rh="true" property="og:description" content="RocketMQ 快速入门"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/后端/中间件/RocketMQ"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/后端/中间件/RocketMQ" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/后端/中间件/RocketMQ" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Doc RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Doc Atom Feed"><link rel="stylesheet" href="/assets/css/styles.781e9e86.css">
<link rel="preload" href="/assets/js/runtime~main.d9ffcfde.js" as="script">
<link rel="preload" href="/assets/js/main.394399f2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_dYNx" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Doc" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.svg" alt="My Doc" class="themedImage_rLhL themedImage--dark_quyK"></div><b class="navbar__title text--truncate">My Doc</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">doc</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pannanxu/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_uxSF colorModeToggle_S3Zp"><button class="clean-btn toggleButton_VmvJ toggleButtonDisabled_FOd7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_LA5r"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_LEBj"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ldyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MxCR docsWrapper_h_X8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Kzpt" type="button"></button><div class="docPage_GWs5"><aside class="theme-doc-sidebar-container docSidebarContainer_ldoy"><div class="sidebarViewport_TwFD"><div class="sidebar_H_01"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_J18w"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/后端">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Caddy">Caddy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Docker">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Flowable">Flawable</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Git">Git</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/JDK/Bio">JDK</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Linux">Linux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/MacOsM1">MacOS 环境配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Netty">Netty</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Nginx">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Shell">Shell</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/Spring/源码">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/后端/SpringCloud/">SpringCloud</a><button aria-label="Toggle the collapsible sidebar category &#x27;SpringCloud&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Vim">Vim</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/kubernetes/安装">kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/后端/中间件/RocketMQ">中间件</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/后端/中间件/RocketMQ">RocketMQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/微信开发/微信公众号">微信开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/数据库/HBase">数据库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/后端/设计模式/">创建型模式</a><button aria-label="Toggle the collapsible sidebar category &#x27;创建型模式&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/面试题">面试题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/前端/ViteJs">前端</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/年终&amp;未来/2022">年终&amp;未来</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/模板/技术设计模板">模板</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_baW4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Njrt"><div class="docItemContainer_ZzVP"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HWXL" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_IT7R"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/后端"><span itemprop="name">后端</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">中间件</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RocketMQ</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_GIgr theme-doc-toc-mobile tocMobile_JEhh"><button type="button" class="clean-btn tocCollapsibleButton_Q9up">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RocketMQ</h1><h2 class="anchor anchorWithStickyNavbar_er05" id="rocketmq-快速入门">RocketMQ 快速入门<a href="#rocketmq-快速入门" class="hash-link" aria-label="Direct link to RocketMQ 快速入门" title="Direct link to RocketMQ 快速入门">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="基本概念">基本概念<a href="#基本概念" class="hash-link" aria-label="Direct link to 基本概念" title="Direct link to 基本概念">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="1消息模型message-model">1、消息模型（Message Model）<a href="#1消息模型message-model" class="hash-link" aria-label="Direct link to 1、消息模型（Message Model）" title="Direct link to 1、消息模型（Message Model）">​</a></h4><p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="2消息生产者producer">2、消息生产者（Producer）<a href="#2消息生产者producer" class="hash-link" aria-label="Direct link to 2、消息生产者（Producer）" title="Direct link to 2、消息生产者（Producer）">​</a></h4><p>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="3消息消费者consumer">3、消息消费者（Consumer）<a href="#3消息消费者consumer" class="hash-link" aria-label="Direct link to 3、消息消费者（Consumer）" title="Direct link to 3、消息消费者（Consumer）">​</a></h4><p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="4主题topic">4、主题（Topic）<a href="#4主题topic" class="hash-link" aria-label="Direct link to 4、主题（Topic）" title="Direct link to 4、主题（Topic）">​</a></h4><p>表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="5代理服务器broker-server">5、代理服务器（Broker Server）<a href="#5代理服务器broker-server" class="hash-link" aria-label="Direct link to 5、代理服务器（Broker Server）" title="Direct link to 5、代理服务器（Broker Server）">​</a></h4><p>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="6名字服务name-server">6、名字服务（Name Server）<a href="#6名字服务name-server" class="hash-link" aria-label="Direct link to 6、名字服务（Name Server）" title="Direct link to 6、名字服务（Name Server）">​</a></h4><p>名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="7拉取式消费pull-consumer">7、拉取式消费（Pull Consumer）<a href="#7拉取式消费pull-consumer" class="hash-link" aria-label="Direct link to 7、拉取式消费（Pull Consumer）" title="Direct link to 7、拉取式消费（Pull Consumer）">​</a></h4><p>Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="8推动式消费push-consumer">8、推动式消费（Push Consumer）<a href="#8推动式消费push-consumer" class="hash-link" aria-label="Direct link to 8、推动式消费（Push Consumer）" title="Direct link to 8、推动式消费（Push Consumer）">​</a></h4><p>Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="9生产者组producer-group">9、生产者组（Producer Group）<a href="#9生产者组producer-group" class="hash-link" aria-label="Direct link to 9、生产者组（Producer Group）" title="Direct link to 9、生产者组（Producer Group）">​</a></h4><p>同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="10消费者组consumer-group">10、消费者组（Consumer Group）<a href="#10消费者组consumer-group" class="hash-link" aria-label="Direct link to 10、消费者组（Consumer Group）" title="Direct link to 10、消费者组（Consumer Group）">​</a></h4><p>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="11集群消费clustering">11、集群消费（Clustering）<a href="#11集群消费clustering" class="hash-link" aria-label="Direct link to 11、集群消费（Clustering）" title="Direct link to 11、集群消费（Clustering）">​</a></h4><p>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="12广播消费broadcasting">12、广播消费（Broadcasting）<a href="#12广播消费broadcasting" class="hash-link" aria-label="Direct link to 12、广播消费（Broadcasting）" title="Direct link to 12、广播消费（Broadcasting）">​</a></h4><p>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="13普通顺序消息normal-ordered-message">13、普通顺序消息（Normal Ordered Message）<a href="#13普通顺序消息normal-ordered-message" class="hash-link" aria-label="Direct link to 13、普通顺序消息（Normal Ordered Message）" title="Direct link to 13、普通顺序消息（Normal Ordered Message）">​</a></h4><p>普通顺序消费模式下，消费者通过同一个消费队列收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="14严格顺序消息strictly-ordered-message">14、严格顺序消息（Strictly Ordered Message）<a href="#14严格顺序消息strictly-ordered-message" class="hash-link" aria-label="Direct link to 14、严格顺序消息（Strictly Ordered Message）" title="Direct link to 14、严格顺序消息（Strictly Ordered Message）">​</a></h4><p>严格顺序消息模式下，消费者收到的所有消息均是有顺序的。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="15消息message">15、消息（Message）<a href="#15消息message" class="hash-link" aria-label="Direct link to 15、消息（Message）" title="Direct link to 15、消息（Message）">​</a></h4><p>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="16标签tag">16、标签（Tag）<a href="#16标签tag" class="hash-link" aria-label="Direct link to 16、标签（Tag）" title="Direct link to 16、标签（Tag）">​</a></h4><p>为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="技术架构">技术架构<a href="#技术架构" class="hash-link" aria-label="Direct link to 技术架构" title="Direct link to 技术架构">​</a></h3><p>RocketMQ架构上主要分为四部分</p><ul><li>Producer：消息发布的角色，支持分布式集群方式部署。Producer通过MQ的负载均衡模块选择相应的Broker集群队列进行消息投递，投递的过程支持快速失败并且低延迟。</li><li>Consumer：消息消费的角色，支持分布式集群方式部署。支持以push推，pull拉两种模式对消息进行消费。同时也支持集群方式和广播方式的消费，它提供实时消息订阅机制，可以满足大多数用户的需求。</li><li>NameServer：NameServer是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。主要包括两个功能：Broker管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活；路由信息管理，每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Conumser通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</li><li>BrokerServer：Broker主要负责消息的存储、投递和查询以及服务高可用保证，为了实现这些功能，Broker包含了以下几个重要子模块。<ol><li>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。</li><li>Client Manager：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li><li>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li><li>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li><li>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</li></ol></li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="安装rocketmq">安装RocketMQ<a href="#安装rocketmq" class="hash-link" aria-label="Direct link to 安装RocketMQ" title="Direct link to 安装RocketMQ">​</a></h3><p><strong>下载Broker</strong></p><p><a href="https://github.com/apache/rocketmq/releases/tag/rocketmq-all-4.7.1" target="_blank" rel="noopener noreferrer">https://github.com/apache/rocketmq/releases/tag/rocketmq-all-4.7.1</a></p><p>下载完毕之后解压到一个文件夹中</p><p><strong>编译</strong></p><p>进入项目根目录后cmd执行以下命令</p><div class="language-shell codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-shell codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">mvn -Prelease-all -DskipTests clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -U</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> distribution</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">rocketmq-4.7.1</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">rocketmq-4.7.1</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>设置环境变量</strong></p><div class="language-properties codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-properties codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">ROCKETMQ_HOME=&quot;D:\rocketmq-rocketmq-all-4.7.1\distribution\target\rocketmq-4.7.1\rocketmq-4.7.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESRV_ADDR=&quot;localhost:9876&quot;</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>启动Name Server</strong></p><div class="language-shell codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-shell codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">bin</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">mqnamesrv.cmd</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>启动成功后会出现：<code>The Name Server boot success. serializeType=JSON</code></p></blockquote><p><strong>启动Broker Server</strong></p><div class="language-shell codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-shell codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">bin</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">mqbroker.cmd -n localhost:9876 </span><span class="token assign-left variable" style="color:#36acaa">autoCreateTopicEnable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>启动成功后会出现：<code>The broker[xxxx, 192.168.199.137:10911] boot success. serializeType=JSON and name server is localhost:9876</code></p></blockquote><h4 class="anchor anchorWithStickyNavbar_er05" id="安装-rocketmq-console-可选">安装 RocketMQ Console (可选)<a href="#安装-rocketmq-console-可选" class="hash-link" aria-label="Direct link to 安装 RocketMQ Console (可选)" title="Direct link to 安装 RocketMQ Console (可选)">​</a></h4><div class="language-shell codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-shell codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/rocketmq-externals.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ./rocketmq-console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean package -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java -jar rocketmq-console-ng-2.0.0.jar --server.port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12581</span><span class="token plain"> --rocketmq.config.namesrvAddr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:9876</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>rocketmq.config.namesrvAddr：Name Server的地址</p><p>在启动console之前，Name Server 和 Broker Server 得先启动</p></blockquote><p><strong>访问面板</strong></p><p>http://localhost:12581/</p><h3 class="anchor anchorWithStickyNavbar_er05" id="项目搭建">项目搭建<a href="#项目搭建" class="hash-link" aria-label="Direct link to 项目搭建" title="Direct link to 项目搭建">​</a></h3><p><strong>创建工程</strong></p><p><code>rocketmq</code></p><p><strong>引入依赖</strong></p><div class="language-xml codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-xml codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- RocketMQ --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.rocketmq</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">rocketmq-client</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">4.7.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">test</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="基本样例">基本样例<a href="#基本样例" class="hash-link" aria-label="Direct link to 基本样例" title="Direct link to 基本样例">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="1producer端发送同步消息">1、Producer端发送同步消息<a href="#1producer端发送同步消息" class="hash-link" aria-label="Direct link to 1、Producer端发送同步消息" title="Direct link to 1、Producer端发送同步消息">​</a></h4><p>发送同步消息即表示生产者在发送消息时会处于阻塞状态，直到消费者消费完这条消息为止并返回一个接收的结果。这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 发送同步消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendSyncProducer() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实例化消息生产者Producer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置NameServer的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动Producer实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建消息，并指定Topic，Tag和消息体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message msg = new Message(&quot;topic1&quot;, &quot;tag1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发送消息到一个Broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SendResult sendResult = producer.send(msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过sendResult返回消息是否成功送达</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(sendResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果不再发送消息，关闭Producer实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="2发送异步消息">2、发送异步消息<a href="#2发送异步消息" class="hash-link" aria-label="Direct link to 2、发送异步消息" title="Direct link to 2、发送异步消息">​</a></h4><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendAsync() throws Exception{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实例化消息生产者Producer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置NameServer的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.setNamesrvAddr(&quot;localhost:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动Producer实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.setRetryTimesWhenSendAsyncFailed(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int messageCount = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据消息数量实例化倒计时计算器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final CountDownLatch2 countDownLatch = new CountDownLatch2(messageCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; messageCount; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int index = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建消息，并指定Topic，Tag和消息体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message msg = new Message(&quot;topic1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;TagA&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;OrderID188&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Hello world&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SendCallback接收异步返回结果的回调</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.send(msg, new SendCallback() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void onSuccess(SendResult sendResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;%-10d OK %s %n&quot;, index, sendResult.getMsgId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void onException(Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;%-10d Exception %s %n&quot;, index, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 等待5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    countDownLatch.await(5, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果不再发送消息，关闭Producer实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="3单向发送消息">3、单向发送消息<a href="#3单向发送消息" class="hash-link" aria-label="Direct link to 3、单向发送消息" title="Direct link to 3、单向发送消息">​</a></h4><p>这种方式主要用在不特别关心发送结果的场景，例如日志发送。</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void sendOneway() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实例化消息生产者Producer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置NameServer的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.setNamesrvAddr(&quot;localhost:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动Producer实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 100; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建消息，并指定Topic，Tag和消息体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message msg = new Message(&quot;topic1&quot; /* Topic */,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;TagB&quot; /* Tag */,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发送单向消息，没有任何返回结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.sendOneway(msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果不再发送消息，关闭Producer实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="4消费消息">4、消费消息<a href="#4消费消息" class="hash-link" aria-label="Direct link to 4、消费消息" title="Direct link to 4、消费消息">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void consumer() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实例化消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置NameServer的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer.subscribe(&quot;topic1&quot;, &quot;*&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 注册回调实现类来处理从broker拉取回来的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer.registerMessageListener(new MessageListenerConcurrently() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(msgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 标记该消息已经被成功消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动消费者实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;consumer start...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="rocketmq-批量消息">RocketMQ 批量消息<a href="#rocketmq-批量消息" class="hash-link" aria-label="Direct link to RocketMQ 批量消息" title="Direct link to RocketMQ 批量消息">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="批量消息">批量消息<a href="#批量消息" class="hash-link" aria-label="Direct link to 批量消息" title="Direct link to 批量消息">​</a></h3><p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批消息的总大小不应超过4MB。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="发送批量消息">发送批量消息<a href="#发送批量消息" class="hash-link" aria-label="Direct link to 发送批量消息" title="Direct link to 发送批量消息">​</a></h3><p>如果您每次只发送不超过4MB的消息，则很容易使用批处理，样例如下：</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">String topic = &quot;BatchTest&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;Message&gt; messages = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID001&quot;, &quot;Hello world 0&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID002&quot;, &quot;Hello world 1&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID003&quot;, &quot;Hello world 2&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   producer.send(messages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   //处理error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="消息列表分割">消息列表分割<a href="#消息列表分割" class="hash-link" aria-label="Direct link to 消息列表分割" title="Direct link to 消息列表分割">​</a></h3><p>复杂度只有当你发送大批量时才会增长，你可能不确定它是否超过了大小限制（4MB）。这时候你最好把你的消息列表分割一下：</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.batch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 消息列表分割</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ListSplitter implements Iterator&lt;List&lt;Message&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int SIZE_LIMIT = 1024 * 1024 * 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Message&gt; messages;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int currIndex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ListSplitter(List&lt;Message&gt; messages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.messages = messages;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean hasNext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return currIndex &lt; messages.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;Message&gt; next() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int startIndex = getStartIndex();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int nextIndex = startIndex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int totalSize = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (; nextIndex &lt; messages.size(); nextIndex++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Message message = messages.get(nextIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int tmpSize = calcMessageSize(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tmpSize + totalSize &gt; SIZE_LIMIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                totalSize += tmpSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Message&gt; subList = messages.subList(startIndex, nextIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        currIndex = nextIndex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int getStartIndex() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message currMessage = messages.get(currIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int tmpSize = calcMessageSize(currMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (tmpSize &gt; SIZE_LIMIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            currIndex += 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Message message = messages.get(currIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tmpSize = calcMessageSize(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return currIndex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int calcMessageSize(Message message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int tmpSize = message.getTopic().length() + message.getBody().length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, String&gt; properties = message.getProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tmpSize += entry.getKey().length() + entry.getValue().length();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tmpSize = tmpSize + 20; // 增加⽇日志的开销20字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return tmpSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="发送分割后批量消息">发送分割后批量消息<a href="#发送分割后批量消息" class="hash-link" aria-label="Direct link to 发送分割后批量消息" title="Direct link to 发送分割后批量消息">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.batch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.SendResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 批量消息提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String topic = &quot;BatchTest&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Message&gt; messages = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID001&quot;, &quot;Hello world 0&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID002&quot;, &quot;Hello world 1&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messages.add(new Message(topic, &quot;TagA&quot;, &quot;OrderID003&quot;, &quot;Hello world 2&quot;.getBytes()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //把大的消息分裂成若干个小的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListSplitter splitter = new ListSplitter(messages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (splitter.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;Message&gt; listItem = splitter.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SendResult send = producer.send(listItem);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println(send);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //处理error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="批量消息消费">批量消息消费<a href="#批量消息消费" class="hash-link" aria-label="Direct link to 批量消息消费" title="Direct link to 批量消息消费">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.batch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.consumer.ConsumeFromWhere;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.MessageExt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 批量消息消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 如果非第一次启动，那么按照上次消费的位置继续消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(&quot;BatchTest&quot;, &quot;TagA&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.registerMessageListener(new MessageListenerOrderly() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public ConsumeOrderlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (MessageExt msg : msgs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;consumeThread=&quot; + Thread.currentThread().getName() + &quot;queueId=&quot; + msg.getQueueId() + &quot;, content:&quot; + new String(msg.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ConsumeOrderlyStatus.SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Consumer Started.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="rocketmq-顺序消息">RocketMQ 顺序消息<a href="#rocketmq-顺序消息" class="hash-link" aria-label="Direct link to RocketMQ 顺序消息" title="Direct link to RocketMQ 顺序消息">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="顺序消息">顺序消息<a href="#顺序消息" class="hash-link" aria-label="Direct link to 顺序消息" title="Direct link to 顺序消息">​</a></h3><p>消息有序指的是一类消息消费时，能按照发送的顺序来消费。例如：一个订单产生了三条消息分别是订单创建、订单付款、订单完成。消费时要按照这个顺序消费才能有意义，但是同时订单之间是可以并行消费的。RocketMQ可以严格的保证消息有序。</p><p>顺序消息分为全局顺序消息与分区顺序消息，全局顺序是指某个Topic下的所有消息都要保证顺序；部分顺序消息只要保证每一组消息被顺序消费即可。</p><ul><li>全局顺序 对于指定的一个 Topic，所有消息按照严格的先入先出（FIFO）的顺序进行发布和消费。 适用场景：性能要求不高，所有的消息严格按照 FIFO 原则进行消息发布和消费的场景</li><li>分区顺序 对于指定的一个 Topic，所有消息根据 sharding key 进行区块分区。 同一个分区内的消息按照严格的 FIFO 顺序进行发布和消费。 Sharding key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。 适用场景：性能要求高，以 sharding key 作为分区字段，在同一个区块中严格的按照 FIFO 原则进行消息发布和消费的场景。</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="顺序消息生产">顺序消息生产<a href="#顺序消息生产" class="hash-link" aria-label="Direct link to 顺序消息生产" title="Direct link to 顺序消息生产">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.MessageQueueSelector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.SendResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.MessageQueue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.text.SimpleDateFormat;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Date;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: Producer，发送顺序消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] tags = new String[]{&quot;TagA&quot;, &quot;TagC&quot;, &quot;TagD&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订单列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;OrderStep&gt; orderList = new Producer().buildOrders();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date date = new Date();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String dateStr = sdf.format(date);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 加个时间前缀</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String body = dateStr + &quot; Hello RocketMQ &quot; + orderList.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Message msg = new Message(&quot;ListTopic&quot;, tags[i % tags.length], &quot;KEY&quot; + i, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SendResult sendResult = producer.send(msg, new MessageQueueSelector() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long id = (Long) arg;  //根据订单id选择发送queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long index = id % mqs.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return mqs.get((int) index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }, orderList.get(i).getOrderId());//订单id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(String.format(&quot;SendResult status:%s, queueId:%d, body:%s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResult.getSendStatus(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResult.getMessageQueue().getQueueId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    body));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 订单的步骤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class OrderStep {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private long orderId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String desc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public long getOrderId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return orderId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setOrderId(long orderId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.orderId = orderId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getDesc() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return desc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setDesc(String desc) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.desc = desc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;OrderStep{&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;orderId=&quot; + orderId +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;, desc=&#x27;&quot; + desc + &#x27;\&#x27;&#x27; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;}&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成模拟订单数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;OrderStep&gt; buildOrders() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;OrderStep&gt; orderList = new ArrayList&lt;OrderStep&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OrderStep orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111039L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;创建&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111065L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;创建&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111039L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;付款&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103117235L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;创建&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111065L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;付款&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103117235L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;付款&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111065L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111039L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;推送&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103117235L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo = new OrderStep();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setOrderId(15103111039L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDemo.setDesc(&quot;完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderList.add(orderDemo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="顺序消费消息">顺序消费消息<a href="#顺序消费消息" class="hash-link" aria-label="Direct link to 顺序消费消息" title="Direct link to 顺序消费消息">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.consumer.ConsumeFromWhere;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.MessageExt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Random;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 顺序消息消费，带事务方式（应用可控制Offset什么时候提交）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 如果非第一次启动，那么按照上次消费的位置继续消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(&quot;ListTopic&quot;, &quot;TagA || TagC || TagD&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.registerMessageListener(new MessageListenerOrderly() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Random random = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public ConsumeOrderlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (MessageExt msg : msgs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;consumeThread=&quot; + Thread.currentThread().getName() + &quot;queueId=&quot; + msg.getQueueId() + &quot;, content:&quot; + new String(msg.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //模拟业务逻辑处理中...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TimeUnit.SECONDS.sleep(random.nextInt(10));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ConsumeOrderlyStatus.SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Consumer Started.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="rocketmq-定时消息">RocketMQ 定时消息<a href="#rocketmq-定时消息" class="hash-link" aria-label="Direct link to RocketMQ 定时消息" title="Direct link to RocketMQ 定时消息">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="定时消息">定时消息<a href="#定时消息" class="hash-link" aria-label="Direct link to 定时消息" title="Direct link to 定时消息">​</a></h3><p>定时消息（延迟队列）是指消息发送到broker后，不会立即被消费，等待特定时间投递给真正的topic。 broker有配置项messageDelayLevel，默认值为<code>1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code>，18个level。可以配置自定义messageDelayLevel。注意，messageDelayLevel是broker的属性，不属于某个topic。发消息时，设置delayLevel等级即可：msg.setDelayLevel(level)。level有以下三种情况：</p><ul><li>level == 0，消息为非延迟消息</li><li>1&lt;=level&lt;=maxLevel，消息延迟特定时间，例如level==1，延迟1s</li><li>level &gt; maxLevel，则level== maxLevel，例如level==20，延迟2h</li></ul><p>定时消息会暂存在名为SCHEDULE_TOPIC_XXXX的topic中，并根据delayTimeLevel存入特定的queue，queueId = delayTimeLevel – 1，即一个queue只存相同延迟的消息，保证具有相同发送延迟的消息能够顺序消费。broker会调度地消费SCHEDULE_TOPIC_XXXX，将消息写入真实的topic。</p><p>需要注意的是，定时消息会在第一次写入和调度写入真实topic时都会计数，因此发送数量、tps都会变高。</p><p><strong>使用场景</strong></p><p>比如电商里，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p><p><strong>延时消息的使用限制</strong></p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// org/apache/rocketmq/store/config/MessageStoreConfig.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private String messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;;</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>现在RocketMq并不支持任意时间的延时，需要设置几个固定的延时等级，从1s到2h分别对应着等级1到18 消息消费失败会进入延时消息队列，消息发送时间与设置的延时等级和重试次数有关，详见代码<code>SendMessageProcessor.java</code></p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="启动消费者等待传入订阅消息">启动消费者等待传入订阅消息<a href="#启动消费者等待传入订阅消息" class="hash-link" aria-label="Direct link to 启动消费者等待传入订阅消息" title="Direct link to 启动消费者等待传入订阅消息">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.scheduled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.MessageExt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 定时消息消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 实例化消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅Topics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(&quot;ScheduledTopic&quot;, &quot;*&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注册消息监听者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.registerMessageListener(new MessageListenerConcurrently() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (MessageExt message : messages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Print approximate delay time period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;Receive message[msgId=&quot; + message.getMsgId() + &quot;] &quot; + (System.currentTimeMillis() - message.getStoreTimestamp()) + &quot;ms later&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 启动消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.in.read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="发送延时消息">发送延时消息<a href="#发送延时消息" class="hash-link" aria-label="Direct link to 发送延时消息" title="Direct link to 发送延时消息">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.scheduled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 定时消息提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-27 22:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 实例化一个生产者来产生延时消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMQProducer producer = new DefaultMQProducer(&quot;group1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 启动生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int totalMessagesToSend = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; totalMessagesToSend; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Message message = new Message(&quot;ScheduledTopic&quot;, (&quot;Hello scheduled message &quot; + i).getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            message.setDelayTimeLevel(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            producer.send(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="rocketmq-事务消息">RocketMQ 事务消息<a href="#rocketmq-事务消息" class="hash-link" aria-label="Direct link to RocketMQ 事务消息" title="Direct link to RocketMQ 事务消息">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="事务消息">事务消息<a href="#事务消息" class="hash-link" aria-label="Direct link to 事务消息" title="Direct link to 事务消息">​</a></h3><p>RocketMQ事务消息（Transactional Message）是指应用本地事务和发送消息操作可以被定义到全局事务中，要么同时成功，要么同时失败。RocketMQ的事务消息提供类似 X/Open XA 的分布事务功能，通过事务消息能达到分布式事务的最终一致。</p><p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p><ul><li>TransactionStatus.CommitTransaction: 提交事务，它允许消费者消费此消息。</li><li>TransactionStatus.RollbackTransaction: 回滚事务，它代表该消息将被删除，不允许被消费。</li><li>TransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="发送事务消息">发送事务消息<a href="#发送事务消息" class="hash-link" aria-label="Direct link to 发送事务消息" title="Direct link to 发送事务消息">​</a></h4><p>使用 <code>TransactionMQProducer</code>类创建生产者，并指定唯一的 <code>ProducerGroup</code>，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需要根据执行结果对消息队列进行回复。回传的事务状态在请参考前一节。</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.transaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.exception.MQClientException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.SendResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.TransactionListener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.TransactionMQProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.remoting.common.RemotingHelper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.UnsupportedEncodingException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: spring-cloud-alibaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 发送事务消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2020-12-31 22:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Producer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws MQClientException, InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionListener transactionListener = new TransactionListenerImpl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionMQProducer producer = new TransactionMQProducer(&quot;please_rename_unique_group_name&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorService executorService = new ThreadPoolExecutor(2, 5, 100,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TimeUnit.SECONDS, new ArrayBlockingQueue&lt;Runnable&gt;(2000), new ThreadFactory() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Thread newThread(Runnable r) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread thread = new Thread(r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                thread.setName(&quot;client-transaction-msg-check-thread&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return thread;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setExecutorService(executorService);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.setTransactionListener(transactionListener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] tags = new String[] {&quot;TagA&quot;, &quot;TagB&quot;, &quot;TagC&quot;, &quot;TagD&quot;, &quot;TagE&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Message msg =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        new Message(&quot;TopicTest1234&quot;, tags[i % tags.length], &quot;KEY&quot; + i,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SendResult sendResult = producer.sendMessageInTransaction(msg, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;%s%n&quot;, sendResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread.sleep(10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (MQClientException | UnsupportedEncodingException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 100000; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.sleep(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.shutdown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>实现事务的监听接口</strong></p><p>当发送半消息成功时，我们使用 <code>executeLocalTransaction</code> 方法来执行本地事务。它返回前一节中提到的三个事务状态之一。<code>checkLocalTransaction</code> 方法用于检查本地事务状态，并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。</p><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.transaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.LocalTransactionState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.client.producer.TransactionListener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.rocketmq.common.message.MessageExt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.ConcurrentHashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.atomic.AtomicInteger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionListenerImpl implements TransactionListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private AtomicInteger transactionIndex = new AtomicInteger(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private ConcurrentHashMap&lt;String, Integer&gt; localTrans = new ConcurrentHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      int value = transactionIndex.getAndIncrement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      int status = value % 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localTrans.put(msg.getTransactionId(), status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return LocalTransactionState.UNKNOW;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public LocalTransactionState checkLocalTransaction(MessageExt msg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Integer status = localTrans.get(msg.getTransactionId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (null != status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          switch (status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              case 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  return LocalTransactionState.UNKNOW;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              case 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  return LocalTransactionState.COMMIT_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              case 2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  return LocalTransactionState.ROLLBACK_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return LocalTransactionState.COMMIT_MESSAGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>事务消息使用上的限制</strong></p><ol><li>事务消息不支持延时消息和批量消息。</li><li>为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的 <code>transactionCheckMax</code>参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = <code>transactionCheckMax</code> ） 则 Broker 将丢弃此消息，并在默认情况下同时打印错误日志。用户可以通过重写 <code>AbstractTransactionalMessageCheckListener</code> 类来修改这个行为。</li><li>事务消息将在 Broker 配置文件中的参数 transactionTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 <code>transactionTimeout</code> 参数。</li><li>事务性消息可能不止一次被检查或消费。</li><li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li><li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器能通过它们的生产者 ID 查询到消费者。</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/pannanxu/wiki/docs/后端/中间件/RocketMQ.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_rssB" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ZTIL"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/后端/kubernetes/安装"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">安装</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/后端/微信开发/微信公众号"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">微信公众号</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a4zv thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rocketmq-快速入门" class="table-of-contents__link toc-highlight">RocketMQ 快速入门</a><ul><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a></li><li><a href="#技术架构" class="table-of-contents__link toc-highlight">技术架构</a></li><li><a href="#安装rocketmq" class="table-of-contents__link toc-highlight">安装RocketMQ</a></li><li><a href="#项目搭建" class="table-of-contents__link toc-highlight">项目搭建</a></li><li><a href="#基本样例" class="table-of-contents__link toc-highlight">基本样例</a></li></ul></li><li><a href="#rocketmq-批量消息" class="table-of-contents__link toc-highlight">RocketMQ 批量消息</a><ul><li><a href="#批量消息" class="table-of-contents__link toc-highlight">批量消息</a></li><li><a href="#发送批量消息" class="table-of-contents__link toc-highlight">发送批量消息</a></li><li><a href="#消息列表分割" class="table-of-contents__link toc-highlight">消息列表分割</a></li><li><a href="#发送分割后批量消息" class="table-of-contents__link toc-highlight">发送分割后批量消息</a></li><li><a href="#批量消息消费" class="table-of-contents__link toc-highlight">批量消息消费</a></li></ul></li><li><a href="#rocketmq-顺序消息" class="table-of-contents__link toc-highlight">RocketMQ 顺序消息</a><ul><li><a href="#顺序消息" class="table-of-contents__link toc-highlight">顺序消息</a></li><li><a href="#顺序消息生产" class="table-of-contents__link toc-highlight">顺序消息生产</a></li><li><a href="#顺序消费消息" class="table-of-contents__link toc-highlight">顺序消费消息</a></li></ul></li><li><a href="#rocketmq-定时消息" class="table-of-contents__link toc-highlight">RocketMQ 定时消息</a><ul><li><a href="#定时消息" class="table-of-contents__link toc-highlight">定时消息</a></li><li><a href="#启动消费者等待传入订阅消息" class="table-of-contents__link toc-highlight">启动消费者等待传入订阅消息</a></li><li><a href="#发送延时消息" class="table-of-contents__link toc-highlight">发送延时消息</a></li></ul></li><li><a href="#rocketmq-事务消息" class="table-of-contents__link toc-highlight">RocketMQ 事务消息</a><ul><li><a href="#事务消息" class="table-of-contents__link toc-highlight">事务消息</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/pannanxu/wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d9ffcfde.js"></script>
<script src="/assets/js/main.394399f2.js"></script>
</body>
</html>