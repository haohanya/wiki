<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-后端/Netty">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Netty | My Doc</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/后端/Netty"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Netty | My Doc"><meta data-rh="true" name="description" content="Netty 核心组件"><meta data-rh="true" property="og:description" content="Netty 核心组件"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/后端/Netty"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/后端/Netty" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/后端/Netty" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Doc RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Doc Atom Feed"><link rel="stylesheet" href="/assets/css/styles.781e9e86.css">
<link rel="preload" href="/assets/js/runtime~main.3d176ce4.js" as="script">
<link rel="preload" href="/assets/js/main.8cd43c8d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_dYNx" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Doc" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.svg" alt="My Doc" class="themedImage_rLhL themedImage--dark_quyK"></div><b class="navbar__title text--truncate">My Doc</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">doc</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pannanxu/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_uxSF colorModeToggle_S3Zp"><button class="clean-btn toggleButton_VmvJ toggleButtonDisabled_FOd7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_LA5r"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_LEBj"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ldyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MxCR docsWrapper_h_X8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Kzpt" type="button"></button><div class="docPage_GWs5"><aside class="theme-doc-sidebar-container docSidebarContainer_ldoy"><div class="sidebarViewport_TwFD"><div class="sidebar_H_01"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_J18w"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/后端">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Caddy">Caddy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Docker">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Flowable">Flawable</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Git">Git</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/JDK/Bio">JDK</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Linux">Linux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/MacOsM1">MacOS 环境配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/后端/Netty">Netty</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Nginx">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Shell">Shell</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/Spring/源码">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/后端/SpringCloud/">SpringCloud</a><button aria-label="Toggle the collapsible sidebar category &#x27;SpringCloud&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/Vim">Vim</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/kubernetes/安装">kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/中间件/RocketMQ">中间件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/微信开发/微信公众号">微信开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/后端/数据库/HBase">数据库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/后端/设计模式/">创建型模式</a><button aria-label="Toggle the collapsible sidebar category &#x27;创建型模式&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/后端/面试题">面试题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/前端/ViteJs">前端</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/年终&amp;未来/2022">年终&amp;未来</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/模板/技术设计模板">模板</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_baW4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Njrt"><div class="docItemContainer_ZzVP"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HWXL" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_IT7R"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/后端"><span itemprop="name">后端</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Netty</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_GIgr theme-doc-toc-mobile tocMobile_JEhh"><button type="button" class="clean-btn tocCollapsibleButton_Q9up">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Netty</h1><h2 class="anchor anchorWithStickyNavbar_er05" id="netty-核心组件">Netty 核心组件<a href="#netty-核心组件" class="hash-link" aria-label="Direct link to Netty 核心组件" title="Direct link to Netty 核心组件">​</a></h2><ul><li>Channel</li><li>Callback</li><li>Future</li><li>Event &amp; ChannelHandler</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="channel">Channel<a href="#channel" class="hash-link" aria-label="Direct link to Channel" title="Direct link to Channel">​</a></h3><blockquote><p>Channel 是 Java NIO 的一个基础构造</p><p>Channel 是<code>入站</code>或<code>出站</code>数据的载体。因此它可以被打开、关闭或者连接、断开连接</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="callback">Callback<a href="#callback" class="hash-link" aria-label="Direct link to Callback" title="Direct link to Callback">​</a></h3><blockquote><p>Netty 内部使用回调来处理事件；当一个回调被触发时，相关的事件可用被一个 <code>ChannelHandler</code> 接口的实现来处理</p></blockquote><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">public class Callback extends ChannelInboundHandlerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;建立新连接&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="future">Future<a href="#future" class="hash-link" aria-label="Direct link to Future" title="Direct link to Future">​</a></h3><blockquote><p>Future 提供了某种操作完成时通知应用程序的方式</p></blockquote><h4 class="anchor anchorWithStickyNavbar_er05" id="channelfuture">ChannelFuture<a href="#channelfuture" class="hash-link" aria-label="Direct link to ChannelFuture" title="Direct link to ChannelFuture">​</a></h4><blockquote><p>ChannelFuture 用于执行异步操作的时候使用</p><p>它提供了额外的方法，能够帮助我们注册一个或者多个 <code>ChannelFutureListener</code> 实例</p><p>监听器的回调方法<code>operationComplete()</code>将会在对应的操作完成时调用</p><p>然后监听器可以判断该操作是否成功</p><p>如果失败可以检索产生的 <code>Throwable</code></p><p>每一个Netty出战的 I/O 操作都会返回一个ChannelFuture</p></blockquote><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">Bootstrap bootstrap = new Bootstrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 连接远程节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelFuture future = bootstrap.connect(&quot;127.0.0.1&quot;, 8880).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">future.addListener(new ChannelFutureListener() { // 注册一个 ChannelFutureListener，在完成操作时获得通知 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (future.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果操作成功则做一些操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;操作成功&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 失败，打印堆栈信息，或者其他操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Throwable cause = future.cause();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cause.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="event--channelhandler">Event &amp; ChannelHandler<a href="#event--channelhandler" class="hash-link" aria-label="Direct link to Event &amp; ChannelHandler" title="Direct link to Event &amp; ChannelHandler">​</a></h3><blockquote><p>Netty 使用不同的事件来通知我们状态的改变或者是操作的改变，这样可以让我们基于已经发生的事件来触发适当的操作</p><p>每一个事件都可以被分发到 ChannelHandler 类中的某个用户实现的方法</p><p>例如：记录日志、数据转换、流控制、应用程序逻辑</p></blockquote><h4 class="anchor anchorWithStickyNavbar_er05" id="netty-入站相关事件">Netty 入站相关事件<a href="#netty-入站相关事件" class="hash-link" aria-label="Direct link to Netty 入站相关事件" title="Direct link to Netty 入站相关事件">​</a></h4><ul><li>连接已被记过或者连接失活</li><li>数据读取</li><li>用户事件</li><li>错误事件</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="netty-出站相关事件">Netty 出站相关事件<a href="#netty-出站相关事件" class="hash-link" aria-label="Direct link to Netty 出站相关事件" title="Direct link to Netty 出站相关事件">​</a></h4><ul><li>打开或者关闭到远程节点的连接</li><li>将数据写道或者冲刷到套接字</li></ul><h2 class="anchor anchorWithStickyNavbar_er05" id="netty-快速开始">Netty 快速开始<a href="#netty-快速开始" class="hash-link" aria-label="Direct link to Netty 快速开始" title="Direct link to Netty 快速开始">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="引入依赖">引入依赖<a href="#引入依赖" class="hash-link" aria-label="Direct link to 引入依赖" title="Direct link to 引入依赖">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="pomxml">pom.xml<a href="#pomxml" class="hash-link" aria-label="Direct link to pom.xml" title="Direct link to pom.xml">​</a></h4><div class="language-xml codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-xml codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Netty --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.netty</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">netty-all</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">4.1.48.Final</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 以下为日志依赖，可省略 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ch.qos.logback</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">logback-classic</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.2.3</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">compile</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.logging.log4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">log4j-to-slf4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.13.3</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">compile</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.slf4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jul-to-slf4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.7.30</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">compile</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">scope</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="服务端">服务端<a href="#服务端" class="hash-link" aria-label="Direct link to 服务端" title="Direct link to 服务端">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="nettyserver">NettyServer<a href="#nettyserver" class="hash-link" aria-label="Direct link to NettyServer" title="Direct link to NettyServer">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.bootstrap.ServerBootstrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelFuture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelInitializer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelOption;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.EventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.nio.NioEventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.nio.NioServerSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NettyServer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(NettyServer.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * bossGroup：只负责处理连接请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup bossGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup workGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建服务器端的启动对象，配置参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerBootstrap bootstrap = new ServerBootstrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置两个线程组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .group(bossGroup, workGroup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置服务端的通道实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .channel(NioServerSocketChannel.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置线程队列得到连接个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .option(ChannelOption.SO_BACKLOG, 128)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置保持活动连接状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childOption(ChannelOption.SO_KEEPALIVE, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置 workGroup 的 EventLoop 对应的通道设置处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { // 创建一个通道初始化对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 给 pipeline 设置处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        protected void initChannel(SocketChannel ch) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new NettyServerHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;服务端准备完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 绑定端口，设置为同步，并且启动服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ChannelFuture cf = bootstrap.bind(6666).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 监听关闭通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cf.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 优雅的关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bossGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            workGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="nettyserverhandler">NettyServerHandler<a href="#nettyserverhandler" class="hash-link" aria-label="Direct link to NettyServerHandler" title="Direct link to NettyServerHandler">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.buffer.ByteBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.buffer.Unpooled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelFutureListener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandlerContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelInboundHandlerAdapter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.util.CharsetUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ChannelHandler.Sharable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NettyServerHandler extends ChannelInboundHandlerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(NettyServerHandler.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 对于每个传入的消息都会调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx   上下文对象，包含 pipeline(管道)、channel(通道)、地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param msg   客户端传递来的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将接收到的消息写给客户端，而不冲刷出站消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.write(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 通知 ChannelInboundHandler 最后一次对 channelRead() 的调用是当前批量读取中的最后一条消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将暂存于 ChannelOutboundBuffer 中的消息冲刷到远程节点，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 并在下一次调用flush()或者writeAndFlush()方法时将会尝试写出到套接字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.writeAndFlush(Unpooled.EMPTY_BUFFER)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 监听消息冲刷完毕后关闭该 Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .addListener(ChannelFutureListener.CLOSE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 的读取操作期间，有异常抛出时调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param cause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 打印堆栈异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cause.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭 Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="客户端">客户端<a href="#客户端" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="nettyclient">NettyClient<a href="#nettyclient" class="hash-link" aria-label="Direct link to NettyClient" title="Direct link to NettyClient">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.bootstrap.Bootstrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelFuture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelInitializer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.EventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.nio.NioEventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.nio.NioSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NettyClient {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(NettyClient.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 客户端 需要一个循环组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup eventExecutors = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 客户端启动对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 服务端使用 ServerBootstrap 而客户端是使用 Bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Bootstrap bootstrap = new Bootstrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置线程组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .group(eventExecutors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 设置客户端通道的实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .channel(NioSocketChannel.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        protected void initChannel(SocketChannel ch) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new NettyClientHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;客户端准备完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 启动客户端并连接服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ChannelFuture future = bootstrap.connect(&quot;127.0.0.1&quot;, 6666).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 监听关闭通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            future.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventExecutors.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="nettyclienthandler">NettyClientHandler<a href="#nettyclienthandler" class="hash-link" aria-label="Direct link to NettyClientHandler" title="Direct link to NettyClientHandler">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.buffer.ByteBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.buffer.Unpooled;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandlerContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelInboundHandlerAdapter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.util.CharsetUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NettyClientHandler extends ChannelInboundHandlerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(NettyClientHandler.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 当通道就绪时触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;client : {}&quot;, ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello Client&quot;, CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 读取服务端发送的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;服务端回复的消息 : {}&quot;, buf.toString(CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;服务器的地址 : {}&quot;, ctx.channel().remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cause.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="任务调度">任务调度<a href="#任务调度" class="hash-link" aria-label="Direct link to 任务调度" title="Direct link to 任务调度">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="taskqueue-任务队列">TaskQueue 任务队列<a href="#taskqueue-任务队列" class="hash-link" aria-label="Direct link to TaskQueue 任务队列" title="Direct link to TaskQueue 任务队列">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;server context : {}&quot;, ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 定义 taskQueue 实现异步任务。解决 : 业务时间过长导致长时间阻塞</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.channel().eventLoop().execute(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Thread.sleep(10 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello Netty2~&quot;, CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;客户端发送的消息是 : {}&quot;, buf.toString(CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;客户端的地址是 : {}&quot;, ctx.channel().remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="scheduledtaskqueue-定时任务队列">scheduledTaskQueue 定时任务队列<a href="#scheduledtaskqueue-定时任务队列" class="hash-link" aria-label="Direct link to scheduledTaskQueue 定时任务队列" title="Direct link to scheduledTaskQueue 定时任务队列">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;server context : {}&quot;, ctx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 参数一：业务实现、参数二：延迟时间、参数三：时间单位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.channel().eventLoop().schedule(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Thread.sleep(10 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello Netty2~&quot;, CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, 5, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;客户端发送的消息是 : {}&quot;, buf.toString(CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;客户端的地址是 : {}&quot;, ctx.channel().remoteAddress());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="futurelistener-监听器">FutureListener 监听器<a href="#futurelistener-监听器" class="hash-link" aria-label="Direct link to FutureListener 监听器" title="Direct link to FutureListener 监听器">​</a></h2><blockquote><p>Future 对象刚刚创建时，处于非完成状态，调用者可以通过返回的 <code>ChannelFuture</code> 来获取操作执行的状态，注册监听函数来执行完成后的操作</p></blockquote><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 绑定端口，设置为同步，并且启动服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelFuture cf = bootstrap.bind(6666).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 添加监听器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cf.addListener(new ChannelFutureListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cf.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;监听端口 6666 成功&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.error(&quot;监听端口 6666 失败&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="bootstrapserverbootstrap">BootStrap、ServerBootStrap<a href="#bootstrapserverbootstrap" class="hash-link" aria-label="Direct link to BootStrap、ServerBootStrap" title="Direct link to BootStrap、ServerBootStrap">​</a></h2><blockquote><p>BootStrap: 只要用于配置整个 Netty 程序、串联各个组件
Netty 中的 BootStrap 类是客户端程序的启动引导类、ServerBootStrap 是服务端启动引导类</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="常用方法">常用方法<a href="#常用方法" class="hash-link" aria-label="Direct link to 常用方法" title="Direct link to 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 在服务端设置两个EventLoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 在客户端设置一个EventLoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public B group(EventLoopGroup group) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 设置一个服务器端的通道实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public B channel(Class&lt;? extends C&gt; channelClass) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用来给 ServerChannel 添加配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; B option(ChannelOption&lt;T&gt; option, T value) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用来给接收到的通道添加配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; ServerBootstrap childOption(ChannelOption&lt;T&gt; childOption, T value) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 设置服务端的端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ChannelFuture bind(int inetPort) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 提供给客户端连接服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ChannelFuture connect(String inetHost, int inetPort) {}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="futurechannelfuture">Future、ChannelFuture<a href="#futurechannelfuture" class="hash-link" aria-label="Direct link to Future、ChannelFuture" title="Direct link to Future、ChannelFuture">​</a></h2><blockquote><p>Netty 中所有的 IO 操作都是异步的、不能立刻得知消息被正确处理</p><p>但是可以等待执行完成或者注册监听器，具体通过 Future、ChanelFutures 来注册监听器</p><p>当操作成功或者失败的时候会去执行注册的监听器</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="常用方法-1">常用方法<a href="#常用方法-1" class="hash-link" aria-label="Direct link to 常用方法" title="Direct link to 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 返回当前正在执行IO的操作的通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Channel channel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 等待异步执行完毕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelFuture sync() throws InterruptedException;</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="channel-1">Channel<a href="#channel-1" class="hash-link" aria-label="Direct link to Channel" title="Direct link to Channel">​</a></h2><ol><li>Netty 网络通信的组件，能够用于执行网络 I/O 操作</li><li>通过 Channel 可获得当前网络连接通道的状态、配置参数（例如接收缓冲区大小）</li><li>Channel 提供异步的网络 I/O 操作（如建立连接、读写、绑定端口）</li><li>调用立即返回一个 ChannelFuture 实例，通过注册监听器到 ChannelFuture 上，可以在 I/O 操作成功、失败或取消时回调通知调用方</li><li>支持关联 I/O 操作与对应的处理程序</li><li>不同协议、不同的阻塞类型的连接都有不同的 Channel 类型与之对应</li></ol><h3 class="anchor anchorWithStickyNavbar_er05" id="常用的-channel-类型">常用的 Channel 类型<a href="#常用的-channel-类型" class="hash-link" aria-label="Direct link to 常用的 Channel 类型" title="Direct link to 常用的 Channel 类型">​</a></h3><ul><li><code>NioSOcketChannel</code> : 异步的<code>客户端</code> <code>TCP Socket</code> 连接</li><li><code>NioServerSocketChannel</code> : 异步的<code>服务器端</code> <code>TOC Socket</code> 连接</li><li><code>NioDatagramChannel</code> : 异步的 <code>UDP</code> 连接</li><li><code>NioSctpChannel</code> : 异步的 <code>客户端</code> <code>Sctp</code> 连接</li><li><code>NioSctpServerChannel</code> : 异步的 <code>Sctp</code> <code>服务器端</code> 连接</li></ul><h2 class="anchor anchorWithStickyNavbar_er05" id="selector">Selector<a href="#selector" class="hash-link" aria-label="Direct link to Selector" title="Direct link to Selector">​</a></h2><blockquote><p>Netty 基于 Selector 对象实现 I/O 多路复用，通过 Selector 一个线程可以监听多个连接的 Channel 事件</p><p>当向一个 Selector 中注册 Channel 后 Selector 内部的机制就可以自动不断的查询这些注册的 Channel 是否以有就绪的I/O事件</p><p>例如可读、可写、网络连接完成等</p><p>这样程序就可以很简单的使用一个下称高效的管理多个 Channel</p></blockquote><h2 class="anchor anchorWithStickyNavbar_er05" id="channelhandler">ChannelHandler<a href="#channelhandler" class="hash-link" aria-label="Direct link to ChannelHandler" title="Direct link to ChannelHandler">​</a></h2><blockquote><p>ChannelHandler 是一个借口，用来处理 I/O 事件或拦截 I/O 操作</p><p>并将其转发到其他 ChannelPipeline(业务处理链)中的下一个处理程序</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="channelhandler-实现类">ChannelHandler 实现类<a href="#channelhandler-实现类" class="hash-link" aria-label="Direct link to ChannelHandler 实现类" title="Direct link to ChannelHandler 实现类">​</a></h3><ul><li><code>ChannelInboundHandler</code> : 用于处理入站 I/O 事件</li><li><code>ChannelOutboundHandler</code> : 用于处理出栈 I/O 操作</li><li><code>ChannelInboundHandlerAdapter</code> : 用于处理入站 I/O 事件</li><li><code>ChannelOutboundHandlerAdapter</code> : 用于处理出栈 I/O 操作</li><li><code>ChannelDuplexHandler</code> : 用于处理入站和出战事件</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="channelinboundhandleradapter-常用方法">ChannelInboundHandlerAdapter 常用方法<a href="#channelinboundhandleradapter-常用方法" class="hash-link" aria-label="Direct link to ChannelInboundHandlerAdapter 常用方法" title="Direct link to ChannelInboundHandlerAdapter 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 通道被注册事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void channelRegistered(ChannelHandlerContext ctx) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 通道被注销事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void channelUnregistered(ChannelHandlerContext ctx) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 通道处理就绪事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void channelActive(ChannelHandlerContext ctx) throws Exception{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 通道读取数据事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 数据读取完毕事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 通道发生异常事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 当前 Handler 被 pipeline 注册时触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void handlerAdded(ChannelHandlerContext ctx) throws Exception {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 当前 Handler 被 pipeline 移除时触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void handlerRemoved(ChannelHandlerContext ctx) throws Exception {}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="channelhandlersharable">@ChannelHandler.Sharable<a href="#channelhandlersharable" class="hash-link" aria-label="Direct link to @ChannelHandler.Sharable" title="Direct link to @ChannelHandler.Sharable">​</a></h3><blockquote><p>表示一个 ChannelHandler 可以被多个 Channel 安全的共享</p><p>Netty 会在每个 Channel 中都添加处理器，如果每个通道都创建一次对象，对内存的消耗无疑是非常大的</p><p>所以一般在线程安全的处理器中，都会标注此注解，表示可以只创建一次对象</p><p>一般在没有共享变量的处理器都可以加入此注解</p></blockquote><h2 class="anchor anchorWithStickyNavbar_er05" id="pipeline--channelpipeline">Pipeline &amp; ChannelPipeline<a href="#pipeline--channelpipeline" class="hash-link" aria-label="Direct link to Pipeline &amp; ChannelPipeline" title="Direct link to Pipeline &amp; ChannelPipeline">​</a></h2><blockquote><p>ChannelPipeline 是一个 Handler 的集合，负责处理和拦截 inbound 或者 outbound 的事件和操作</p><p>相当于一个贯穿Netty的链</p><p>简单说：ChannelPipeline 是一个用来保存 ChannelHandler 的集合，用来处理或拦截 Channel 的入站事件和出战操作</p><p>ChannelPipeline 实现了一种高级形式的拦截过滤器模式，让用户可以完全控制事件的处理方式，以及 Channel 中各个的 ChannelHandler 的相互交互</p><p>在 Netty 中，每个 Channel 都仅有一个 ChannelPipeline，</p></blockquote><blockquote><p>一个 Channel 包含了一个 ChannelPipeline， 而 ChannelPipeline 中又维护了一个由 ChannelHandlerContext 组成的双向链表</p><p>并且每个 ChannelHandlerContext 中又关联着一个 ChannelHandler</p><p>入站事件和出战事件在一个双向链表中，入站事件会从链表 head 往后传递到最后一个入站的 handler</p><p>出战事件会从链表 tail 往前传递到最前一个出站的 handler， 两种类型的 handler 互不干扰</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="常用方法-2">常用方法<a href="#常用方法-2" class="hash-link" aria-label="Direct link to 常用方法" title="Direct link to 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 把 handler 添加到链表的最后一个位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelPipeline addLast(ChannelHandler... handlers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 把 handler 添加到链表的第一个位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelPipeline addFirst(ChannelHandler... handlers);</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="channelhandlercontext">ChannelHandlerContext<a href="#channelhandlercontext" class="hash-link" aria-label="Direct link to ChannelHandlerContext" title="Direct link to ChannelHandlerContext">​</a></h2><blockquote><p>保存 Channel 相关的所有上下文信息，同时关联一个 ChannelHandler 对象</p><p>ChannelHandlerContext 中包含一个具体的事件处理器 ChannelHandler</p><p>同时 ChannelHandlerContext 中也绑定了对应的pipeline 和 Channel 的信息，方便对 ChannelHandler 进行调用</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="常用方法-3">常用方法<a href="#常用方法-3" class="hash-link" aria-label="Direct link to 常用方法" title="Direct link to 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 关闭通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelFuture close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 刷新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelHandlerContext flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 将数据写到 ChannelPipeline 中，当前 CHannelHandler 的下一个 ChannelHandler 开始处理（出站）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ChannelFuture writeAndFlush(Object msg);</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="channeloption">ChannelOption<a href="#channeloption" class="hash-link" aria-label="Direct link to ChannelOption" title="Direct link to ChannelOption">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="channeloptionso_backlog">ChannelOption.SO_BACKLOG<a href="#channeloptionso_backlog" class="hash-link" aria-label="Direct link to ChannelOption.SO_BACKLOG" title="Direct link to ChannelOption.SO_BACKLOG">​</a></h3><blockquote><p>对应 TCP/IP 协议 Listen 函数中的 backlog 参数，用来初始化服务器可连接队列大小</p><p>服务端处理客户端链接请求是顺序处理的，所以同一时间只能处理一个客户端连接，多个客户端请求时，服务端不能处理的客户端连接请求放在队列中等待处理</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="channeloptionso_keepalive">ChannelOption.SO_KEEPALIVE<a href="#channeloptionso_keepalive" class="hash-link" aria-label="Direct link to ChannelOption.SO_KEEPALIVE" title="Direct link to ChannelOption.SO_KEEPALIVE">​</a></h3><blockquote><p>是否保持连接活动状态</p></blockquote><h2 class="anchor anchorWithStickyNavbar_er05" id="eventloopgroup--nioeventloopgroup">EventLoopGroup &amp; NioEventLoopGroup<a href="#eventloopgroup--nioeventloopgroup" class="hash-link" aria-label="Direct link to EventLoopGroup &amp; NioEventLoopGroup" title="Direct link to EventLoopGroup &amp; NioEventLoopGroup">​</a></h2><blockquote><p>EventLoopGroup 是一组 EventLoop 的抽象，Netty 为了跟他好的利用多核 CPU 资源，一半会有多个 EventLoop 同时工作，每个 EventLoop 维护着一个 Selector 实例</p><p>EventLoopGroup 提供 next 接口，可以重里面按照一定规则获取其中一个 EventLoop 来处理任务</p><p>在 Netty 服务器端编程中，我们一半都需要提供两个 EventLoopGroup，例如：BossEventLoopGroup 和 WorkerEventLoopGroup</p><p>通常一个服务端口即一个 ServerSocketChannel 对应一个 Selector 和一个 EventLoop 线程。</p><p>BossEventLoop 负责接收客户端的连接并将 SocketChannel 交给 WorkerEventLoopGroup 来进行 IO 处理</p><blockquote><p>BossEventLoopGroup 通常是一个单线程的 EventLoop，EventLoop维护者一个注册了 ServerSocketChannel 的 Selector 实例，BossEventLoop 不断轮询 Selector 将连接事件分离出来</p><p>通常是 OP_ACCEPT 事件，然后将接收到的 SocketChannel 交给 WorkerEventLoopGroup</p><p>WorkerEventLoopGroup 会由 next 选择其中一个 EventLoopGroup 来将这个 SocketChannel 注册到其维护 Selector 并对其后续的 IO 事件进行处理</p></blockquote></blockquote><h2 class="anchor anchorWithStickyNavbar_er05" id="unpooled">Unpooled<a href="#unpooled" class="hash-link" aria-label="Direct link to Unpooled" title="Direct link to Unpooled">​</a></h2><blockquote><p>Unpooled 类是 Netty 用来操作 缓冲区的工具类</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="常用方法-4">常用方法<a href="#常用方法-4" class="hash-link" aria-label="Direct link to 常用方法" title="Direct link to 常用方法">​</a></h3><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">public static ByteBuf copiedBuffer(CharSequence string, Charset charset)</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="心跳机制">心跳机制<a href="#心跳机制" class="hash-link" aria-label="Direct link to 心跳机制" title="Direct link to 心跳机制">​</a></h2><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.netty.heart;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.bootstrap.ServerBootstrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.nio.NioEventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.nio.NioServerSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.logging.LogLevel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.logging.LoggingHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.timeout.IdleStateHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: Netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 心跳机制-服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2021-04-29 00:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HeartServer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(HeartServer.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup bossGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup workGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerBootstrap bootstrap = new ServerBootstrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .group(bossGroup, workGroup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .channel(NioServerSocketChannel.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .option(ChannelOption.SO_BACKLOG, 128)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childOption(ChannelOption.SO_KEEPALIVE, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // handler 对应的是 bossGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // childHandler 对应的是 workGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 日志处理器，提供给BossGroup打印日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .handler(new LoggingHandler(LogLevel.INFO))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        protected void initChannel(SocketChannel ch) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 加入空闲状态处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 参数一：多少时间没有读取消息，就会发送一个心跳，检测是否是连接状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 参数二：          写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 参数三：          读写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 参数四：时间单位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 当 IdleStateHandler 触发后，会传递给通道的下一个 handler 处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 通过调用下一个 handler 的 userEventTriggered 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new IdleStateHandler(3, 5, 7, TimeUnit.SECONDS));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 加入一个对空闲检测处理的handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new HeartHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;服务端准备完成&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ChannelFuture cf = bootstrap.bind(6668).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cf.addListener(new ChannelFutureListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void operationComplete(ChannelFuture future) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (cf.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        logger.info(&quot;监听端口 6666 成功&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        logger.error(&quot;监听端口 6666 失败&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cf.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bossGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            workGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.netty.heart;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandlerContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelInboundHandlerAdapter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.timeout.IdleStateEvent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: Netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 空闲状态处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2021-04-29 00:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HeartHandler extends ChannelInboundHandlerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param evt   事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (evt instanceof IdleStateEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IdleStateEvent ise = (IdleStateEvent) evt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (ise.state()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case READER_IDLE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;读空闲&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case WRITER_IDLE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;写空闲&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case ALL_IDLE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;读写空闲&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="websocket">WebSocket<a href="#websocket" class="hash-link" aria-label="Direct link to WebSocket" title="Direct link to WebSocket">​</a></h2><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.netty.ws;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.bootstrap.ServerBootstrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.nio.NioEventLoopGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.SocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.socket.nio.NioServerSocketChannel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.codec.http.HttpObjectAggregator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.codec.http.HttpServerCodec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.stream.ChunkedWriteHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: Netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: WebSocketServer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2021-04-29 09:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebSocketServer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(WebSocketServer.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup bossGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EventLoopGroup workGroup = new NioEventLoopGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerBootstrap bootstrap = new ServerBootstrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .group(bossGroup, workGroup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .channel(NioServerSocketChannel.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .option(ChannelOption.SO_BACKLOG, 128)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childOption(ChannelOption.SO_KEEPALIVE, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { // 创建一个通道初始化对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        protected void initChannel(SocketChannel ch) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // Http协议编解码器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new HttpServerCodec());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 以块方式写,对大数据流的支持，例如文件传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new ChunkedWriteHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 将多个数据段聚合起来，如果发送大文本数据避免请求多次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new HttpObjectAggregator(8192));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 处理WebSocket握手以及处理控制帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new WebSocketServerProtocolHandler(&quot;/ws&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 自定义Handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ch.pipeline().addLast(new WebSocketMessageHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ChannelFuture cf = bootstrap.bind(5566).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cf.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bossGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            workGroup.shutdownGracefully();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">package io.mvvm.netty.ws;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandlerContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.SimpleChannelInboundHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @program: Netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @description: 消息处理器, &lt;TextWebSocketFrame&gt; 表示一个文本帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author: 潘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @create: 2021-04-29 09:41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ChannelHandler.Sharable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebSocketMessageHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;客户端已连接&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 收到客户端发送的消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(msg.text());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 向客户端回复消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.channel().writeAndFlush(new TextWebSocketFrame(&quot;Hello WebSocket : &quot; + msg.text()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 动态删除当前处理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.pipeline().remove(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelInactive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;客户端断开连接&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;处理器已添加&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerRemoved(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;处理器被移除&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;发生异常&quot; + cause.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="encoder--decoder">Encoder &amp; Decoder<a href="#encoder--decoder" class="hash-link" aria-label="Direct link to Encoder &amp; Decoder" title="Direct link to Encoder &amp; Decoder">​</a></h2><blockquote><p>网络应用程序在数据传输时采用二进制字节码数据，所以在发送数据时需要编码，接收数据时需要解码</p><p>codec (编解码器)分别表示：Decoder(解码器)、Encoder(编码器)</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="netty-的编解码器">Netty 的编解码器<a href="#netty-的编解码器" class="hash-link" aria-label="Direct link to Netty 的编解码器" title="Direct link to Netty 的编解码器">​</a></h3><ul><li>StringEncoder &amp; StringDecoder &gt; String 类型数据的编解码器</li><li>ObjectEncoder &amp; ObjectDecoder &gt; Java 对象的编解码器</li></ul><blockquote><p>Netty 提供的 Object 编解码器采用的是Java的序列化方式，因此就存在效率低、无法跨语言、体积大等问题</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="google-protobuf">Google Protobuf<a href="#google-protobuf" class="hash-link" aria-label="Direct link to Google Protobuf" title="Direct link to Google Protobuf">​</a></h3><blockquote><p>Protobuf 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化(序列化)</p></blockquote><h2 class="anchor anchorWithStickyNavbar_er05" id="粘包--半包">粘包 &amp; 半包<a href="#粘包--半包" class="hash-link" aria-label="Direct link to 粘包 &amp; 半包" title="Direct link to 粘包 &amp; 半包">​</a></h2><blockquote><p>TCP 是面向流的，提供高可靠性服务。收发两端都要有成对的 Socket</p><p>因此发送端为了将多个发给接收端的包，更有效的发送给对方，使用了 Nagle 算法优化</p><p>将多次间隔较小且数量小的数据，合并为一个大的数据块，然后进行封包，</p><p>这样虽然提高了效率，但是接收端就难以分辨出完整的数据包了，因为面向流的通信是无消息保护边界的</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="粘包">粘包<a href="#粘包" class="hash-link" aria-label="Direct link to 粘包" title="Direct link to 粘包">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="现象">现象<a href="#现象" class="hash-link" aria-label="Direct link to 现象" title="Direct link to 现象">​</a></h4><p>发送 <code>abc</code> <code>def</code>，接收为 <code>abcdef</code></p><h4 class="anchor anchorWithStickyNavbar_er05" id="原因">原因<a href="#原因" class="hash-link" aria-label="Direct link to 原因" title="Direct link to 原因">​</a></h4><ul><li>应用层：接收方 ByteBuf 设置太大（Netty默认1024）</li><li>滑动窗口：假设发送方256bytes表示一个完整的报文，但由于接收方处理不及时且窗口大小足够大，这256bytes字节就会缓冲在接收方的滑动窗口中，当滑动窗口中缓冲了多个报文就会出现粘包</li><li>Nagle 算法</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="半包">半包<a href="#半包" class="hash-link" aria-label="Direct link to 半包" title="Direct link to 半包">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="现象-1">现象<a href="#现象-1" class="hash-link" aria-label="Direct link to 现象" title="Direct link to 现象">​</a></h4><p>发送 <code>abcdef</code> 接收 <code>abc</code> <code>de</code> <code>f</code></p><h4 class="anchor anchorWithStickyNavbar_er05" id="原因-1">原因<a href="#原因-1" class="hash-link" aria-label="Direct link to 原因" title="Direct link to 原因">​</a></h4><ul><li>应用层：接收方 ByteBuf 小于实际发送数据的数量</li><li>滑动窗口：加涉接收方的窗口只剩128bytes，发送方的报文大小是256bytes，这时放不下了，只能先发送前128bytes，等待ack后才能发送剩余部分，这就造成半包</li><li>MSS限制：当发送的数据草果 MSS 限制后，会将数据切分发送，就会照成半包</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="粘包半包演示">粘包半包演示<a href="#粘包半包演示" class="hash-link" aria-label="Direct link to 粘包半包演示" title="Direct link to 粘包半包演示">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="服务端-1">服务端<a href="#服务端-1" class="hash-link" aria-label="Direct link to 服务端" title="Direct link to 服务端">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = (ByteBuf) msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;客户端发送的消息是 : {}&quot;, buf.toString(CharsetUtil.UTF_8));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="客户端-1">客户端<a href="#客户端-1" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ByteBuf buf = Unpooled.copiedBuffer(&quot;Hello Client&quot; + i, CharsetUtil.UTF_8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ctx.writeAndFlush(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="结果打印">结果打印<a href="#结果打印" class="hash-link" aria-label="Direct link to 结果打印" title="Direct link to 结果打印">​</a></h4><div class="language-log codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-log codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">[nioEventLoopGroup-3-1] INFO io.mvvm.netty.decoder.NettyServerHandler - 客户端发送的消息是 : Hello Client0Hello Client1Hello Client2Hello Client3Hello Client4Hello Client5Hello Client6Hello Client7Hello Client8Hello Client9</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="结论">结论<a href="#结论" class="hash-link" aria-label="Direct link to 结论" title="Direct link to 结论">​</a></h4><blockquote><p>代码解释</p><p>客户端和服务端建立连接后，循环向服务端发送10条消息</p><p>期望结果</p><p>服务端收到10条消息</p><p>实际结果</p><p>服务端将10条消息放在一起成为了一条消息，这就是粘包现象</p></blockquote><h3 class="anchor anchorWithStickyNavbar_er05" id="解决方案">解决方案<a href="#解决方案" class="hash-link" aria-label="Direct link to 解决方案" title="Direct link to 解决方案">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="短连接">短连接<a href="#短连接" class="hash-link" aria-label="Direct link to 短连接" title="Direct link to 短连接">​</a></h4><blockquote><p>建立连接后只发送一次消息，发送消息完毕后断开连接</p><p>缺点：不如用http</p></blockquote><h4 class="anchor anchorWithStickyNavbar_er05" id="定长解码器-fixedlengthframedecoder">定长解码器 FixedLengthFrameDecoder<a href="#定长解码器-fixedlengthframedecoder" class="hash-link" aria-label="Direct link to 定长解码器 FixedLengthFrameDecoder" title="Direct link to 定长解码器 FixedLengthFrameDecoder">​</a></h4><blockquote><p>定常解码器即固定每条消息的固定长度，如果消息长度小于定长的长度，则进行补位到定长长度</p><p>优点：解决了短连接的问题</p><p>缺点，增加消息体积，逐一匹配字符效率低</p></blockquote><h5 class="anchor anchorWithStickyNavbar_er05" id="服务端-2">服务端<a href="#服务端-2" class="hash-link" aria-label="Direct link to 服务端" title="Direct link to 服务端">​</a></h5><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 定长解码器,参数为：帧的长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ch.pipeline().addLast(new FixedLengthFrameDecoder(10));</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="客户端-2">客户端<a href="#客户端-2" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h5><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buffer = ctx.alloc().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        char c = &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random r = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] bytes = getBytes(c, r.nextInt(9) + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buffer.writeBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.writeAndFlush(buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static byte[] getBytes(char c, int i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder sb = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i1 = 0; i1 &lt; i; i1++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int length = sb.length();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i1 = 0; i1 &lt; 10 - length; i1++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(&quot;-&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(sb.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sb.toString().getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="行解码器-linebasedframedecoder">行解码器 LineBasedFrameDecoder<a href="#行解码器-linebasedframedecoder" class="hash-link" aria-label="Direct link to 行解码器 LineBasedFrameDecoder" title="Direct link to 行解码器 LineBasedFrameDecoder">​</a></h4><blockquote><p>public LineBasedFrameDecoder(final int maxLength)</p><p>参数maxLength表示设置一个最大消息长度，如果消息超过这个长度还未找到分隔符，则会抛出<code>TooLongFrameException</code>异常</p><p>public DelimiterBasedFrameDecoder(int maxFrameLength, ByteBuf... delimiters)</p><p>和上面那个的区别就是，LineBasedFrameDecoder采用 <code>\\r\\n</code> 实现分割</p><p>DelimiterBasedFrameDecoder采用自定义分隔符</p><p>每条消息采用特定的分隔符进行分割，例如 <code>\\n</code></p><p>优点: 解决了定长解码器的补位问题</p><p>缺点：逐一匹配字符，效率低</p></blockquote><h5 class="anchor anchorWithStickyNavbar_er05" id="服务端-3">服务端<a href="#服务端-3" class="hash-link" aria-label="Direct link to 服务端" title="Direct link to 服务端">​</a></h5><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">// 行解码器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ch.pipeline().addLast(new LineBasedFrameDecoder(1024));</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="客户端-3">客户端<a href="#客户端-3" class="hash-link" aria-label="Direct link to 客户端" title="Direct link to 客户端">​</a></h5><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void channelActive(ChannelHandlerContext ctx) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buffer = ctx.alloc().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        char c = &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Random r = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] bytes = getBytes(c, r.nextInt(256) + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buffer.writeBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.writeAndFlush(buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static byte[] getBytes(char c, int i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder sb = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i1 = 0; i1 &lt; i; i1++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.append(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(sb.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sb.toString().getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="let-解码器-lengthfieldbasedframedecoder">LET 解码器 LengthFieldBasedFrameDecoder<a href="#let-解码器-lengthfieldbasedframedecoder" class="hash-link" aria-label="Direct link to LET 解码器 LengthFieldBasedFrameDecoder" title="Direct link to LET 解码器 LengthFieldBasedFrameDecoder">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 基于长度字段帧的解码器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * maxFrameLength: 帧的最大长度，如果超出此长度会抛出TooLongFrameException异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lengthFieldOffset: 长度字段偏移量，(即偏移多少可以读到长度)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lengthFieldLength: 长度字段长度，(长度有多少个字节)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lengthAdjustment: 长度字段为基准，还有多少字节内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * initialBytesToStrip: 从头去除几个字节，(例如，长度是4个字节，去除长度，则值为4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public LengthFieldBasedFrameDecoder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int maxFrameLength,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int lengthFieldOffset, int lengthFieldLength,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int lengthAdjustment, int initialBytesToStrip){}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="测试">测试<a href="#测试" class="hash-link" aria-label="Direct link to 测试" title="Direct link to 测试">​</a></h5><blockquote><p>EmbeddedChannel用来测试处理器</p></blockquote><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedChannel channel = new EmbeddedChannel(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new LoggingHandler(LogLevel.INFO)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        send(buf, &quot;Hello&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        send(buf, &quot;Hi&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        send(buf, &quot;Test&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.writeInbound(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void send(ByteBuf buf, String msg) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] bytes = msg.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int length = bytes.length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buf.writeInt(length); // 写入消息长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buf.writeBytes(bytes); // 写入消息内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="协议设计与解析">协议设计与解析<a href="#协议设计与解析" class="hash-link" aria-label="Direct link to 协议设计与解析" title="Direct link to 协议设计与解析">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="自定义协议要素">自定义协议要素<a href="#自定义协议要素" class="hash-link" aria-label="Direct link to 自定义协议要素" title="Direct link to 自定义协议要素">​</a></h3><ul><li>魔术：用来在第一事件判断是否是无效数据包</li><li>版本号：可以支持协议的升级</li><li>序列化算法：消息正文采用哪种序列化方式，例如：json、protobuf、hessian、jdk</li><li>指令类型：是登陆、注册、单聊、群聊...和业务相关</li><li>请求序号：为了双工通信，提供异步能力</li><li>正文长度</li><li>消息正文</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="自定义协议编解码实现">自定义协议编解码实现<a href="#自定义协议编解码实现" class="hash-link" aria-label="Direct link to 自定义协议编解码实现" title="Direct link to 自定义协议编解码实现">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="messagecodec">MessageCodec<a href="#messagecodec" class="hash-link" aria-label="Direct link to MessageCodec" title="Direct link to MessageCodec">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import io.mvvm.netty.codec.entity.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.buffer.ByteBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.channel.ChannelHandlerContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.netty.handler.codec.ByteToMessageCodec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.ByteArrayInputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.ByteArrayOutputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.ObjectInputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.ObjectOutputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MessageCodec extends ByteToMessageCodec&lt;Message&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 魔数，4字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeBytes(new byte[]{1, 2, 3, 4});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 版本，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeByte(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 序列化算法(0:jdk, 1:json)，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeByte(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 指令类型，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeByte(msg.getMessageType());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. 请求序号，4个字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeByte(msg.getSequenceId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 无意义，对齐填充，保持2的倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeByte(0xff);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. 获取内容的字节数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjectOutputStream oos = new ObjectOutputStream(bos);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        oos.writeObject(msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] bytes = bos.toByteArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. 长度，4字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeInt(bytes.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 8. 写入内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.writeBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 魔术，4字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int magicNum = in.readInt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 版本，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte version = in.readByte();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 序列化算法(0:jdk, 1:json)，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte serializerAlgorithm = in.readByte();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 指令类型，1字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte messageType = in.readByte();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. 请求序号，4个字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int sequenceId = in.readInt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 无意义，对齐填充，保持2的倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        in.readByte();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. 长度，4字节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int length = in.readInt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7. 读取内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] bytes = new byte[length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 缓冲区，开始，结束</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        in.readBytes(bytes, 0, length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjectInputStream stream = new ObjectInputStream(new ByteArrayInputStream(bytes));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message message = (Message) stream.readObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out.add(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="message">Message<a href="#message" class="hash-link" aria-label="Direct link to Message" title="Direct link to Message">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.Serializable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class Message implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int messageType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int sequenceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract int getMessageType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final int LoginRequestMessage = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getSequenceId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setSequenceId(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sequenceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setSequenceId(int sequenceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sequenceId = sequenceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="loginrequestmessage">LoginRequestMessage<a href="#loginrequestmessage" class="hash-link" aria-label="Direct link to LoginRequestMessage" title="Direct link to LoginRequestMessage">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">public class LoginRequestMessage extends Message{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String nickname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LoginRequestMessage() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LoginRequestMessage(String username, String password, String nickname) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.nickname = nickname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getMessageType() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return LoginRequestMessage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(String password) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNickname() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nickname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNickname(String nickname) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.nickname = nickname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="main">main<a href="#main" class="hash-link" aria-label="Direct link to main" title="Direct link to main">​</a></h4><div class="language-java codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-java codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EmbeddedChannel channel = new EmbeddedChannel(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 最大长度，偏移量，存储内容长度的长度，补偿几个字节到长度位置，去除多少字节内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new LoggingHandler(LogLevel.INFO),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new MessageCodec()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // encoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message message = new LoginRequestMessage(&quot;root&quot;, &quot;123456&quot;, &quot;zhangsan&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.writeOutbound(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // decoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message message1 = new LoginRequestMessage(&quot;root&quot;, &quot;123456&quot;, &quot;zhangsan&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new MessageCodec().encode(null, message1, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 入站</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.writeInbound(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/pannanxu/wiki/docs/后端/Netty.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_rssB" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ZTIL"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/后端/MacOsM1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MacOS 环境配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/后端/Nginx"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Nginx</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a4zv thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#netty-核心组件" class="table-of-contents__link toc-highlight">Netty 核心组件</a><ul><li><a href="#channel" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#callback" class="table-of-contents__link toc-highlight">Callback</a></li><li><a href="#future" class="table-of-contents__link toc-highlight">Future</a></li><li><a href="#event--channelhandler" class="table-of-contents__link toc-highlight">Event &amp; ChannelHandler</a></li></ul></li><li><a href="#netty-快速开始" class="table-of-contents__link toc-highlight">Netty 快速开始</a><ul><li><a href="#引入依赖" class="table-of-contents__link toc-highlight">引入依赖</a></li><li><a href="#服务端" class="table-of-contents__link toc-highlight">服务端</a></li><li><a href="#客户端" class="table-of-contents__link toc-highlight">客户端</a></li></ul></li><li><a href="#任务调度" class="table-of-contents__link toc-highlight">任务调度</a><ul><li><a href="#taskqueue-任务队列" class="table-of-contents__link toc-highlight">TaskQueue 任务队列</a></li><li><a href="#scheduledtaskqueue-定时任务队列" class="table-of-contents__link toc-highlight">scheduledTaskQueue 定时任务队列</a></li></ul></li><li><a href="#futurelistener-监听器" class="table-of-contents__link toc-highlight">FutureListener 监听器</a></li><li><a href="#bootstrapserverbootstrap" class="table-of-contents__link toc-highlight">BootStrap、ServerBootStrap</a><ul><li><a href="#常用方法" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#futurechannelfuture" class="table-of-contents__link toc-highlight">Future、ChannelFuture</a><ul><li><a href="#常用方法-1" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#channel-1" class="table-of-contents__link toc-highlight">Channel</a><ul><li><a href="#常用的-channel-类型" class="table-of-contents__link toc-highlight">常用的 Channel 类型</a></li></ul></li><li><a href="#selector" class="table-of-contents__link toc-highlight">Selector</a></li><li><a href="#channelhandler" class="table-of-contents__link toc-highlight">ChannelHandler</a><ul><li><a href="#channelhandler-实现类" class="table-of-contents__link toc-highlight">ChannelHandler 实现类</a></li><li><a href="#channelinboundhandleradapter-常用方法" class="table-of-contents__link toc-highlight">ChannelInboundHandlerAdapter 常用方法</a></li><li><a href="#channelhandlersharable" class="table-of-contents__link toc-highlight">@ChannelHandler.Sharable</a></li></ul></li><li><a href="#pipeline--channelpipeline" class="table-of-contents__link toc-highlight">Pipeline &amp; ChannelPipeline</a><ul><li><a href="#常用方法-2" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#channelhandlercontext" class="table-of-contents__link toc-highlight">ChannelHandlerContext</a><ul><li><a href="#常用方法-3" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#channeloption" class="table-of-contents__link toc-highlight">ChannelOption</a><ul><li><a href="#channeloptionso_backlog" class="table-of-contents__link toc-highlight">ChannelOption.SO_BACKLOG</a></li><li><a href="#channeloptionso_keepalive" class="table-of-contents__link toc-highlight">ChannelOption.SO_KEEPALIVE</a></li></ul></li><li><a href="#eventloopgroup--nioeventloopgroup" class="table-of-contents__link toc-highlight">EventLoopGroup &amp; NioEventLoopGroup</a></li><li><a href="#unpooled" class="table-of-contents__link toc-highlight">Unpooled</a><ul><li><a href="#常用方法-4" class="table-of-contents__link toc-highlight">常用方法</a></li></ul></li><li><a href="#心跳机制" class="table-of-contents__link toc-highlight">心跳机制</a></li><li><a href="#websocket" class="table-of-contents__link toc-highlight">WebSocket</a></li><li><a href="#encoder--decoder" class="table-of-contents__link toc-highlight">Encoder &amp; Decoder</a><ul><li><a href="#netty-的编解码器" class="table-of-contents__link toc-highlight">Netty 的编解码器</a></li><li><a href="#google-protobuf" class="table-of-contents__link toc-highlight">Google Protobuf</a></li></ul></li><li><a href="#粘包--半包" class="table-of-contents__link toc-highlight">粘包 &amp; 半包</a><ul><li><a href="#粘包" class="table-of-contents__link toc-highlight">粘包</a></li><li><a href="#半包" class="table-of-contents__link toc-highlight">半包</a></li><li><a href="#粘包半包演示" class="table-of-contents__link toc-highlight">粘包半包演示</a></li><li><a href="#解决方案" class="table-of-contents__link toc-highlight">解决方案</a></li></ul></li><li><a href="#协议设计与解析" class="table-of-contents__link toc-highlight">协议设计与解析</a><ul><li><a href="#自定义协议要素" class="table-of-contents__link toc-highlight">自定义协议要素</a></li><li><a href="#自定义协议编解码实现" class="table-of-contents__link toc-highlight">自定义协议编解码实现</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/pannanxu/wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3d176ce4.js"></script>
<script src="/assets/js/main.8cd43c8d.js"></script>
</body>
</html>